<!--========================================================================================================

    NO-BN-Balises.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml"/>.

	Copyright (c) 2015-2024 Railcomplete AS, Norway, NO916118503
	
=========================================================================================================-->
<xpp:bloc>



<!--========================================================================================================
	sig - 
	Global Lua formulas for signalling objects (for signals: see other DNA file).
	Domain-specific Lua functions, stored in Global Extension Dictionary (not in each object),
	such that several ObjectType declarations may use theses functions.
=========================================================================================================-->



<!--========================================================================================================
	Signalling - ATP (automatic train protection) - General functions (physically determined) NSS and ETCS
=========================================================================================================-->
    <LuaFunction Name="NOBN_sig_getBaliseGroupDirection()" ReturnType="String"
		Description="Returns the source object balise's balise group direction [up/down/unknown].">
        <Signature>String NOBN_sig_getBaliseGroupDirection(ObjRef balise = this)</Signature>
        <Formula>
			function NOBN_sig_getBaliseGroupDirection(balise)
				--TODO: Replace with a function which finds out where the closest cable duct is, and rotates the balise with the cable towards that duct.
				balise = balise or this
				local s = balise.RcType:match("ETCS") and rel_EtcsBalise_BelongsTo_EtcsBaliseGroup or rel_NssBalise_BelongsTo_NssBaliseGroup
				local r, n = getRelatedObjects(s, balise)
				if n == 0 then
					return "unknown", _info("UNFINISHED - Relate balise with '"..s.."' to a balise group to inherit direction.")
				else
					return r[0].dir
				end
			end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToPreviousBalise()" ReturnType="String"
		Description="Checks distance to previous balise. Error if too close (2.35) or not far enough (10.5), warning if (2.35 - 2.8) or (3.2 - 3.5) or (10.5 11.8).">
		<Signature>String NOBN_sig_chkBaliseDistanceToPreviousBalise(ObjRef balise = this)</Signature>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToPreviousBalise(balise)
				balise = balise or this
				local searchDir = "down"
				if balise.Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
				local nextBalise = getDownObject(balise.RcType)
				if nextBalise == nil then return "OK - No "..balise.RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
				local dist = getDistance(balise, nextBalise)
				local t = string.format("%.03f", dist)
			
				if (dist &lt; 2.35 ) then
					return t..": ERROR - Balise magnetic fields may merge - increase distance.",{nextBalise},_error
				elseif (dist &gt;= 2.35 and dist &lt; 2.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt;= 2.8 and dist &lt; 3.2) then
					return t..": OK - The train will treat the balises as belonging to the same group.",{nextBalise},_ok
				elseif (dist &gt;= 3.2 and dist &lt; 3.5) then
					return t..": WARNING - Outside recommended tolerance - decrease distance.",{nextBalise},_warning
				elseif (dist &gt;= 3.5 and dist &lt; 10.5) then
					return t..": ERROR - The train cannot determine which balise group the balise belongs to.",{nextBalise},_error
				elseif (dist &gt;= 10.5 and dist &lt; 11.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt; 11.8) then
					return t..": OK - The train will treat the balises as belonging to different balise groups.",{nextBalise},_ok
				else
					return "ERROR - Bad calculation of distance to neighbour object.",_error,
						_info("DNA error - please notify your DNA agent company - send to support@railcomplete.com.")
				end
			end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToNextBalise()" ReturnType="String"
		Description="Checks distance to next balise. Error if too close (2.35) or not far enough (10.5), warning if (2.35 - 2.8) or (3.2 - 3.5) or (10.5 11.8).">
		<Signature>String NOBN_sig_chkBaliseDistanceToNextBalise(ObjRef balise = this)</Signature>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToNextBalise(balise)
				balise = balise or this
				local searchDir = "up"
				if balise.Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
				local nextBalise = getUpObject(balise.RcType)
				if nextBalise == nil then return "OK - No "..balise.RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
				local dist = getDistance(balise, nextBalise)
				local t = string.format("%.03f", dist)
			
				if (dist &lt; 2.35 ) then
					return t..": ERROR - Balise magnetic fields may merge - increase distance.",{nextBalise},_error
				elseif (dist &gt;= 2.35 and dist &lt; 2.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt;= 2.8 and dist &lt; 3.2) then
					return t..": OK - The train will treat the balises as belonging to the same group.",{nextBalise},_ok
				elseif (dist &gt;= 3.2 and dist &lt; 3.5) then
					return t..": WARNING - Outside recommended tolerance - decrease distance.",{nextBalise},_warning
				elseif (dist &gt;= 3.5 and dist &lt; 10.5) then
					return t..": ERROR - The train cannot determine which balise group the balise belongs to.",{nextBalise},_error
				elseif (dist &gt;= 10.5 and dist &lt; 11.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt; 11.8) then
					return t..": OK - The train will treat the balises as belonging to different balise groups.",{nextBalise},_ok
				else
					return "ERROR - Bad calculation of distance to neighbour object.",_error,
						_info("DNA error - please notify your DNA agent company - send to support@railcomplete.com.")
				end
			end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToTrackVertically()" ReturnType="String"
		Description="Checks vertical distance to track above or below balise.">
		<Signature>String NOBN_sig_chkBaliseDistanceToTrackVertically(ObjRef balise = this)</Signature>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToTrackVertically(balise)
				balise = balise or this
				if (balise.Alignment == nil) then return "UNFINISHED - Missing own alignment.",_error end
				local closestTracks = getNearbyAlignments(balise, rctype_Track)
				local nearestId = ""
				local nearestDist = math.huge
				local i = 0
				while (closestTracks[i]) do
					local aId = closestTracks[i].id
					local sDist = math.abs(getAlignmentInfo(balise, aId).DistanceToAlignment)
					if (balise.Alignment.id ~= aId and sDist &lt; nearestDist) then
						nearestId = aId
						nearestDist = sDist
					else
						i = i + 1
					end
				end
				-- Consider only other alignments being no more than 5 meter sideways apart from balise 
				if (nearestDist &gt; 3.0) then return "OK - No conflicting tracks within 3 meters sideways.",_ok end
				local hDiff = math.abs(getAlignmentInfo(balise).Elevation - getAlignmentInfo(balise, nearestId).Elevation)
				if (hDiff &lt;= 0.8) then
					-- Assume that closest other track is part of a point or crossing, but still accept 80 cm difference for diverging track profiles
					return string.format("%.3f",hDiff)..": OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing.",_ok
				elseif (hDiff &gt; 0.8 and hDiff &lt;= 7.0) then 
					return string.format("%.3f",hDiff)..": ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise.",_error
				elseif (distance &lt;= 8.0) then 
					return string.format("%.3f",hDiff)..": WARNING - Outside recommended tolerance - increase vertical track separation or move balise.",_warning
				else 
					return string.format("%.3f",hDiff)..": OK - A Train in a track above/under us will pass without reading the balise.",_ok 
				end
			end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToTrackSideways()" ReturnType="String"
		Description="Checks distance from balise to neighbour tracks">
		<Signature>String NOBN_sig_chkBaliseDistanceToTrackSideways(ObjRef balise = this)</Signature>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToTrackSideways(balise)
				balise = balise or this
				if (balise.Alignment == nil) then return "UNFINISHED - Missing own alignment.",_error end
				local closestTracks = getNearbyAlignments(balise, rctype_Track)
				local nearestId = ""
				local i = 0
				while (closestTracks[i]) do
					if (balise.Alignment.id ~= closestTracks[i].id) then
						nearestId = closestTracks[i].id
						break
					else
						i = i+1
					end
				end
				if (nearestId == "") then return "OK - No neighbouring track(s).",_ok end
				local sDist = math.abs(getAlignmentInfo(balise, nearestId).DistanceToAlignment)
				if RC__isNan(sDist) then return "No sideways distance found.", _noSymbol end
				if (sDist &lt; 1.4) then 
					return string.format("%.3f",sDist)..": ERROR – Balise may be read by a train in a neighbouring track – increase distance.",_error
				elseif (sDist &lt; 2.0) then 
					return string.format("%.3f",sDist)..": WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 meter from neighbouring track (large balise) resp. 2.3 meter (minibalise) – increase distance.",_warning
				else
					return string.format("%.3f",sDist)..": OK – a Train in neighbouring track will pass without reading the balise.",_ok
				end
			end
		</Formula>
	</LuaFunction>



<!--========================================================================================================
	Signalling - ATP (automatic train protection) - ETCS
=========================================================================================================-->
    <LuaFunction Name="_JBTSA_ETB_positionInGroup()" ReturnType="String" 
		Description="Returns the number #0..#7 of the ETCS balise in its ETCS balise group.">
        <Signature>String _JBTSA_ETB_positionInGroup(objRef balise = this)</Signature>
        <Formula>
			function _JBTSA_ETB_positionInGroup(balise)
				balise = balise or this
				local baliseGroups, nBaliseGroups = balise:getRelatedObjects(rel_EtcsBalise_BelongsTo_EtcsBaliseGroup)
				if nBaliseGroups == 0 then
					return "?",_info("Connect the ETCS balise to its ETCS balise group with '"..rel_EtcsBalise_BelongsTo_EtcsBaliseGroup.."' to get the number of the balise within the balise group.")
				else
					local bg = baliseGroups[0]
					local balises, nBalises = bg:getRelatedObjects(rel_EtcsBaliseGroup_Contains_EtcsBalise)
			
					if nBalises == 0 then
						--Should never happen!
						return "?",_info("Connect this balise group with '"..rel_EtcsBaliseGroup_Contains_EtcsBalise.."' to its ETCS balises so that the balises are numbered #0,#1.. and the balise group is positioned on balise #0.")
			
					elseif nBalises == 1 then
						return 0
			
					else --nBalises >= 2:
						if bg.dir ~= 'up' and bg.dir ~= 'down' then
							return "?",_info("The balise group connected to this balise does not have the direction 'up' or 'down' - correct the  direction of the balise group so that the number of this balise in the balise group can be determined.")
						end
						local t = {}
						for i = 0, nBalises-1 do table.insert(t,{id = balises[i].id, pos = balises[i]:getAlignmentInfo().RelativePosition}) end --Assume they are in same RSM track edge
						table.sort(t, function (a, b) local sgn = (bg.dir == 'up' and 1 or -1) return sgn*a.pos &lt; sgn*b.pos end)
						t = getCollectionFromTable(t) --Collections are indexed from 0 to #-1
						for i = 0, nBalises-1 do
							if balise.id == t[i].id then
								return i, _info("Position #"..i.." in direction '"..bg.dir.."' within the balise group '"..RC__identify(bg).."'.")
							end
						end
					end
				end
			end 
		</Formula>
     </LuaFunction>

	 
	 
	<LuaFunction Name="_JBTSA_ETB_TextAbove()" ReturnType="String"
		Description="Returns text above the ETCS balise 2D symbol.">
		<!-- Description="Returns text over the ETCS balise 2D symbol."> -->
		<Signature>String _JBTSA_ETB_TextAbove()</Signature>
		<Formula>
			function _JBTSA_ETB_TextAbove()
				return "#".._JBTSA_ETB_positionInGroup()
			end
		</Formula>
	</LuaFunction>
	
	
	
	<LuaFunction Name="_JBTSA_ETB_TextBelow()" ReturnType="String"
		Description="Returns text below the ETCS balise 2D symbol.">
		<Signature>String _JBTSA_ETB_TextBelow()</Signature>
		<Formula>
			function _JBTSA_ETB_TextBelow()
				return "" --TODO: define _JBTSA_ETB_TextBelow()
			end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="_JBTSA_ETB_code()" ReturnType="String" 
		Description="Returns the 'Code' property of the ETCS balise, extracted from its balise group and its position #0..#7 within the group.">
		<Signature>String _JBTSA_ETB_code()</Signature>
		<Formula>
			function _JBTSA_ETB_code()
				local baliseGroups, nBaliseGroups = this:getRelatedObjects(rel_EtcsBalise_BelongsTo_EtcsBaliseGroup)
				if nBaliseGroups == 0 then
					return _warning,"WARNING - No related balise group"
				elseif nBaliseGroups &gt; 1 then
					return _error,"ERROR - Balise can only belong to one balise group"
				else 
					local bg = baliseGroups[0]
					return string.format(bg.code).."-".._JBTSA_ETB_TextAbove()
				end
			end 
		</Formula>
	</LuaFunction>


	
    <LuaFunction Name="_JBTSA_ETC_dir()" ReturnType="String"
		Description="Checks the direction of the ETCS balise group, returns the already defined  direction [ up | down | none ].">
        <Signature>String _JBTSA_ETC_dir(objRef bg = this)</Signature>
        <Formula>
			function _JBTSA_ETC_dir(bg)
				bg = bg or this
				local infoMsg, symbol
				if bg.dir ~= 'up' and bg.dir ~= 'down' and bg.dir ~= 'none' then
					infoMsg = "ERROR - The  direction of a balise group must be either 'up', 'down' or 'none'."
					symbol = _error
				else
					infoMsg = "The user is expected to set the direction of the balise group."
					symbol = _ok
				end
				return getPropertyValue("dir"),_info(infoMsg),symbol
			end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="_JBTSA_ETC_Mileage()" ReturnType="String"
		Description="Places the ETCS balise group at its balise #0:
			\n
			\n1) The user inserts the balise group and specifies the direction of the balise group. The variant will be set automatically based on the balises related to (contained in) the balise group.
			\n2) The user inserts balises and relates them to the balise group. The number of balises defines the variant of the balise group.
			\n3) RC displays the 2D symbol that corresponds to the variant and the balise group direction.
			\n4) The balise group is in the same position as its balise #0, which becomes the first balise in the direction of the balise group.">
		<Signature>String _JBTSA_ETC_Mileage(ObjRef bg = this)</Signature>
		<Formula>
			function _JBTSA_ETC_Mileage(bg)
				bg = bg or this
				local s = rel_EtcsBaliseGroup_Contains_EtcsBalise
				local balises, nBalises = bg:getRelatedObjects(s)
				if nBalises == 0 then
					return bg:getPropertyValue("mileage"),_info("Relate the balise group with '"..s.."' to its ETCS balises so that the balises are numbered #0,#1.. and the balise group is positioned on balise #0.")
				elseif nBalises == 0 then
					return balises[0].mileage
				else
					local t = {}
					for i = 0, nBalises-1 do table.insert(t,{id = balises[i].id, pos = balises[i].pos, mileage = balises[i].mileage }) end --Assume they are in same RSM track edge
					table.sort(t, function (a, b) local sgn = (dir == 'up' and 1 or -1) return sgn*a.pos &lt; sgn*b.pos end)
					return t[1].mileage, _info("Position erhalten von ETCS-Balise "..RC__identify(getObjectFromId(t[1].id)))
				end
			end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="_JBTSA_ETC_chk_BaliseGroupTypes()" ReturnType="String"
		Description="Checks that the 'Packages' property is syntactically correct.
				\nSee DBAG Ril.819.1344A01 p.60.
				\nExamples: '21&lt;', '&gt;21', '21&lt;&gt;26', '24,28&lt;37&gt;21'.
				\n
				\nTODO: Adapt this code to Bane NOR regulations.">
		<Signature>String _JBTSA_ETC_chk_BaliseGroupTypes(objRef baliseGroup = this)</Signature>
		<Formula>
			function _JBTSA_ETC_chk_BaliseGroupTypes(bg)
				bg = bg or this

				--Find target distance if defined (shortest of all available target distances)
				local r, n = bg:getRelatedObjects(rel_EtcsBaliseGroup_AppliesTo_Object)
				local shortest = math.huge
				local shortestIndex = nil
				for i=0, n-1 do
					local d = getDistance(bg, r[i])
					if d &lt; shortest then 
						shortest = d
						shortestIndex = i
					end
				end

				local t = (shortest == math.huge) 
					and " @ (INCOMPLETE - no target distance/target object)" 
					or string.format("@%.0f:%s %s", shortest, r[shortestIndex].RcType:sub(6,8), RC__identify(r[shortestIndex])) .. (n &gt; 1 and "..("..n..")" or "")

				local function pretty()
					--DP Type with separators:
					local sepLeft = (left or middle) and "&lt;" or ""
					local sepRight = (middle or right) and "&gt;" or ""
					return (left or "")..sepLeft..(middle or "")..sepRight..(right or "")..t
				end

				local bgTypes = tostring(bg.BaliseGroupTypes):gsub("[\t ]","")
				if bgTypes == nil or bgTypes == "" then 
					return _unfinished,"Balise group type?"
				else
					local src = tostring(bgTypes):gsub("%s","") --Remove whitespace
					src = tostring(src):gsub("/",",") --Slash is synonymous to comma
					local check = tostring(src):gsub("[%&lt;%&gt;,0-9 ]","")
					if check ~= "" then
						return _warning,"WARNING - Invalid characters found in the source string ["..check.."]."
					end
					--TODO: Adapt DB rules to Bane NOR rules, write this check properly:
					--Analyze according to Ril.819.1344A01 page 60-75 Table 9:
					--Note: "Left"/"Right" require that the bg's own alignment has mileage increasing towards the right as seen on-screen.
					--Parse all combinations:
					local left = nil
					local middle = nil
					local right = nil
					if src:match("^&lt;([0-9,]+)$") 
						or src:match("^([0-9,]+)&lt;([0-9,]+)$")
						or src:match("^([0-9,]+)&gt;$")
						or src:match("^([0-9,]+)&gt;([0-9,]+)$")
					then
						return _warning,"WARNING - Invalid direction specified in the source string ["..src.."]."
					end
					left, middle, right = src:match("^([0-9,]+)&lt;([0-9,]+)&gt;([0-9,]+)$")
					if left and middle and right then return pretty() end
					left, middle = src:match("^([0-9,]+)&lt;([0-9,])&gt;$")
					if left and middle then return pretty() end
					left, right = src:match("^([0-9,]+)&lt;&gt;([0-9,]+)$")
					if left and right then return pretty() end
					middle, right = src:match("^&lt;([0-9,]+)&gt;([0-9,]+)$")
					if middle and right then return pretty() end
					left = src:match("^([0-9,]+)&lt;$")
					if left then return pretty() end
					middle = src:match("^&lt;([0-9,]+)&gt;$")
					if middle then return pretty() end
					right = src:match("^&gt;([0-9,]+)$")
					if right then return pretty() end
					local implicitDirection = src:match("^[0-9,]+$")
					if implicitDirection then
						if dir == 'up' then 
							right = implicitDirection
						else
							left = implicitDirection
						end
						return pretty()
					end
					return pretty("Incorrect balise group type syntax:"..tostring(bgTypes)) 
				end
			end
		</Formula>
	</LuaFunction> 
			


	<LuaFunction Name="_JBTSA_ETC_code()" ReturnType="String" 
		Description="The ETCS balise group's code property shall be defined by the user.">
		<Signature>String _JBTSA_ETC_code()</Signature>
		<Formula>
			function _JBTSA_ETC_code()
				return "Delete this text/formula, enter a valid balise group id number."
			end
		</Formula>
	</LuaFunction> 



	<LuaFunction Name="_JBTSA_ETC_name()" ReturnType="String" 
		Description="Returns the name property of the ETCS balise group, which results from its ETCS area number, its balise group number and balise group packets.
				\nThe ETCS area number is taken from an RC area of the type 'ETCS area (NID_C)', which encloses the ETCS objects.
				\nThe balise group number is taken from the 'Code' property (NID_BG).
				\nThe data point packets are taken from the 'Data point packets' string.">
		<Signature>String _JBTSA_ETC_name(objRef baliseGroup = this)</Signature>
		<Formula>
			function _JBTSA_ETC_name(bg)
				bg = bg or this
				local etcsAreas = bg.RcArea:filter(function (x) return x.Variant == "ETCS-Bereich (NID_C)" and x:isVisible() end)
				local nEtcsAreas = getCollectionLength(etcsAreas)
				local infoMsg, NID_C
				if nEtcsAreas == 0 then
					NID_C = "ETCS-Area (NID_C)?"
					infoMsg = "The balise group is not located in an ETCS area."
				elseif nEtcsAreas > 1 then
					NID_C = string.format("%03d",etcsAreas[0].code)
					infoMsg = "The balise group is located in several ETCS areas."
				else
					NID_C = string.format("%03d",etcsAreas[0].code)
					infoMsg = nil
				end

				NID_BG = type(bg.code) == "number" and string.format("%05d",bg.code) or "Code (NID_BG)?"
				
				return string.format("%s %s %s", NID_C, NID_BG, tostring(bg.BaliseGroupTypes)),infoMsg and _info(infoMsg)
			end
		</Formula>
	</LuaFunction> 



	<LuaFunction Name="_JBTSA_ETC_eng_balise_bgTypes2packets()" ReturnType="String" 
		Description="Returns a collection of ETCS packets as a function of DB Netz Balise Group Type(s).
			\nRef: Grundsätze zur Erstellung der Ausführungsplanung PT1 für ETCS Level 2 – Streckenausrüstung nach LH BTSF3 V2.2 819.1344A01, Kap. 5.1 Datenpunkttypen.">
		<Signature>String _JBTSA_ETC_eng_balise_bgTypes2packets(collectionOfBaliseGroupTypes bgTypes)</Signature>
		<Formula>
			function _JBTSA_ETC_eng_balise_bgTypes2packets(bgTypes)
				--TODO: Adapt the balise group type table to Bane NOR regulations:
				local etcsBalisePacketTable = {
					--DP-Typ","Beschreibung","Balisenanzahl","Enthaltene Pakete","Wirkrichtung Pakete","Wirkrichtung DP"
					{1,"Netzeinwahl-Datenpunkt","2","45","→","Ri L2"},
					{2,"Funkaufbau-Datenpunkt","2","42","→","Ri L2"},
					{3,"Ortungs-Datenpunkt vor Einstieg","2","-","-","Ri L2"},
					{4,"Einstiegs-Grenzdatenpunkt","2","3","46","↔","→","Ri Einstieg"},
					{5,"Abbruch-Datenpunkt vor Einstiegs-Grenzdatenpunkt","2","32, 42","→","Ri LNTC"},
					{6,"Erster Abbruch-DP für Rückrichtung an Einstiegs-Grenz-DP","2","32, 41, 42","→","Ri LNTC"},
					{8,"Datenpunkt für nationale Werte an Ländergrenze","2","3, 41","→","Ri D"},
					{9,"Datenpunkt zur Unterdrückung einer Zwangsbremsung bei startenden Zügen","2","145","→","Ri DP"},
					{20,"Datenpunkt an Signalen","2","137","→","Ri Signal"},
					{21,"Datenpunkt an Ausfahrsignalen","2","423, 45","46, 137","↔","→","Ri Signal"},
					{22,"Datenpunkt an Blockkennzeichen","1","-","-","Ri Signal"},
					{23,"Erster Ortungs-Datenpunkt vor Signalen","1","-","-","Ri Signal"},
					{24,"Zweiter Ortungs-Datenpunkt vor Signalen","1","-","-","Ri Signal"},
					{25,"Allgemeiner Ortungs-Datenpunkt","1","-","-","beide Ri"},
					{26,"TSR-Datenpunkt","2","654, 1414","→","Ri Signal"},
					{27,"Datenpunkt für Trusted Areas","2","-","-","beide Ri"},
					{28,"Datenpunkt für Start of Mission (SoM)","1 / 2","-","-","Ri Signal"},
					{29,"Metallwarnungs-Da-tenpunkt","2","67","→","Ri BMM"},
					{30,"Halt-Datenpunkt 1","1","12, 21, 27, 41, 254","→","Ri Signal"},
					{31,"Halt-Datenpunkt 2","1","41","↔","Ri Signal"},
					{32,"Datenpunkt zur Erhöhung der SR-Geschwindigkeit","2","3, 655, 141","→","RFR"},
					{33,"Datenpunkt zur Herabsetzung der SR-Geschwindigkeit","2","3, 66","→","RFR"},
					{34,"Datenpunkt zur TSR-Wiederholung","2","65, 141","→","RFR"},
					{35,"Zufahrtsicherungsdatenpunkt","2","41","→","Ri L2oS"},
					{36,"TSR-Datenpunkt 2","2","65, 141","→","Ri TSR"},
					{37,"Datenpunkt für Rücknahme TSR","1 / 2","66","→","RN TSR"},
					{38,"Datenpunkt für nationale Werte","2","3","↔","Ri L2 / Ri Bf"},
					{43,"Datenpunkt für Bahnübergänge mit Überwachungssignalen","2","656, 886, 141","254","→","↔","Ri ÜS"},
					{44,"Ortungsdatenpunkt für Bahnübergänge mit Überwachungssignalen","2","65","254","→","↔","Ri BÜ"},
					{45,"Datenpunkt für Einschaltstrecke von Bahnübergängen mit Überwachungssignalen oder fernüberwacht","2","72","→","Ri BÜ"},
					{50,"Grenz-Datenpunkt RBC-Wechsel","2","3, 45, 131","→","Ri Signal"},
					{60,"Grenz-Datenpunkt für reguläre Ausstiege","2","37, 41, 42, 658, 729, 1418","→","Ri LNTC"},
					{61,"Grenz-Datenpunkt für harte Ausstiege","2","36, 41, 42","→","Ri LNTC"},
					{62,"Hilfs-Grenzdatenpunkt 1","2","41","→","Ri LNTC","63","Hilfs-Grenzdatenpunkt 2","2","46","4110","→","←","Ri LNTC / Ri L2mS"}
				}
				--local tmp = tostring(bgTypes):gsub(","," "):gsub("/"," ")
				--iterator = for i, t in pairs(tmp) do return v end
				return etcsBalisePacketTable[1]
			end
		</Formula>
	</LuaFunction>



<!--========================================================================================================
	Signalling - ATP (automatic train protection) - NSS
=========================================================================================================-->
    <LuaFunction Name="_JBTSA_ATC_code()" ReturnType="String" 
		Description="Returns balise group object ID (7 chars) (Ref Signal-Prosj-ATC-7.11-Baliseidentitet).">
        <Signature>String _JBTSA_ATC_code()</Signature>
        <Formula>
			function _JBTSA_ATC_code()
				local a
				if Variant == "Hastighetsbalisegruppe" then
					a = "-H"
				elseif Variant == "Signalhøyningsbalisegruppe" then
					a = "-S"
				elseif Variant == "Grensebalisegruppe" then
					a = "-G"
				elseif Variant == "Lenkingsbalisegruppe" then
					a = "-L"
				elseif Variant == "Sporvekselbalisegruppe" then
					a = "-V"
				elseif Variant == "Hovedsignalbalisegruppe" then 
					a = "_"
				elseif Variant == "Forsignalbalisegruppe" then
					a = "F"
				elseif Variant == "Repeterbalisegruppe" then
					local s = rel_NssBaliseGroup_AppliesTo_Object
					local r, n = getRelatedObjects(s)
					if n == 0 then
						-- Balise group has no relation to a signal yet:
						return "UNFINISHED - Relate with '"..s.."'."
					else
						local sig = r[0] --should be a signal here, repeater groups don't repeat switches directly
						local bg = getRelatedObjects(rel_Object_Has_NssBaliseGroup, sig)
						bg = bg:filter(function (x) return x.Variant == "Repeterbalisegruppe" end)
						local nbg = getCollectionLength(bg)

						if nbg == 0 then
							--I am here, so n *must* be greater than zero:
							return "Should not happen - bad relation loop." 

						elseif nbg == 1 then
							-- I am the only repeater group:
							a = "R"

						elseif nbg == 2 then
							-- Assign 'R' to the one farthest away, 'U' to the one closest to signal: 
							local b1 = bg[0]
							local b2 = bg[1]
							if getDistance(b1, sig) &lt; getDistance(b2, sig) then
								b1, b2 = b2, b1
								--Now b1 is the first repeater group in the driving direction
							end
							if this.id == b1.id then
								--I am the closest repeater group:
								a = "U"
							else
								--I am the farthest repeater group:
								a = "R"
							end

						elseif nbg == 3 then
							-- Assign 'R' to the one farthest away, then 'U' and then 'V' to the one closest to signal:
							local b1 = bg[0]
							local b2 = bg[1]
							local b3 = bg[2]
							--Bubble sort, n=3
							if getDistance(b1, sig) &lt; getDistance(b2, sig) then b1, b2 = b2, b1 end	-- Pass 1
							if getDistance(b2, sig) &lt; getDistance(b3, sig) then b2, b3 = b3, b2 end	-- Pass 1
							if getDistance(b1, sig) &lt; getDistance(b2, sig) then b1, b2 = b2, b1 end	-- Pass 2
							if this.id == b1.id then
								--I am the first repeater group in the driving direction:
								a = "R"
							elseif this.id == b2.id then
								--I am the middle repeater group:
								a = "U"
							else 
								a = "V"
							end

						elseif nbg == 4 then
							-- Assign 'R' to the one farthest away, then 'U', 'V' and then 'W' to the one closest to signal:
							local b1 = bg[0]
							local b2 = bg[1]
							local b3 = bg[2]
							local b4 = bg[3]
							--Bubble sort, n=4
							if getDistance(b1, sig) &lt; getDistance(b2, sig) then b1, b2 = b2, b1 end	-- Pass 1
							if getDistance(b2, sig) &lt; getDistance(b3, sig) then b2, b3 = b3, b2 end	-- Pass 1
							if getDistance(b3, sig) &lt; getDistance(b4, sig) then b3, b4 = b4, b3 end	-- Pass 1
							if getDistance(b1, sig) &lt; getDistance(b2, sig) then b1, b2 = b2, b1 end	-- Pass 2
							if getDistance(b2, sig) &lt; getDistance(b3, sig) then b2, b3 = b3, b2 end	-- Pass 2
							if getDistance(b1, sig) &lt; getDistance(b2, sig) then b1, b2 = b2, b1 end	-- Pass 3
							if this.id == b1.id then
								--I am the first repeater group in the driving direction:
								a = "R"
							elseif this.id == b2.id then
								--I am the second repeater group in the driving direction:
								a = "U"
							elseif this.id == b3.id then
								--I am the third repeater group in the driving direction:
								a = "V"
							else --this.id == b4.id
								--I am the fourth and last repeater group in the driving direction, closest to the signal:
								a = "W"
							end
						end
					end
				end
				local ocpMsg = "Create an Operation / Control Point (OCP) area around your object and refresh it to replace '???' with the relevant OCP's codes."
				if Variant == "Hastighetsbalisegruppe" then
					local r, n = getRelatedObjects(rel_NssBaliseGroup_HasBrakingCurveTargetIn_NssBaliseGroup)
					local ocp
					if n == 0 then
						--Group is braking curve target:
						ocp = NOBN_com_getOcpCode(getObjectFromId(id))
					else
						--Warning board, use target's ocp:
						ocp = NOBN_com_getOcpCode(r[0])
					end
					return ocp..a..string.format("%02d",Seq)
				elseif Variant == "Signalhøyningsbalisegruppe" or Variant == "Sporvekselbalisegruppe" then
					local ocp = NOBN_com_getOcpCode(this)
					if Seq == 0 then
						return ocp..a.."UNFINISHED - Set balise group's 'Seq' property to the required balise group number (01..99), use '100' for '0'."
					else
						return ocp..a..string.format("%02d",Seq%100)
					end
				elseif Variant =="Lenkingsbalisegruppe" or Variant == "Grensebalisegruppe" then
					local s = rel_NssBaliseGroup_LinksTo_NssBaliseGroup
					local r, n = getRelatedObjects(s)
					local ocp
					if n == 0 then
						ocp = NOBN_com_getOcpCode(getObjectFromId(id))
					else
						ocp = NOBN_com_getOcpCode(r[0])
					end
					if Seq == 0 then
						return ocp..a.."UNFINISHED - Set balise group's 'Seq' property to the required balise group number (01..99), use '100' for '0'."
					else
						return ocp..a..string.format("%02d",Seq%100)
					end
				else
					local s = rel_NssBaliseGroup_AppliesTo_Object
					local r, n = getRelatedObjects(s)
					if n == 0 then
						return "UNFINISHED - Relate with '"..s.."'."
					else
						--Assume r[0] holds object dictating the group's number:
						local ocp = NOBN_com_getOcpCode(r[0])
						if r[0].code == nil then 
							return ocp..a.."???", _info(ocpMsg)
						elseif tostring(r[0].code):match("%d+") == nil then
							return ocp..a.."???", _info(ocpMsg)
						else
							return ocp..a..tostring(r[0].code):match("%d+"):sub(-3) 
						end 
					end
				end
			end
        </Formula>
    </LuaFunction> 

	
	
    <LuaFunction Name="_JBTSA_ATB_code()" ReturnType="String" 
		Description="Returns balise object Id (8 chars) from the 7-char balise group ID and the P/A/B/C balise type (Ref Signal-Prosj-ATC-7.11-Baliseidentitet).">
        <Signature>String _JBTSA_ATB_code()</Signature>
        <Formula>
			function _JBTSA_ATB_code()
				local s = rel_NssBalise_BelongsTo_NssBaliseGroup
				local r, n = getRelatedObjects(s)
				local bg
				if n == 0 then  
					return "UNFINISHED - Relate with '"..s.."' to balise group.",
							_info("Balises derive their ID (code property) from their balise group's code, direction, and the balise's relative position within the balise group. The 'A' balise must be related to the balise group using the relation for position defining balise.")
				else
					bg = r[0]
				end
				if bg.dir ~= "up" and bg.dir ~= "down" then 
					return "Bad direction ["..bg.dir.."]",_warning 
				end
				
				local sq = rel_NssBaliseGroup_HasPositionDeterminedBy_NssBalise
				local q, nq = getRelatedObjects(sq, bg)
				local isA
				local siblings, nsiblings
				local Abalise
				if nq == 0 then 
					return "UNFINISHED - No A-balise in balise group - relate to balise group with '"..sq.."'."
				else
					Abalise = q[0]
					local _qq, nqq = getRelatedObjects(rel_NssBalise_DeterminesPositionFor_NssBaliseGroup)
					isA = (nqq == 1) --it's me...
					siblings, nsiblings = getRelatedObjects(rel_NssBaliseGroup_Contains_NssBalise, bg)
				end

				local suffix
			
				if isA == true then
					suffix = "A"
				else
					if nsiblings == 2 then
						suffix = "B"            
					elseif nsiblings &gt; 2 then
						local Pbalise={id=0, diff=math.huge}
						local Bbalise={id=0, diff=math.huge}
						local Cbalise={id=0, diff=math.huge}
						for i = 0, nsiblings-1 do
							local diff = (bg.dir == "up") and (siblings[i].ReferenceMileage - Abalise.ReferenceMileage) or (Abalise.ReferenceMileage - siblings[i].ReferenceMileage)
							if (diff &lt; 0) then
								if Pbalise.id == 0 then
									Pbalise.id = siblings[i].id
									Pbalise.diff = diff
								elseif Pbalise.diff &gt; diff then
									Pbalise.id = siblings[i].id
									Pbalise.diff = diff
								end                
							elseif (diff &gt; 0) then
								if Bbalise.id == 0 then
									Bbalise.id = siblings[i].id
									Bbalise.diff = diff
								elseif Bbalise.diff &gt; diff then
									Cbalise.id = Bbalise.id
									Cbalise.diff = Bbalise.diff
									Bbalise.id = siblings[i].id
									Bbalise.diff = diff                    
								elseif Cbalise.diff &gt; diff then
									Cbalise.id = siblings[i].id
									Cbalise.diff = diff                    
								end                        
							else
								--diff==0: Do nothing
							end
						end    
						if this.id == Bbalise.id then 
							suffix = "B"
						elseif this.id == Cbalise.id then
							suffix = "C"
						elseif this.id == Pbalise.id then
							suffix = "P"
						else
							suffix = "WARNING - Bad balise group configuration - cannot determine PABC type.",_warning
						end
					end
				end
				local groupId = RC__identify(bg)
				return groupId:sub(1,2):lower():match("unfinished") and suffix or groupId..suffix
			end 
		</Formula>
     </LuaFunction>

	 
	 
    <LuaFunction Name="_JBTSA_ATB_TextAbove()" ReturnType="String"
		Description="Returns text over the NSS balise 2D symbol (Ref Signal-Prosj.-ATC-7.1/7.2-Enkeltrettede/Dobbeltrettede balisegrupper).">
        <Signature>String _JBTSA_ATB_TextAbove()</Signature>
        <Formula>
			function _JBTSA_ATB_TextAbove()
				local s = rel_NssBalise_BelongsTo_NssBaliseGroup
				local r, n = getRelatedObjects(s)
				if n == 0 then
					return "UNFINISHED - Relate with '"..s.."' to NSS balise group."
				else
					local bg = r[0]
					local t = code:sub(-1)
					if bg.Variant == "Hastighetsbalisegruppe" then
						if t == "A" then
							return "H"
						elseif t == "B" then
							if Variant:lower():match("fylt") then
								return "H"
							else
								return ""
							end
						elseif t == "C" then
							return ""
						else
							return "?",_warning, _info("WARNING - Cannot determine text above balise symbol (balise is neither A, B or C balise).")
						end
					elseif bg.Variant == "ET-balisegruppe" then
						if t == "A" then
							return "EH"
						elseif t == "B" then
							if Variant:lower():match("fylt") then
								return "EH"
							else
								return ""
							end
						elseif t == "C" then
							return ""
						else
							return "?",_warning, _info("WARNING - Cannot determine text above balise symbol (balise is neither A, B or C balise).")
						end
					elseif code:sub(-1) == "P" then
						return "P"
					else
						return ""
					end
				end
			end
		</Formula>
     </LuaFunction>


	 
    <LuaFunction Name="_JBTSA_ATB_TextBelow()" ReturnType="String"
		Description="Returns text below the NSS balise 2D symbol (Ref Signal-Prosj.-ATC-7.1/7.2-Enkeltrettede/Dobbeltrettede balisegrupper).">
        <Signature>String _JBTSA_ATB_TextBelow()</Signature>
        <Formula>
			function _JBTSA_ATB_TextBelow()
				local r, n = getRelatedObjects(rel_EtcsBalise_DeterminesPositionFor_EtcsBaliseGroup)
				if n &gt; 0 then
					return RC__identify(r[0])
				else
					return ""
				end
			end
		</Formula>
     </LuaFunction>

	 
	 
<!--========================================================================================================
	SIGNALLING
	BALISE GROUP - ETCS
=========================================================================================================-->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" LuaName="rctype_EtcsBaliseGroup" Name="JBTSA_ETC ETCS balisegruppe" 
				Layer="JBTSA_ETC" Color="ByLayer"
				Group="Signal/Hastighetskontroll/ETCS"
				AttMirrorX="{% if dir == 'down' %}true{% else %}false{% endif %}"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>ETCS_balisegruppe</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>

		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT"/>

		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>

	
		<Variants DefaultValue="ETCS L2 balisegruppe, enkel">
			<Variant Name="ETCS L2 balisegruppe, enkel"/>
			<Variant Name="ETCS L2 balisegruppe, dobbel"/>
		</Variants>
		
		<CustomProperty DataType="String" Name="BaliseGroupTypes" DisplayName="Balise group types" DefaultValue="BG type?"
			Description="ETCS balise group packet content.
				\nSee DB Netz Ri 819.1344A01, 'Grundsätze zur Erstellung der Ausführungsplanung PT1 für ETCS Level 2 – Streckenausrüstung nach LH BTSF3 V2.2, Tabelle 9.'
				\n
				\nTODO: Adapt code to a similar document for Bane NOR."/>

		<CustomProperty DataType="String" ReadOnly="true" Category="Model check"
			Name="mc_BaliseGroupTypes" DisplayName="Validation of the balise group type coding"
			Description="Validation of the balise group type coding, according to DBAG Ri 819.1344A01 p. 60.
				\nExamples: '21&lt;', '&gt;21', '21&lt;&gt;26', '24,28&lt;37&gt;21'.
				\n
				\nTODO: Adapt to the corresponding Bane NOR regulations."/>
		<LuaExpression Name="mc_BaliseGroupTypes" IsModelCheck="true"><Formula>_JBTSA_ETC_chk_BaliseGroupTypes()</Formula></LuaExpression>

		<SetValue Key="code" Value="NID_BG?"/>
		<LuaExpression Name="name"><Formula>_JBTSA_ETC_name()</Formula> </LuaExpression>
		<!-- <LuaExpression Name="ObjectInfo"><Formula>Variant</Formula></LuaExpression> -->
		<LuaExpression Name="Mileage"><Formula>_JBTSA_ETC_Mileage()</Formula></LuaExpression>
		<LuaExpression Name="LateralOffset"><Formula>(RightSided and 1 or -1) * 1e-3</Formula></LuaExpression>

		<!-- Note: 'dir' shall be set by the user, but Variant is deduced by the balise group itself, from its balises. -->

		<LuaExpression Name="Variant"><Formula>_JBTSA_ETC_Variant()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_ETC_Variant()" ReturnType="String" 
			Description="Specifies the variant, depending on the number of balises in the group and the group's direction property ('up'/'down').">
			<Signature>String _JBTSA_ETC_Variant()</Signature>
			<Formula>
				function _JBTSA_ETC_Variant()
					local balises, nBalises = getRelatedObjects(rel_EtcsBaliseGroup_Contains_EtcsBalise)
					if nBalises == 0 then
						return getPropertyValue("Variant"),_info("UNFINISHED - Balise group has no balises")
					elseif nBalises == 1 then
						return "ETCS L2 balisegruppe, enkel"
					elseif nBalises &gt;= 2 then
						return "ETCS L2 balisegruppe, dobbel"
					end
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="BaneNORBeskrivelse"><Formula>Variant</Formula></LuaExpression>

		<TextPositionLuaExpression Name="NAME"><Formula>RC__TextAttributePosition((RightSided and 1 or -1)*5.25, 0)</Formula></TextPositionLuaExpression>
		<TextRotationLuaExpression Name="NAME"><Formula>RC__TextAttributeRotation(0)</Formula></TextRotationLuaExpression>

		<InsertPointObject Name="ETCS L2 balisegruppe, enkel" DisplayBlockName="NO-BN-2D-JBTSA_ETC-ETCS-BALISEGRUPPE-ENKEL-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true"/> 
		</InsertPointObject>

		<InsertPointObject Name="ETCS L2 balisegruppe, dobbel" DisplayBlockName="NO-BN-2D-JBTSA_ETC-ETCS-BALISEGRUPPE-DOBBEL-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true"/> 
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="" AllowSymbolMove="true">
			<Rotation AddAngle="{% if dir == 'up' %}0{% elsif dir == 'down' %}180{% else %}45{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ETC-ETCS-BALISEGRUPPE
				{% if Variant contains "enkel" %}ENKEL
				{% elsif Variant contains "dobbel" %}DOBBEL
				{% else %}BAD_Variant_{{Variant}}
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
			<SymbolAttribute Tag="TEKSTOVER">
				<Value>"TODO: tekst over"</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="TEKSTUNDER">
				<Value>"TODO: tekst under"</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="ETCS_balise"/>
				<SnapPoint X="0" Y="0" TargetSpace="ETCS_balise"/>
				<SnapPoint X="3" Y="0" TargetSpace="ETCS_balise"/>
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
	SIGNALLING
	BALISE - ETCS
=========================================================================================================-->
	<ObjectType DataType="tBalise" Class="RailwayPlacedObject" LuaName="rctype_EtcsBalise" Name="JBTSA_ETB ETCS balise"
				Layer="JBTSA_ETB" Color="ByLayer"
				Group="Signal/Hastighetskontroll/ETCS"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>ETCS_balise</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>
		
		<Variants DefaultValue="ETCS-balise, fast">
			<Variant Name="ETCS-balise, fast">
			</Variant>
			<Variant Name="ETCS-balise, styrt">
			</Variant>
		</Variants>

		<CustomProperty DataType="Enumeration" Name="BaliseType" DefaultValue="ETCS Eurobalise">
			<Values>
				<Value>ETCS Eurobalise</Value>
			</Values>
		</CustomProperty>
				   
		<CustomProperty DataType="String" Name="TextAbove" DisplayName="Tekst over" DefaultValue="" 
			Description="Text above balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC tables 7.1 and 7.2."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
		<LuaExpression Name="TextAbove"><Formula>_JBTSA_ETB_TextAbove()</Formula></LuaExpression>
		
		<CustomProperty DataType="String" Name="TextBelow" DisplayName="Tekst under" DefaultValue=""
			Description="Returns Text below  balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC table 7.11."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
		<LuaExpression Name="TextBelow"><Formula>_JBTSA_ETB_TextBelow()</Formula></LuaExpression>
	
		<LuaExpression Name="Geometry3D_0.Name"><Formula>_JBTSA_ETB_Geometry3DName()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_ETB_Geometry3DName()" ReturnType="String"
			Description="Returns the 3D model name for an ETCS balise.">
			<Signature>String _JBTSA_ETB_Geometry3DName()</Signature>
			<Formula>
				function _JBTSA_ETB_Geometry3DName()
					local s = "NO-BN-3D-SA-ETB-ETCS"
					if BaliseType == "ETCS Eurobalise" then s = s.."-EUROBALISE"
					else return "Unknown BaliseType ["..BaliseType.."].",_warning
					end
					if Variant:lower():match("fast") then s = s.."-FAST"
					elseif Variant:lower():match("styrt") then s = s.."-STYRT"
					else return "Unknown Variant ["..Variant.."].",_warning
					end
					return s, _info(Variant.." "..BaliseType.." balise.")
				end
			</Formula>
		</LuaFunction>

		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToNextBalise" DisplayName="Avstand til neste balise" 
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToPreviousBalise" DisplayName="Avstand til forrige balise"
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackVertically" DisplayName="Avstand til spor i høyden"
			Description="
			&lt; 0.8 m: OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing\n
			0.8-7.0 m: ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise\n
			7.0-8.0 m: WARNING - Outside recommended tolerance - increase vertical track separation or move balise\n
			&gt; 8.0m: OK - A Train in a track above/under us will pass without reading the balise"/>

		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackSideways" DisplayName="Avstand til nabospor"
			Description="
			Below 2 m: ERROR – Balise may be read by a train in the neighbouring track – increase distance\n
			2-2.6 m: WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 m from neighbouring track (large balise) resp. 2.3 m (minibalise) – increase distance\n
			Over 2.6 m: OK – Train in neighbouring track will pass without reading the balise"/>
		
		<LuaExpression Name="code"><Formula>_JBTSA_ETB_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code:lower():match("unfinished") and code or ""</Formula> </LuaExpression>
		<LuaExpression Name="dir"><Formula>NOBN_sig_getBaliseGroupDirection()</Formula></LuaExpression>
		<LuaExpression Name="LateralOffset"><Formula>RightSided and 1e-3 or -1e-3</Formula></LuaExpression>
		
		<LuaExpression Name="mc_DistanceToPreviousBalise" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToPreviousBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToNextBalise" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToNextBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackVertically" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackVertically()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackSideways" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackSideways()</Formula></LuaExpression>
			
		<InsertPointObject Name="ETCS-balise, fast" DisplayBlockName="NO-BN-2D-JBTSA_ETB-ETCS-BALISE-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>
		
		<InsertPointObject Name="ETCS-balise, styrt" DisplayBlockName="NO-BN-2D-JBTSA_ETB-ETCS-BALISE-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="" AllowSymbolMove="true">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ETB-ETCS-BALISE
				{% if Variant contains 'fast' %}FAST
				{% elsif Variant contains 'styrt' %}STYRT
				{% else %}BAD_Variant_{{Variant}}
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
			<SymbolAttribute Tag="TEKSTOVER">
				<Value>{{TextAbove}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="TEKSTUNDER">
				<Value>{{TextBelow}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="" AllowSymbolMove="false">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ETB-ETCS-BALISE
				{% if Variant contains 'fast' %}FAST
				{% elsif Variant contains 'styrt' %}STYRT
				{% else %}BAD_Variant_{{Variant}}
				{% endif %}
				Metric
			</BlockNameFormat>
		</SymbolDefinition>

		<Annotation3DTagDefinition>
			<Attribute Tag="T01">
				<Value>{{code}}</Value>
			</Attribute>
		</Annotation3DTagDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="ETCS_balisegruppe"/>
				<SnapPoint X="0" Y="0" TargetSpace="ETCS_balisegruppe"/>
				<SnapPoint X="3" Y="0" TargetSpace="ETCS_balisegruppe"/>
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
	SIGNALLING
	BALISE GROUP - LEGACY / NATIONAL SIGNALLING SYSTEM
=========================================================================================================-->
	<!-- Balisegruppen kan kobles til signal(er), sporveksel(ler), radioområder, RBC-områder, sikringsanleggområder,  -->
	<!-- stasjonsområder osv o.a.  -->
	<!-- Noen tilkobinger arver posisjon fra sin forelder (signal), andre ikke (sporveksel, annen balisegruppe). -->
	<!-- Lenkingsgrupper: Kobles til annen balisegruppe. -->
	<!-- Signaler og forsignaler, evt dvergsignaler, fiktive osv: Balisegruppen kobles til signalet. -->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" LuaName="rctype_BaliseGroup" Name="JBTSA_ATC NSS balisegruppe" 
				Layer="JBTSA_ATC" Color="ByLayer"
				Group="Signal/Hastighetskontroll/NSS (ATC2)"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>NSS_balisegruppe</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>

		<!-- TODO: Inkluder alle disse properties for å kunne generere kodetabeller automatisk -->
		<!--	
		<CustomProperty DataType="String" Name="Retning" DisplayName="Retning" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Sign_Type" DisplayName="Sign_Type" DefaultValue=""/>
		<CustomProperty DataType="String" Name="BaliseID" DisplayName="BaliseID" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Signalbilde_1H" DisplayName="Signal_1H" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Signalbilde_1F2H" DisplayName="Signalbilde_1F2H" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Signalbilde_2F" DisplayName="Signalbilde_2F" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Kjørhastighet" DisplayName="Kjørhastighet" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Venthastighet" DisplayName="Venthastighet" DefaultValue=""/>
		<CustomProperty DataType="String" Name="P-avstand" DisplayName="P-avstand" DefaultValue=""/>
		<CustomProperty DataType="String" Name="B-avstand" DisplayName="B-avstand" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Fall" DisplayName="Fall" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Frislipphastighet" DisplayName="Frislipphastighet" DefaultValue=""/>
		<CustomProperty DataType="String" Name="MotrettetType" DisplayName="MotrettetType" DefaultValue=""/>
		<CustomProperty DataType="String" Name="MotrettetHastighet" DisplayName="MotrettetHastighet" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Togveier" DisplayName="Togveier" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Pxyz" DisplayName="Pxyz" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Axyz" DisplayName="Axyz" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Bxyz" DisplayName="Bxyz" DefaultValue=""/>
		<CustomProperty DataType="String" Name="Cxyz" DisplayName="Cxyz" DefaultValue=""/>
		-->
		<Variants DefaultValue="Hovedsignalbalisegruppe">
			<Variant Name="Hovedsignalbalisegruppe"/>
			<Variant Name="Forsignalbalisegruppe"/>
			<Variant Name="Repeterbalisegruppe"/>
			<Variant Name="Sporvekselbalisegruppe"/>
			<Variant Name="Hastighetsbalisegruppe"/>
			<Variant Name="Lenkingsbalisegruppe"/>
			<Variant Name="Signalhøyningsbalisegruppe"/>
			<Variant Name="ET-balisegruppe"/>
			<Variant Name="Grensebalisegruppe"/>
			<Variant Name="Radioområdebalisegruppe"/>
			<Variant Name="Diversebalisegruppe"/>
		</Variants>

		<LuaExpression Name="code"><Formula>_JBTSA_ATC_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code</Formula></LuaExpression>
		<LuaExpression Name="BaneNORBeskrivelse"><Formula>Variant</Formula></LuaExpression>

		<!--Hovedsignal alene og kombinertsignal (Hs+Fs) balisegruppe-->
		<InsertPointObject Name="Hovedsignalbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Forsignalbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Repeterbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Sporvekselbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Hastighetsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Lenkingsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Signalhøyningsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="ET-balisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Grensebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Radioområdebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject Name="Diversebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}" AllowSymbolMove="true">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

			<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="NSS_balise"/>
				<SnapPoint X="0" Y="0" TargetSpace="NSS_balise"/>
				<SnapPoint X="3" Y="0" TargetSpace="NSS_balise"/>
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
	SIGNALLING
	BALISE - LEGACY / NATIONAL SIGNALLING SYSTEM
=========================================================================================================-->
	<!-- Note: National system balises and ETCS balises (in Scandinavia and in France) use the same -->
	<!-- transmission system - therefore all checks on inter-balise distance must treat them both. -->
	<!-- Legacy system balises transmit either 64=2*(8+3*(4+4)) (net 3*4 bits) telegrams for France and Sweden/Norway, -->
	<!-- or 255 (net 45*4 bits) telegrams for Portugal/Spain/Italy/Finland/Australia/Malaysia. -->
	<ObjectType DataType="tBalise" Class="RailwayPlacedObject" LuaName="rctype_Balise" Name="JBTSA_ATB NSS balise"
				Layer="JBTSA_ATB" Color="ByLayer"
				Group="Signal/Hastighetskontroll/NSS (ATC2)"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>NSS_balise</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>
		
		<Variants DefaultValue="Balise fylt/fast">
			<Variant Name="Fylt/fast">
			</Variant>
			<Variant Name="Fylt/styrt">
			</Variant>
			<Variant Name="Tom/fast">
			</Variant>
			<Variant Name="Tom/styrt">
			</Variant>
		</Variants>

		<CustomProperty DataType="Enumeration" Name="BaliseType" DefaultValue="NSS parallellbalise">
			<Values>
				<Value>NSS parallellbalise</Value>
				<Value>NSS seriebalise, stor</Value>
				<Value>NSS seriebalise, mini</Value>
			</Values>
		</CustomProperty>
				   
		<CustomProperty DataType="String" Name="TextAbove" DisplayName="Tekst over" DefaultValue="" 
			Description="Text above balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC tables 7.1 and 7.2."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
		
		<CustomProperty DataType="String" Name="TextBelow" DisplayName="Tekst under" DefaultValue=""
			Description="Text below  balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC table 7.11."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
	
		<!--Hos BN skal symbolet for første balise i gyldighetsretning være "fylt"-->
		<CustomProperty DataType="Boolean" Name="FirstInGroup" DisplayName="Første i gruppe"
		DotLiquidExpression="
         {% if Variant == 'Fylt/fast' %}True
         {% elsif Variant == 'Fylt/styrt' %}True
         {% elsif Variant == 'Tom/fast' %}False
         {% elsif Variant == 'Tom/styrt' %}False
         {% endif %}"
		 />    

		<!--Styrte baliser skal ha kabel, og BN 2D-symbolet har en strek over seg. TODO Finnes "switchable" allerede i railML for baliseobjektet deres???-->
		<CustomProperty DataType="Boolean" Name="Switchable" DisplayName="Styrt" 
			DotLiquidExpression="
				{% if Variant == 'Fylt/fast' %}False
				{% elsif Variant == 'Fylt/styrt' %}True
				{% elsif Variant == 'Tom/fast' %}False
				{% elsif Variant == 'Tom/styrt' %}True
				{% endif %}"
		 />

		<LuaExpression Name="Geometry3D_0.Name"><Formula>_JBTSA_ATB_Geometry3DName()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_ATB_Geometry3DName()" ReturnType="String"
			Description="Returns the 3D model name for an NSS balise.">
			<Signature>String _JBTSA_ATB_Geometry3DName()</Signature>
			<Formula>
				function _JBTSA_ATB_Geometry3DName()
					local s = "NO-BN-3D-SA-ATB-NSS"
					if BaliseType == "NSS parallellbalise" then s = s.."-PARALLELLBALISE"
					elseif BaliseType == "NSS seriebalise, stor" then s = s.."-SERIEBALISE"
					elseif BaliseType == "NSS seriebalise, mini" then s = s.."-MINIBALISE"
					else return "Unknown BaliseType ["..BaliseType.."].",_warning
					end
					if Variant:lower():match("fast") then s = s.."-FAST"
					elseif Variant:lower():match("styrt") then s = s.."-STYRT"
					else return "Unknown Variant ["..Variant.."].",_warning
					end
					return s, _info(Variant.." "..BaliseType.." balise.")
				end
			</Formula>
		</LuaFunction>

		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToNextBalise" DisplayName="Avstand til neste balise" 
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToPreviousBalise" DisplayName="Avstand til forrige balise"
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackVertically" DisplayName="Avstand til spor i høyden"
			Description="
			&lt; 0.8 m: OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing\n
			0.8-7.0 m: ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise\n
			7.0-8.0 m: WARNING - Outside recommended tolerance - increase vertical track separation or move balise\n
			&gt; 8.0m: OK - A Train in a track above/under us will pass without reading the balise"/>

		<CustomProperty DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackSideways" DisplayName="Avstand til nabospor"
			Description="
			Below 2 m: ERROR – Balise may be read by a train in the neighbouring track – increase distance\n
			2-2.6 m: WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 m from neighbouring track (large balise) resp. 2.3 m (minibalise) – increase distance\n
			Over 2.6 m: OK – Train in neighbouring track will pass without reading the balise"/>
		
		<LuaExpression Name="TextAbove"><Formula>_JBTSA_ATB_TextAbove()</Formula></LuaExpression>
		<LuaExpression Name="TextBelow"><Formula>_JBTSA_ATB_TextBelow()</Formula></LuaExpression>

		<LuaExpression Name="code"><Formula>_JBTSA_ATB_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code:lower():match("unfinished") and code or ""</Formula> </LuaExpression>
		<LuaExpression Name="dir"><Formula>NOBN_sig_getBaliseGroupDirection()</Formula></LuaExpression>
		<LuaExpression Name="LateralOffset"><Formula>RightSided and 0.01 or -0.01</Formula></LuaExpression>

		
		<LuaExpression Name="mc_DistanceToNextBalise" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToNextBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToPreviousBalise" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToPreviousBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackVertically" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackVertically()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackSideways" IsModelCheck="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackSideways()</Formula></LuaExpression>

		<!--TODO Fjerne oppførsel med at balisespissen peker ned (i forhold til current UCS y-akse) ved innsetting, den skal ALLTID peke opp langs UCS-Y -->
		<!--cosisnegative: true hvis kvadrant I eller IV (høyre side av enhetssirkelen)-->
		<InsertPointObject Name="Fylt/fast" DisplayName="Balise fylt/fast" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-FYLT-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>
		
		<InsertPointObject Name="Fylt/styrt" DisplayName="Balise fylt/styrt" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-FYLT-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>
		
		<InsertPointObject Name="Tom/fast" DisplayName="Balise tom/fast" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>
		
		<InsertPointObject Name="Tom/styrt" DisplayName="Balise tom/styrt" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="1e-3">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-FAST-{{SymbolMode}}" AllowSymbolMove="true">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ATB-NSS-BALISE
				{% if Variant == 'Fylt/fast'or Variant == 'Fylt/styrt' %}FYLT
				{% else %}TOM
				{% endif %}
				{% if Variant == 'Fylt/styrt' or Variant == 'Tom/styrt' %}STYRT
				{% else %}FAST
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
			<SymbolAttribute Tag="TEKSTOVER">
				<Value>{{TextAbove}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="TEKSTUNDER">
				<Value>{{TextBelow}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<!-- Metric info -->
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-FAST-Metric" AllowSymbolMove="false">
			<!--Note: cosisnegative (RC built-in filter for DotLiquid) returns 'True' with an uppercase T-->
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ATB-NSS-BALISE
				{% if Variant == 'Fylt/fast'or Variant == 'Fylt/styrt' %}FYLT
				{% else %}TOM
				{% endif %}
				{% if Variant == 'Fylt/styrt' or Variant == 'Tom/styrt' %}STYRT
				{% else %}FAST
				{% endif %}
				Metric
			</BlockNameFormat>
		</SymbolDefinition>

		<Annotation3DTagDefinition>
			<Attribute Tag="T01">
				<Value>{{code}}</Value>
			</Attribute>
		</Annotation3DTagDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="NSS_balisegruppe"/>
				<SnapPoint X="0" Y="0" TargetSpace="NSS_balisegruppe"/>
				<SnapPoint X="3" Y="0" TargetSpace="NSS_balisegruppe"/>
			</SnapPoints>
		</DockPointDefinitions>

</ObjectType>



<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>
