<!--========================================================================================================

    NO-BN-Balises.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml"/>.

	(c) Railcomplete AS, Norway, 2015-2023. All rights reserved.
	
=========================================================================================================-->
<xpp:bloc>



<!--========================================================================================================
	sig - 
	Global Lua formulas for signalling objects (for signals: see other DNA file).
	Domain-specific Lua functions, stored in Global Extension Dictionary (not in each object),
	such that several ObjectType declarations may use theses functions.
=========================================================================================================-->



<!--========================================================================================================
	Signalling - ATP (automatic train protection) - General functions (physically determined) NSS and ETCS
=========================================================================================================-->
    <LuaFunction Name="NOBN_sig_getBaliseGroupDirection()" ReturnType="String"
		Description="Returns the source object balise's balise group direction [up/down/unknown].">
        <Constructor>String NOBN_sig_getBaliseGroupDirection(ObjRef balise = this)</Constructor>
        <Formula>
			function NOBN_sig_getBaliseGroupDirection(balise)
				--TODO: Replace with a function which finds out where the closest cable duct is, and rotates the balise with the cable towards that duct.
				balise = balise or this
				s = balise.RcType:match("ETCS") and rel_EtcsBalise_BelongsTo_EtcsBaliseGroup or rel_NssBalise_BelongsTo_NssBaliseGroup
				r,n = getRelatedObjects(s,balise)
				if n == 0 then
					return "unknown", _info("UNFINISHED - Relate balise with '"..s.."' to a balise group to inherit direction.")
				else
					return r[0].Dir
				end
			end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToPreviousBalise()" ReturnType="String"
		Description="Checks distance to previous balise. Error if too close (2.35) or not far enough (10.5), warning if (2.35 - 2.8) or (3.2 - 3.5) or (10.5 11.8).">
		<Constructor>String NOBN_sig_chkBaliseDistanceToPreviousBalise(ObjRef balise = this)</Constructor>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToPreviousBalise(balise)
				balise = balise or this
				searchDir = "down"
				if balise.Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
				nextBalise = getDownObject(balise.RcType)
				if nextBalise == nil then return "OK - No "..balise.RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
				dist = getDistance(balise,nextBalise)
				t = string.format("%.03f", dist)
			
				if (dist &lt; 2.35 ) then
					return t..": ERROR - Balise magnetic fields may merge - increase distance.",{nextBalise},_error
				elseif (dist &gt;= 2.35 and dist &lt; 2.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt;= 2.8 and dist &lt; 3.2) then
					return t..": OK - The train will treat the balises as belonging to the same group.",{nextBalise},_ok
				elseif (dist &gt;= 3.2 and dist &lt; 3.5) then
					return t..": WARNING - Outside recommended tolerance - decrease distance.",{nextBalise},_warning
				elseif (dist &gt;= 3.5 and dist &lt; 10.5) then
					return t..": ERROR - The train cannot determine which balise group the balise belongs to.",{nextBalise},_error
				elseif (dist &gt;= 10.5 and dist &lt; 11.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt; 11.8) then
					return t..": OK - The train will treat the balises as belonging to different balise groups.",{nextBalise},_ok
				else
					return "ERROR - Bad calculation of distance to neighbour object.",_error,
						_info("DNA error - please notify your DNA agent company - send to support@railcomplete.com.")
				end
			end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToNextBalise()" ReturnType="String"
		Description="Checks distance to next balise. Error if too close (2.35) or not far enough (10.5), warning if (2.35 - 2.8) or (3.2 - 3.5) or (10.5 11.8).">
		<Constructor>String NOBN_sig_chkBaliseDistanceToNextBalise(ObjRef balise = this)</Constructor>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToNextBalise(balise)
				balise = balise or this
				searchDir = "up"
				if balise.Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
				nextBalise = getUpObject(balise.RcType)
				if nextBalise == nil then return "OK - No "..balise.RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
				dist = getDistance(balise,nextBalise)
				t = string.format("%.03f", dist)
			
				if (dist &lt; 2.35 ) then
					return t..": ERROR - Balise magnetic fields may merge - increase distance.",{nextBalise},_error
				elseif (dist &gt;= 2.35 and dist &lt; 2.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt;= 2.8 and dist &lt; 3.2) then
					return t..": OK - The train will treat the balises as belonging to the same group.",{nextBalise},_ok
				elseif (dist &gt;= 3.2 and dist &lt; 3.5) then
					return t..": WARNING - Outside recommended tolerance - decrease distance.",{nextBalise},_warning
				elseif (dist &gt;= 3.5 and dist &lt; 10.5) then
					return t..": ERROR - The train cannot determine which balise group the balise belongs to.",{nextBalise},_error
				elseif (dist &gt;= 10.5 and dist &lt; 11.8) then
					return t..": WARNING - Outside recommended tolerance - increase distance.",{nextBalise},_warning
				elseif (dist &gt; 11.8) then
					return t..": OK - The train will treat the balises as belonging to different balise groups.",{nextBalise},_ok
				else
					return "ERROR - Bad calculation of distance to neighbour object.",_error,
						_info("DNA error - please notify your DNA agent company - send to support@railcomplete.com.")
				end
			end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToTrackVertically()" ReturnType="String"
		Description="Checks vertical distance to track above or below balise.">
		<Constructor>String NOBN_sig_chkBaliseDistanceToTrackVertically(ObjRef balise = this)</Constructor>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToTrackVertically(balise)
				balise = balise or this
				if (balise.Alignment == nil) then return "UNFINISHED - Missing own alignment.",_error end
				closestTracks = getClosestTracks(balise,rctype_Track)
				nearestId = ""
				nearestDist = math.huge
				i = 0
				while (closestTracks[i]) do
					local aId = closestTracks[i].id
					local sDist = math.abs(getAlignmentInfo(balise,aId).DistanceToAlignment)
					if (balise.Alignment.id ~= aId and sDist &lt; nearestDist) then
						nearestId = aId
						nearestDist = sDist
					else
						i = i + 1
					end
				end
				-- Consider only other alignments being no more than 5 meter sideways apart from balise 
				if (nearestDist &gt; 3.0) then return "OK - No conflicting tracks within 3 meters sideways.",_ok end
				hDiff = math.abs(getAlignmentInfo(balise).Elevation - getAlignmentInfo(balise,nearestId).Elevation)
				if (hDiff &lt;= 0.8) then
					-- Assume that closest other track is part of a point or crossing, but still accept 80 cm difference for diverging track profiles
					return string.format("%.3f",hDiff)..": OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing.",_ok
				elseif (hDiff &gt; 0.8 and hDiff &lt;= 7.0) then 
					return string.format("%.3f",hDiff)..": ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise.",_error
				elseif (distance &lt;= 8.0) then 
					return string.format("%.3f",hDiff)..": WARNING - Outside recommended tolerance - increase vertical track separation or move balise.",_warning
				else 
					return string.format("%.3f",hDiff)..": OK - A Train in a track above/under us will pass without reading the balise.",_ok 
				end
			end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToTrackSideways()" ReturnType="String"
		Description="Checks distance from balise to neighbour tracks">
		<Constructor>String NOBN_sig_chkBaliseDistanceToTrackSideways(ObjRef balise = this)</Constructor>
		<Formula>
			function NOBN_sig_chkBaliseDistanceToTrackSideways(balise)
				balise = balise or this
				if (balise.Alignment == nil) then return "UNFINISHED - Missing own alignment.",_error end
				closestTracks = getClosestTracks(balise,rctype_Track)
				nearestId = ""
				i = 0
				while (closestTracks[i]) do
					if (balise.Alignment.id ~= closestTracks[i].id) then
						nearestId = closestTracks[i].id
						break
					else
						i = i+1
					end
				end
				if (nearestId == "") then return "OK - No neighbouring track(s).",_ok end
				sDist = math.abs(getAlignmentInfo(balise,nearestId).DistanceToAlignment)
				if RC__isNan(sDist) then return "No sideways distance found.", _noSymbol end
				if (sDist &lt; 1.4) then 
					return string.format("%.3f",sDist)..": ERROR – Balise may be read by a train in a neighbouring track – increase distance.",_error
				elseif (sDist &lt; 2.0) then 
					return string.format("%.3f",sDist)..": WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 meter from neighbouring track (large balise) resp. 2.3 meter (minibalise) – increase distance.",_warning
				else
					return string.format("%.3f",sDist)..": OK – a Train in neighbouring track will pass without reading the balise.",_ok
				end
			end
		</Formula>
	</LuaFunction>



<!--========================================================================================================
	Signalling - ATP (automatic train protection) - ETCS
=========================================================================================================-->
	<LuaFunction Name="_JBTSA_ETC_code()" ReturnType="String" 
		Description="Returns the ETCS balise group's code property.">
		<Constructor>String _JBTSA_ETC_code()</Constructor>
		<Formula>
			function _JBTSA_ETC_code()
				return "TODO: _JBTSA_ETC_code()"
			end
		</Formula>
	</LuaFunction> 



	<LuaFunction Name="_JBTSA_ETB_code()" ReturnType="String" 
		Description="Returns the number 0..N-1 of the ETCS balise within its ETCS balise group.">
		<Constructor>String _JBTSA_ETB_code()</Constructor>
		<Formula>
			function _JBTSA_ETB_code()
				--TODO
				return "TODO: _JBTSA_ETB_code()"
			end 
		</Formula>
	</LuaFunction>


	
	<LuaFunction Name="_JBTSA_ETB_TextAbove()" ReturnType="String"
		Description="Returns text above the ETCS balise 2D symbol.">
		<!-- Description="Returns text over the ETCS balise 2D symbol."> -->
		<Constructor>String _JBTSA_ETB_TextAbove()</Constructor>
		<Formula>
			function _JBTSA_ETB_TextAbove()
				return "TODO: _JBTSA_ETB_TextAbove()"
			end
		</Formula>
	</LuaFunction>
	
	
	
	<LuaFunction Name="_JBTSA_ETB_TextBelow()" ReturnType="String"
		Description="Returns text below the ETCS balise 2D symbol.">
		<Constructor>String _JBTSA_ETB_TextBelow()</Constructor>
		<Formula>
			function _JBTSA_ETB_TextBelow()
				return "TODO: _JBTSA_ETB_TextBelow()"
			end
		</Formula>
	</LuaFunction>



<!--========================================================================================================
	Signalling - ATP (automatic train protection) - NSS
=========================================================================================================-->
    <LuaFunction Name="_JBTSA_ATC_code()" ReturnType="String" 
		Description="Returns balise group object ID (7 chars) (Ref Signal-Prosj-ATC-7.11-Baliseidentitet).">
        <Constructor>String _JBTSA_ATC_code()</Constructor>
        <Formula>
			function _JBTSA_ATC_code()
				if Variant == "Hastighetsbalisegruppe" then
					a = "-H"
				elseif Variant == "Signalhøyningsbalisegruppe" then
					a = "-S"
				elseif Variant == "Grensebalisegruppe" then
					a = "-G"
				elseif Variant == "Lenkingsbalisegruppe" then
					a = "-L"
				elseif Variant == "Sporvekselbalisegruppe" then
					a = "-V"
				elseif Variant == "Hovedsignalbalisegruppe" then 
					a = "_"
				elseif Variant == "Forsignalbalisegruppe" then
					a = "F"
				elseif Variant == "Repeterbalisegruppe" then
					local s = rel_NssBaliseGroup_AppliesTo_Object
					local r,n = getRelatedObjects(s)
					if n == 0 then
						-- Balise group has no relation to a signal yet:
						return "UNFINISHED - Relate with '"..s.."'."
					else
						sig = r[0] --should be a signal here, repeater groups don't repeat switches directly
						bg = getRelatedObjects(rel_Object_Has_NssBaliseGroup,sig)
						bg = bg:filter(function (x) return x.Variant == "Repeterbalisegruppe" end)
						nbg = getCollectionLength(bg)

						if nbg == 0 then
							--I am here, so n *must* be greater than zero:
							return "Should not happen - bad relation loop." 

						elseif nbg == 1 then
							-- I am the only repeater group:
							a = "R"

						elseif nbg == 2 then
							-- Assign 'R' to the one farthest away, 'U' to the one closest to signal: 
							b1 = bg[0]
							b2 = bg[1]
							if getDistance(b1,sig) &lt; getDistance(b2,sig) then
								b1,b2 = b2,b1
								--Now b1 is the first repeater group in the driving direction
							end
							if this.id == b1.id then
								--I am the closest repeater group:
								a = "U"
							else
								--I am the farthest repeater group:
								a = "R"
							end

						elseif nbg == 3 then
							-- Assign 'R' to the one farthest away, then 'U' and then 'V' to the one closest to signal:
							b1 = bg[0]
							b2 = bg[1]
							b3 = bg[2]
							--Bubble sort, n=3
							if getDistance(b1,sig) &lt; getDistance(b2,sig) then b1,b2 = b2,b1 end	-- Pass 1
							if getDistance(b2,sig) &lt; getDistance(b3,sig) then b2,b3 = b3,b2 end	-- Pass 1
							if getDistance(b1,sig) &lt; getDistance(b2,sig) then b1,b2 = b2,b1 end	-- Pass 2
							if this.id == b1.id then
								--I am the first repeater group in the driving direction:
								a = "R"
							elseif this.id == b2.id then
								--I am the middle repeater group:
								a = "U"
							else 
								a = "V"
							end

						elseif nbg == 3 then
							-- Assign 'R' to the one farthest away, then 'U', 'V' and then 'W' to the one closest to signal:
							b1 = bg[0]
							b2 = bg[1]
							b3 = bg[2]
							b4 = bg[3]
							--Bubble sort, n=4
							if getDistance(b1,sig) &lt; getDistance(b2,sig) then b1,b2 = b2,b1 end	-- Pass 1
							if getDistance(b2,sig) &lt; getDistance(b3,sig) then b2,b3 = b3,b2 end	-- Pass 1
							if getDistance(b3,sig) &lt; getDistance(b4,sig) then b3,b4 = b4,b3 end	-- Pass 1
							if getDistance(b1,sig) &lt; getDistance(b2,sig) then b1,b2 = b2,b1 end	-- Pass 2
							if getDistance(b2,sig) &lt; getDistance(b3,sig) then b2,b3 = b3,b2 end	-- Pass 2
							if getDistance(b1,sig) &lt; getDistance(b2,sig) then b1,b2 = b2,b1 end	-- Pass 3
							if this.id == b1.id then
								--I am the first repeater group in the driving direction:
								a = "R"
							elseif this.id == b2.id then
								--I am the second repeater group in the driving direction:
								a = "U"
							elseif this.id == b3.id then
								--I am the third repeater group in the driving direction:
								a = "V"
							else --this.id == b4.id
								--I am the fourth and last repeater group in the driving direction, closest to the signal:
								a = "W"
							end
						end
					end
				end
				ocpMsg = "Create an Operation / Control Point (OCP) area around your object and refresh it to replace '???' with the relevant OCP's codes."
				if Variant == "Hastighetsbalisegruppe" then
					r,n = getRelatedObjects(rel_NssBaliseGroup_HasBrakingCurveTargetIn_NssBaliseGroup)
					if n == 0 then
						--Group is braking curve target:
						ocp = NOBN_com_getOcpCode(getObjectFromId(id))
					else
						--Warning board, use target's ocp:
						ocp = NOBN_com_getOcpCode(r[0])
					end
					return ocp..a..string.format("%02d",seq)
				elseif Variant == "Signalhøyningsbalisegruppe" or Variant == "Sporvekselbalisegruppe" then
					ocp = NOBN_com_getOcpCode(this)
					if seq == 0 then
						return ocp..a.."UNFINISHED - Set balise group's 'seq' property to the required balise group number (01..99), use '100' for '0'."
					else
						return ocp..a..string.format("%02d",seq%100)
					end
				elseif Variant =="Lenkingsbalisegruppe" or Variant == "Grensebalisegruppe" then
					s = rel_NssBaliseGroup_LinksTo_NssBaliseGroup
					r,n = getRelatedObjects(s)
					if n == 0 then
						ocp = NOBN_com_getOcpCode(getObjectFromId(id))
					else
						ocp = NOBN_com_getOcpCode(r[0])
					end
					if seq == 0 then
						return ocp..a.."UNFINISHED - Set balise group's 'seq' property to the required balise group number (01..99), use '100' for '0'."
					else
						return ocp..a..string.format("%02d",seq%100)
					end
				else
					s = rel_NssBaliseGroup_AppliesTo_Object
					r,n = getRelatedObjects(s)
					if n == 0 then
						return "UNFINISHED - Relate with '"..s.."'."
					else
						--Assume r[0] holds object dictating the group's number:
						ocp = NOBN_com_getOcpCode(r[0])
						if r[0].code == nil then 
							return ocp..a.."???", _info(ocpMsg)
						elseif tostring(r[0].code):match("%d+") == nil then
							return ocp..a.."???", _info(ocpMsg)
						else
							return ocp..a..tostring(r[0].code):match("%d+"):sub(-3) 
						end 
					end
					return ocp..a..code:match("%d+"):sub(-3)
				end
			end
        </Formula>
    </LuaFunction> 

	
	
    <LuaFunction Name="_JBTSA_ATB_code()" ReturnType="String" 
		Description="Returns balise object Id (8 chars) from the 7-char balise group ID and the P/A/B/C balise type (Ref Signal-Prosj-ATC-7.11-Baliseidentitet).">
        <Constructor>String _JBTSA_ATB_code()</Constructor>
        <Formula>
			function _JBTSA_ATB_code()
				s = rel_NssBalise_BelongsTo_NssBaliseGroup
				r,n = getRelatedObjects(s)
				if n == 0 then  
					return "UNFINISHED - Relate with '"..s.."' to balise group.",
							_info("Balises derive their ID (code property) from their balise group's code, direction, and the balise's relative position within the balise group. The 'A' balise must be related to the balise group using the relation for position defining balise.")
				else
					bg = r[0]
				end
				if bg.dir ~= "up" and bg.dir ~= "down" then 
					return "Bad direction ["..bg.dir.."]",_warning 
				end
				
				sq = rel_NssBaliseGroup_HasPositionDeterminedBy_NssBalise
				q,nq = getRelatedObjects(sq,bg)
				if nq == 0 then 
					return "UNFINISHED - No A-balise in balise group - relate to balise group with '"..sq.."'."
				else
					Abalise = q[0]
					qq,nqq = getRelatedObjects(rel_NssBalise_DeterminesPositionFor_NssBaliseGroup)
					isA = (nqq == 1) --it's me...
					siblings,nsiblings = getRelatedObjects(rel_NssBaliseGroup_Contains_NssBalise,bg)
				end
			
				if isA == true then
					suffix = "A"
				else
					if nsiblings == 2 then
						suffix = "B"            
					elseif nsiblings &gt; 2 then
						Pbalise={id=0, diff=math.huge}
						Bbalise={id=0, diff=math.huge}
						Cbalise={id=0, diff=math.huge}
						for i = 0, nsiblings-1 do
							diff = (bg.dir == "up") and (siblings[i].ReferenceMileage - Abalise.ReferenceMileage) or (Abalise.ReferenceMileage - siblings[i].ReferenceMileage)
							if (diff &lt; 0) then
								if Pbalise.id == 0 then
									Pbalise.id = siblings[i].id
									Pbalise.diff = diff
								elseif Pbalise.diff &gt; diff then
									Pbalise.id = siblings[i].id
									Pbalise.diff = diff
								end                
							elseif (diff &gt; 0) then
								if Bbalise.id == 0 then
									Bbalise.id = siblings[i].id
									Bbalise.diff = diff
								elseif Bbalise.diff &gt; diff then
									Cbalise.id = Bbalise.id
									Cbalise.diff = Bbalise.diff
									Bbalise.id = siblings[i].id
									Bbalise.diff = diff                    
								elseif Cbalise.diff &gt; diff then
									Cbalise.id = siblings[i].id
									Cbalise.diff = diff                    
								end                        
							else
								--diff==0: Do nothing
							end
						end    
						if this.id == Bbalise.id then 
							suffix = "B"
						elseif this.id == Cbalise.id then
							suffix = "C"
						elseif this.id == Pbalise.id then
							suffix = "P"
						else
							suffix = "WARNING - Bad balise group configuration - cannot determine PABC type.",_warning
						end
					end
				end
				groupId = RC__identify(bg)
				return groupId:sub(1,2):lower():match("unfinished") and suffix or groupId..suffix
			end 
		</Formula>
     </LuaFunction>

	 
	 
    <LuaFunction Name="_JBTSA_ATB_TextAbove()" ReturnType="String"
		Description="Returns text over the NSS balise 2D symbol (Ref Signal-Prosj.-ATC-7.1/7.2-Enkeltrettede/Dobbeltrettede balisegrupper).">
        <Constructor>String _JBTSA_ATB_TextAbove()</Constructor>
        <Formula>
			function _JBTSA_ATB_TextAbove()
				s = rel_NssBalise_BelongsTo_NssBaliseGroup
				r,n = getRelatedObjects(s)
				if n == 0 then
					return "UNFINISHED - Relate with '"..s.."' to NSS balise group."
				else
					bg = r[0]
					t = code:sub(-1)
					if bg.Variant == "Hastighetsbalisegruppe" then
						if t == "A" then
							return "H"
						elseif t == "B" then
							if Variant:lower():match("fylt") then
								return "H"
							else
								return ""
							end
						elseif t == "C" then
							return ""
						else
							return "?",_warning, _info("WARNING - Cannot determine text above balise symbol (balise is neither A, B or C balise).")
						end
					elseif bg.Variant == "ET-balisegruppe" then
						if t == "A" then
							return "EH"
						elseif t == "B" then
							if Variant:lower():match("fylt") then
								return "EH"
							else
								return ""
							end
						elseif t == "C" then
							return ""
						else
							return "?",_warning, _info("WARNING - Cannot determine text above balise symbol (balise is neither A, B or C balise).")
						end
					elseif code:sub(-1) == "P" then
						return "P"
					else
						return ""
					end
				end
			end
		</Formula>
     </LuaFunction>


	 
    <LuaFunction Name="_JBTSA_ATB_TextBelow()" ReturnType="String"
		Description="Returns text below the NSS balise 2D symbol (Ref Signal-Prosj.-ATC-7.1/7.2-Enkeltrettede/Dobbeltrettede balisegrupper).">
        <Constructor>String _JBTSA_ATB_TextBelow()</Constructor>
        <Formula>
			function _JBTSA_ATB_TextBelow()
				r,n = getRelatedObjects(rel_EtcsBalise_DeterminesPositionFor_EtcsBaliseGroup)
				if n &gt; then
					return RC__identify(r[0])
				else
					return ""
				end
			end
		</Formula>
     </LuaFunction>

	 
	 
<!--========================================================================================================
	SIGNALLING
	BALISE GROUP - ETCS
=========================================================================================================-->
	<!-- Balisegruppen kan kobles til signal(er), sporveksel(ler), radioområder, RBC-områder, sikringsanleggområder,  -->
	<!-- stasjonsområder osv o.a.  -->
	<!-- Noen tilkobinger arver posisjon fra sin forelder (signal), andre ikke (sporveksel, annen balisegruppe). -->
	<!-- Lenkingsgrupper: Kobles til annen balisegruppe. -->
	<!-- Signaler og forsignaler, evt dvergsignaler, fiktive osv: Balisegruppen kobles til signalet. -->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" EulynxDataType="EULYNX.sig.EtcsBaliseGroup" LuaName="rctype_EtcsBaliseGroup" Name="JBTSA_ETC ETCS balisegruppe" 
				Layer="JBTSA_ETC" Color="ByLayer"
				Group="Signal/Hastighetskontroll/ETCS"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>ETCS_balisegruppe</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>

		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT"/>

		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>


		<xpp:expand select="NOBN_com_PSET_ISY_STK"/>
		<xpp:expand select="NOBN_com_PSET_BANE_NOR"/>
		<xpp:expand select="NOBN_com_PSET_TITTELFELT"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA"/>
<!-- TODO: Missing Pset for Banedata - ETCS balise group		 -->
		
		<xpp:expand select="NOBN_eulynx_INITIALIZE"/>
		<xpp:expand select="NOBN_eulynx_ETCS_BALISE_GROUP"/>
		
		<LuaExpression Name="IsyPostnotat"><Formula>name</Formula></LuaExpression> 

		<Variants DefaultValue="ETCS L2 balisegruppe, enkel">
			<Variant Name="ETCS L2 balisegruppe, enkel"/>
			<Variant Name="ETCS L2 balisegruppe, dobbel"/>
		</Variants>

		<LuaExpression Name="code"><Formula>_JBTSA_ETC_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code</Formula></LuaExpression>
		<LuaExpression Name="BaneNORBeskrivelse"><Formula>Variant</Formula></LuaExpression>

		<InsertPointObject VariantName="ETCS L2 balisegruppe, enkel" DisplayBlockName="NO-BN-2D-JBTSA_ETC-ETCS-BALISEGRUPPE-ENKEL-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true"/> 
		</InsertPointObject>

		<InsertPointObject VariantName="ETCS L2 balisegruppe, dobbel" DisplayBlockName="NO-BN-2D-JBTSA_ETC-ETCS-BALISEGRUPPE-DOBBEL-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true"/> 
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="" AllowSymbolMove="true">
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}"/>	
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ETC-ETCS-BALISEGRUPPE
				{% if Variant contains "enkel" %}ENKEL
				{% elsif Variant contains "dobbel" %}DOBBEL
				{% else %}BAD_Variant_{{Variant}}
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="ETCS_balise"/>
				<SnapPoint X="0" Y="0" TargetSpace="ETCS_balise"/>
				<SnapPoint X="3" Y="0" TargetSpace="ETCS_balise"/>
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
	SIGNALLING
	BALISE - ETCS
=========================================================================================================-->
	<ObjectType DataType="tBalise" Class="RailwayPlacedObject" EulynxDataType="EULYNX.sig.EtcsBalise" LuaName="rctype_EtcsBalise" Name="JBTSA_ETB ETCS balise"
				Layer="JBTSA_ETB" Color="ByLayer"
				Group="Signal/Hastighetskontroll/ETCS"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>ETCS_balise</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>
		
		<!-- Bruke code ikke name siden baliser ikke har tekst som vises i tegningen (vanligvis) -->
		<xpp:expand select="NOBN_com_PSET_ISY_STK"/>
		<xpp:expand select="NOBN_com_PSET_BANE_NOR"/>
		<xpp:expand select="NOBN_com_PSET_TITTELFELT"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA_SA_ATB"/>

		<xpp:expand select="NOBN_eulynx_INITIALIZE"/>
		<xpp:expand select="NOBN_eulynx_ETCS_BALISE"/>
		
		<LuaExpression Name="IsyPostnotat"><Formula>code</Formula></LuaExpression> 

		<Variants DefaultValue="ETCS-balise, fast">
			<Variant Name="ETCS-balise, fast">
			</Variant>
			<Variant Name="ETCS-balise, styrt">
			</Variant>
		</Variants>

		<CustomAttribute DataType="Enumeration" Name="Balisetype" DefaultValue="ETCS Eurobalise">
			<Values>
				<Value>ETCS Eurobalise</Value>
			</Values>
		</CustomAttribute>
				   
		<CustomAttribute DataType="String" Name="TextAbove" DisplayName="Tekst over" DefaultValue="" 
			Description="Text above balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC tables 7.1 and 7.2."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
		<LuaExpression Name="TextAbove"><Formula>_JBTSA_ETB_TextAbove()</Formula></LuaExpression>
		
		<CustomAttribute DataType="String" Name="TextBelow" DisplayName="Tekst under" DefaultValue=""
			Description="Returns Text below  balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC table 7.11."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
		<LuaExpression Name="TextBelow"><Formula>_JBTSA_ETB_TextBelow()</Formula></LuaExpression>
	
		<LuaExpression Name="Geometry3D_0.Name"><Formula>_JBTSA_ETB_Geometry3DName()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_ETB_Geometry3DName()" ReturnType="String"
			Description="Returns the 3D model name for an ETCS balise.">
			<Constructor>String _JBTSA_ETB_Geometry3DName()</Constructor>
			<Formula>
				function _JBTSA_ETB_Geometry3DName()
					s = "NO-BN-3D-SA-ETB-ETCS"
					if BaliseType == "ETCS Eurobalise" then s = s.."-EUROBALISE"
					else return "Unknown BaliseType ["..BaliseType.."].",_warning
					end
					if Variant:lower():match("fast") then s = s.."-FAST"
					elseif Variant:lower():match("styrt") then s = s.."-STYRT"
					else return "Unknown Variant ["..Variant.."].",_warning
					end
					return s, _info(Variant.." "..BaliseType.." balise.")
				end
			</Formula>
		</LuaFunction>

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToNextBalise" DisplayName="Avstand til neste balise" 
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToPreviousBalise" DisplayName="Avstand til forrige balise"
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackVertically" DisplayName="Avstand til spor i høyden"
			Description="
			&lt; 0.8 m: OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing\n
			0.8-7.0 m: ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise\n
			7.0-8.0 m: WARNING - Outside recommended tolerance - increase vertical track separation or move balise\n
			&gt; 8.0m: OK - A Train in a track above/under us will pass without reading the balise"/>

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackSideways" DisplayName="Avstand til nabospor"
			Description="
			Below 2 m: ERROR – Balise may be read by a train in the neighbouring track – increase distance\n
			2-2.6 m: WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 m from neighbouring track (large balise) resp. 2.3 m (minibalise) – increase distance\n
			Over 2.6 m: OK – Train in neighbouring track will pass without reading the balise"/>
		
		<LuaExpression Name="code"><Formula>_JBTSA_ETB_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code:lower():match("unfinished") and code or ""</Formula> </LuaExpression>
		<LuaExpression Name="dir"><Formula>NOBN_sig_getBaliseGroupDirection()</Formula></LuaExpression>
		<LuaExpression Name="DistanceToAlignment"><Formula>RightSided and 0.01 or -0.01</Formula></LuaExpression>
		
		<LuaExpression Name="mc_DistanceToPreviousBalise" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToPreviousBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToNextBalise" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToNextBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackVertically" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackVertically()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackSideways" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackSideways()</Formula></LuaExpression>
			
		<InsertPointObject VariantName="ETCS-balise, fast" DisplayBlockName="NO-BN-2D-JBTSA_ETB-ETCS-BALISE-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>
		
		<InsertPointObject VariantName="ETCS-balise, styrt" DisplayBlockName="NO-BN-2D-JBTSA_ETB-ETCS-BALISE-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="" AllowSymbolMove="true">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ETB-ETCS-BALISE
				{% if Variant contains 'fast' %}FAST
				{% elsif Variant contains 'styrt' %}STYRT
				{% else %}BAD_Variant_{{Variant}}
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
			<SymbolAttribute Tag="TEKSTOVER">
				<Value>{{TextAbove}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="TEKSTUNDER">
				<Value>{{TextBelow}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="" AllowSymbolMove="false">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ETB-ETCS-BALISE
				{% if Variant contains 'fast' %}FAST
				{% elsif Variant contains 'styrt' %}STYRT
				{% else %}BAD_Variant_{{Variant}}
				{% endif %}
				Metric
			</BlockNameFormat>
		</SymbolDefinition>

		<Annotation3DTagDefinition>
			<Attribute Tag="T01">
				<Value>{{code}}</Value>
			</Attribute>
		</Annotation3DTagDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="ETCS_balisegruppe"/>
				<SnapPoint X="0" Y="0" TargetSpace="ETCS_balisegruppe"/>
				<SnapPoint X="3" Y="0" TargetSpace="ETCS_balisegruppe"/>
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
	SIGNALLING
	BALISE GROUP - LEGACY / NATIONAL SIGNALLING SYSTEM
=========================================================================================================-->
	<!-- Balisegruppen kan kobles til signal(er), sporveksel(ler), radioområder, RBC-områder, sikringsanleggområder,  -->
	<!-- stasjonsområder osv o.a.  -->
	<!-- Noen tilkobinger arver posisjon fra sin forelder (signal), andre ikke (sporveksel, annen balisegruppe). -->
	<!-- Lenkingsgrupper: Kobles til annen balisegruppe. -->
	<!-- Signaler og forsignaler, evt dvergsignaler, fiktive osv: Balisegruppen kobles til signalet. -->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" EulynxDataType="EULYNX.sig.BaliseGroup" LuaName="rctype_BaliseGroup" Name="JBTSA_ATC NSS balisegruppe" 
				Layer="JBTSA_ATC" Color="ByLayer"
				Group="Signal/Hastighetskontroll/NSS (ATC2)"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>NSS_balisegruppe</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>
		<xpp:expand select="NOBN_com_PSET_BANE_NOR"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA"/>
		<xpp:expand select="NOBN_com_PSET_ISY_STK"/>
		<xpp:expand select="NOBN_com_PSET_TITTELFELT"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA_SA_ATC"/>
		
		<xpp:expand select="NOBN_eulynx_INITIALIZE"/>
		<xpp:expand select="NOBN_eulynx_BALISE_GROUP"/>
		<!-- Fiktivt objekt - ikke ISY beskrivelse -->

		<!-- TODO: Inkluder alle disse properties for å kunne generere kodetabeller automatisk -->
		<!--	
		<CustomAttribute DataType="String" Name="Retning" DisplayName="Retning" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Sign_Type" DisplayName="Sign_Type" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="BaliseID" DisplayName="BaliseID" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Signalbilde_1H" DisplayName="Signal_1H" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Signalbilde_1F2H" DisplayName="Signalbilde_1F2H" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Signalbilde_2F" DisplayName="Signalbilde_2F" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Kjørhastighet" DisplayName="Kjørhastighet" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Venthastighet" DisplayName="Venthastighet" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="P-avstand" DisplayName="P-avstand" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="B-avstand" DisplayName="B-avstand" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Fall" DisplayName="Fall" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Frislipphastighet" DisplayName="Frislipphastighet" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="MotrettetType" DisplayName="MotrettetType" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="MotrettetHastighet" DisplayName="MotrettetHastighet" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Togveier" DisplayName="Togveier" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Pxyz" DisplayName="Pxyz" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Axyz" DisplayName="Axyz" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Bxyz" DisplayName="Bxyz" DefaultValue=""/>
		<CustomAttribute DataType="String" Name="Cxyz" DisplayName="Cxyz" DefaultValue=""/>
		-->
		<Variants DefaultValue="Hovedsignalbalisegruppe">
			<Variant Name="Hovedsignalbalisegruppe"/>
			<Variant Name="Forsignalbalisegruppe"/>
			<Variant Name="Repeterbalisegruppe"/>
			<Variant Name="Sporvekselbalisegruppe"/>
			<Variant Name="Hastighetsbalisegruppe"/>
			<Variant Name="Lenkingsbalisegruppe"/>
			<Variant Name="Signalhøyningsbalisegruppe"/>
			<Variant Name="ET-balisegruppe"/>
			<Variant Name="Grensebalisegruppe"/>
			<Variant Name="Radioområdebalisegruppe"/>
			<Variant Name="Diversebalisegruppe"/>
		</Variants>

		<LuaExpression Name="code"><Formula>_JBTSA_ATC_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code</Formula></LuaExpression>
		<LuaExpression Name="BaneNORBeskrivelse"><Formula>Variant</Formula></LuaExpression>

		<!--Hovedsignal alene og kombinertsignal (Hs+Fs) balisegruppe-->
		<InsertPointObject VariantName="Hovedsignalbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Forsignalbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Repeterbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Sporvekselbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Hastighetsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Lenkingsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Signalhøyningsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="ET-balisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Grensebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Radioområdebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Diversebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATC-NSS-BALISEGRUPPE-STANDARD-{{SymbolMode}}" AllowSymbolMove="true">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

			<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="NSS_balise"/>
				<SnapPoint X="0" Y="0" TargetSpace="NSS_balise"/>
				<SnapPoint X="3" Y="0" TargetSpace="NSS_balise"/>
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
	SIGNALLING
	BALISE - LEGACY / NATIONAL SIGNALLING SYSTEM
=========================================================================================================-->
	<!-- Note: National system balises and ETCS balises (in Scandinavia and in France) use the same -->
	<!-- transmission system - therefore all checks on inter-balise distance must treat them both. -->
	<!-- Legacy system balises transmit either 64=2*(8+3*(4+4)) (net 3*4 bits) telegrams for France and Sweden/Norway, -->
	<!-- or 255 (net 45*4 bits) telegrams for Portugal/Spain/Italy/Finland/Australia/Malaysia. -->
	<ObjectType DataType="tBalise" Class="RailwayPlacedObject" EulynxDataType="EULYNX.sig.Balise" LuaName="rctype_Balise" Name="JBTSA_ATB NSS balise"
				Layer="JBTSA_ATB" Color="ByLayer"
				Group="Signal/Hastighetskontroll/NSS (ATC2)"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>NSS_balise</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED"/> -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___SYMBOLFRAME"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/>
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___SIG"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___SIG"/>
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS"/>
		<xpp:expand select="NOBN_com_SET_OCP_STATION_REFERENCE"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT"/>
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>
		
		<!-- Bruke code ikke name siden baliser ikke har tekst som vises i tegningen (vanligvis) -->
		<xpp:expand select="NOBN_com_PSET_ISY_STK"/>
		<xpp:expand select="NOBN_com_PSET_BANE_NOR"/>
		<xpp:expand select="NOBN_com_PSET_TITTELFELT"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA_SA_ATB"/>
		<xpp:expand select="NOBN_eulynx_INITIALIZE"/>
		<xpp:expand select="NOBN_eulynx_BALISE"/>

		<LuaExpression Name="IsyPostnotat"><Formula>code</Formula></LuaExpression> 

		<Variants DefaultValue="Balise fylt/fast">
			<Variant Name="Fylt/fast">
			</Variant>
			<Variant Name="Fylt/styrt">
			</Variant>
			<Variant Name="Tom/fast">
			</Variant>
			<Variant Name="Tom/styrt">
			</Variant>
		</Variants>

		<CustomAttribute DataType="Enumeration" Name="BaliseType" DefaultValue="NSS parallellbalise">
			<Values>
				<Value>NSS parallellbalise</Value>
				<Value>NSS seriebalise, stor</Value>
				<Value>NSS seriebalise, mini</Value>
			</Values>
		</CustomAttribute>
				   
		<CustomAttribute DataType="String" Name="TextAbove" DisplayName="Tekst over" DefaultValue="" 
			Description="Text above balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC tables 7.1 and 7.2."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
		
		<CustomAttribute DataType="String" Name="TextBelow" DisplayName="Tekst under" DefaultValue=""
			Description="Text below  balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC table 7.11."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false"/>
	
		<!--Hos BN skal symbolet for første balise i gyldighetsretning være "fylt"-->
		<CustomAttribute DataType="Boolean" Name="FirstInGroup" DisplayName="Første i gruppe"
		DotLiquidExpression="
         {% if Variant == 'Fylt/fast' %}True
         {% elsif Variant == 'Fylt/styrt' %}True
         {% elsif Variant == 'Tom/fast' %}False
         {% elsif Variant == 'Tom/styrt' %}False
         {% endif %}"
		 />    

		<!--Styrte baliser skal ha kabel, og BN 2D-symbolet har en strek over seg. TODO Finnes "switchable" allerede i railML for baliseobjektet deres???-->
		<CustomAttribute DataType="Boolean" Name="Switchable" DisplayName="Styrt" 
			DotLiquidExpression="
				{% if Variant == 'Fylt/fast' %}False
				{% elsif Variant == 'Fylt/styrt' %}True
				{% elsif Variant == 'Tom/fast' %}False
				{% elsif Variant == 'Tom/styrt' %}True
				{% endif %}"
		 />

		<LuaExpression Name="Geometry3D_0.Name"><Formula>_JBTSA_ATB_Geometry3DName()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_ATB_Geometry3DName()" ReturnType="String"
			Description="Returns the 3D model name for an NSS balise.">
			<Constructor>String _JBTSA_ATB_Geometry3DName()</Constructor>
			<Formula>
				function _JBTSA_ATB_Geometry3DName()
					s = "NO-BN-3D-SA-ATB-NSS"
					if BaliseType == "NSS parallellbalise" then s = s.."-PARALLELLBALISE"
					elseif BaliseType == "NSS seriebalise, stor" then s = s.."-SERIEBALISE"
					elseif BaliseType == "NSS seriebalise, mini" then s = s.."-MINIBALISE"
					else return "Unknown BaliseType ["..BaliseType.."].",_warning
					end
					if Variant:lower():match("fast") then s = s.."-FAST"
					elseif Variant:lower():match("styrt") then s = s.."-STYRT"
					else return "Unknown Variant ["..Variant.."].",_warning
					end
					return s, _info(Variant.." "..BaliseType.." balise.")
				end
			</Formula>
		</LuaFunction>

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToNextBalise" DisplayName="Avstand til neste balise" 
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToPreviousBalise" DisplayName="Avstand til forrige balise"
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups"/>
			
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackVertically" DisplayName="Avstand til spor i høyden"
			Description="
			&lt; 0.8 m: OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing\n
			0.8-7.0 m: ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise\n
			7.0-8.0 m: WARNING - Outside recommended tolerance - increase vertical track separation or move balise\n
			&gt; 8.0m: OK - A Train in a track above/under us will pass without reading the balise"/>

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackSideways" DisplayName="Avstand til nabospor"
			Description="
			Below 2 m: ERROR – Balise may be read by a train in the neighbouring track – increase distance\n
			2-2.6 m: WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 m from neighbouring track (large balise) resp. 2.3 m (minibalise) – increase distance\n
			Over 2.6 m: OK – Train in neighbouring track will pass without reading the balise"/>
		
		<LuaExpression Name="TextAbove"><Formula>_JBTSA_ATB_TextAbove()</Formula></LuaExpression>
		<LuaExpression Name="TextBelow"><Formula>_JBTSA_ATB_TextBelow()</Formula></LuaExpression>

		<LuaExpression Name="code"><Formula>_JBTSA_ATB_code()</Formula></LuaExpression>
		<LuaExpression Name="name"><Formula>code:lower():match("unfinished") and code or ""</Formula> </LuaExpression>
		<LuaExpression Name="dir"><Formula>NOBN_sig_getBaliseGroupDirection()</Formula></LuaExpression>
		<LuaExpression Name="DistanceToAlignment"><Formula>RightSided and 0.01 or -0.01</Formula></LuaExpression>

		
		<LuaExpression Name="mc_DistanceToNextBalise" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToNextBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToPreviousBalise" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToPreviousBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackVertically" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackVertically()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackSideways" IsModelCheck ="true"><Formula>NOBN_sig_chkBaliseDistanceToTrackSideways()</Formula></LuaExpression>

		<!--TODO Fjerne oppførsel med at balisespissen peker ned (i forhold til current UCS y-akse) ved innsetting, den skal ALLTID peke opp langs UCS-Y -->
		<!--cosisnegative: true hvis kvadrant I eller IV (høyre side av enhetssirkelen)-->
		<InsertPointObject VariantName="Fylt/fast" DisplayName="Balise fylt/fast" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-FYLT-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>
		
		<InsertPointObject VariantName="Fylt/styrt" DisplayName="Balise fylt/styrt" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-FYLT-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>
		
		<InsertPointObject VariantName="Tom/fast" DisplayName="Balise tom/fast" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>
		
		<InsertPointObject VariantName="Tom/styrt" DisplayName="Balise tom/styrt" DisplayBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4">
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true"/>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-FAST-{{SymbolMode}}" AllowSymbolMove="true">
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ATB-NSS-BALISE
				{% if Variant == 'Fylt/fast'or Variant == 'Fylt/styrt' %}FYLT
				{% else %}TOM
				{% endif %}
				{% if Variant == 'Fylt/styrt' or Variant == 'Tom/styrt' %}STYRT
				{% else %}FAST
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
			<SymbolAttribute Tag="TEKSTOVER">
				<Value>{{TextAbove}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="TEKSTUNDER">
				<Value>{{TextBelow}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<!-- Metric info -->
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATB-NSS-BALISE-TOM-FAST-Metric" AllowSymbolMove="false">
			<!--Note: cosisnegative (RC built-in filter for DotLiquid) returns 'True' with an uppercase T-->
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_ATB-NSS-BALISE
				{% if Variant == 'Fylt/fast'or Variant == 'Fylt/styrt' %}FYLT
				{% else %}TOM
				{% endif %}
				{% if Variant == 'Fylt/styrt' or Variant == 'Tom/styrt' %}STYRT
				{% else %}FAST
				{% endif %}
				Metric
			</BlockNameFormat>
		</SymbolDefinition>

		<Annotation3DTagDefinition>
			<Attribute Tag="T01">
				<Value>{{code}}</Value>
			</Attribute>
		</Annotation3DTagDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" DoNotIncludeInSymbolFrame="true"/>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="-3" Y="0" TargetSpace="NSS_balisegruppe"/>
				<SnapPoint X="0" Y="0" TargetSpace="NSS_balisegruppe"/>
				<SnapPoint X="3" Y="0" TargetSpace="NSS_balisegruppe"/>
			</SnapPoints>
		</DockPointDefinitions>

</ObjectType>



<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>
