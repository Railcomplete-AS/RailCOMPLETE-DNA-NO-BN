<!--========================================================================================================

    NO-BN-CommonObjects.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml" />.

	(c) Railcomplete AS, Norway, 2015-2021. All rights reserved.
	
=========================================================================================================-->
<xpp:bloc>



<!--========================================================================================================
	XREF
	(no subcategory)
	Xref
=========================================================================================================-->
	<ObjectType DataType="RailCOMPLETEXref" Class="RCXRef" LuaName="rctype_XRef" Name="XRef"
				Layer="JBTRC_XRF"
				Color="ByLayer" 
				Group="XRef"
	>
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />
	</ObjectType>




<!--========================================================================================================
	GENERAL
	HELP LINE
	Used for instance as a virtual line for insertion of light poles in a parking area or along the centre of a platform.
=========================================================================================================-->
	<ObjectType DataType="tElementWithAlignment" Class="RailwayAlignment" LuaName="rctype_AuxiliaryLine" Name="JBTFE_HJL Hjelpelinje"
				Layer="JBTFE_HJL" Color="ByLayer"
				Group="Felles/Hjelpelinjer"
				>

		<RelationSpace>hjelpelinje</RelationSpace>
		
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<AlignmentSystems DefaultSystemName="Hjelpelinje" >
			<AlignmentSystem Name="Hjelpelinje"
				CantGauge="0.000"
				AlignmentGauge="0.000"
				QuickMode3DLiftWithCant="false"
		 />
		</AlignmentSystems>

		<Variants DefaultValue="Hjelpelinje" >
			<Variant Name="Hjelpelinje" >
				<SetValue Key="Color" Value="ByLayer" />
				<SetValue Key="Linetype" Value="RC-DASHED" />
				<SetValue Key="GlobalWidth" Value="0.50" />
				<SetValue Key="AlignmentSystem" Value="Hjelpelinje" />
			</Variant>
		</Variants>
		
		<PropertyPrompt Key="code" DefaultValue="Hjelpelinje" AcceptEmptyValue="false" />

		<InsertAlignment VariantName="Hjelpelinje" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-USPESIFISERT-{{SymbolMode}}" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
			<IncludeSegmentType>Curve</IncludeSegmentType>
		</InsertAlignment>

	</ObjectType>
			


<!--========================================================================================================
	GENERAL
	REGION
	Operation / Control Point area declaration
=========================================================================================================-->
	<ObjectType DataType="eOcp" Class="RailwayArea" LuaName="rctype_OcpArea" Name="JBTFE_DIV OCP område"
				Layer="JBTFE_OMRÅDER" Color="ByLayer"
				Group="Områder" Linetype="RC-OCP"
				>

		<RelationSpace>område</RelationSpace>

		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<PropertyPrompt Key="code" DefaultValue="" AcceptEmptyValue="false" />
		
		<Variants DefaultValue="OCP" >
			<Variant Name="OCP" />
		</Variants>
		
		<InsertArea DisplayName="OCP" VariantName="OCP" Group="OCP" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		
	</ObjectType>

	
	
<!--========================================================================================================
	GENERAL
	REGION
	Regions of various types.
=========================================================================================================-->
	<ObjectType DataType="tElementWithIDAndName" Class="RailwayArea" LuaName="rctype_Area" Name="JBTFE_DIV Område"
				Layer="JBTFE_OMRÅDER" Color="ByLayer"
				Group="Områder"
				Linetype="
					{%    if Variant == 'Brukerdefinert' %}RC-Brukerdefinert
					{% elsif Variant == 'Arbeidsområde' %}RC-Arbeidsområde
					{% elsif Variant == 'Lokalområde' %}RC-Lokalområde
					{% elsif Variant == 'Grense for parsell' %}RC-Parsellgrense
					{% elsif Variant == 'Plattform' %}RC-Plattform
					{% elsif Variant == 'Jernbanebro' %}RC-Jernbanebro
					{% elsif Variant == 'Veibro' %}RC-Veibro
					{% elsif Variant == 'Tunnel' %}RC-Tunnel
					{% elsif Variant == 'Viewport' %}RC-Viewport
					{% elsif Variant == 'Jordingsmaskenett' %}RC-JordingsMaskenett
					{% endif %}"
				>

		<RelationSpace>område</RelationSpace>

		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />
				
		<Variants DefaultValue="Brukerdefinert" >
			<Variant Name="Brukerdefinert" />
			<Variant Name="Arbeidsområde" />
			<Variant Name="Lokalområde" />
			<Variant Name="Grense for parsell" />
			<Variant Name="Plattform" />
			<Variant Name="Jernbanebro" />
			<Variant Name="Veibro" />
			<Variant Name="Tunnel" />
			<Variant Name="Viewport" />
			<Variant Name="Jordingsmaskenett" />
		</Variants>

		<PropertyPrompt Key="code" DefaultValue="" AcceptEmptyValue="false" />
				
		<InsertArea VariantName="Brukerdefinert" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Arbeidsområde" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Lokalområde" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Grense for parsell" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Plattform" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Jernbanebro" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Veibro" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Tunnel" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="Viewport" Group="Områder" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>
		<InsertArea VariantName="JordingsMaskenett" Group="Jording" DisplayBlockName="NO-BN-2D-JBTRC_THUMBNAIL-OMRAADE-Schematic" DefaultToTangentContinuity="false" >
			<IncludeSegmentType>Tangent</IncludeSegmentType>
		</InsertArea>

	</ObjectType>


	
<!--========================================================================================================
	GENERAL
	WATCH
	Watch object - relate a watch to one or more other objects, gaher and / or display info about them. 
=========================================================================================================-->
	<ObjectType DataType="RailCOMPLETEWatch" Class="RailwayPlacedObject" LuaName="rctype_Watch" Name="JBTFE_WCH Watch" 
				Layer="JBTFE_WATCH" Color="ByLayer"
				Group="Felles/Watch"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<RelationSpace>watch</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" /> 
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ANNOTATIVE_DISTANCE_TO_ALIGNMENT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />
		
		<Variants DefaultValue="Watch" >
			<Variant Name="Watch" >
			</Variant>
		</Variants>

		<SetValue Key="name" Value="Watch" />

		<LuaExpression Name="Text" ><Formula>_JBTFE_DIV_watch_text()</Formula></LuaExpression>
		<LuaFunction Name="_JBTFE_DIV_watch_text()" ReturnType="String"
			HideFromUser="false"
			Description="Returns a text to be displayed inside the Watch symbol's frame. The text consists of the code from each visible object related with '&quot;..rel_Watch_AppliesTo_Anything..&quot;'." >
			<Constructor>String _JBTFE_DIV_watch_text()</Constructor>
			<Formula>
				function _JBTFE_DIV_watch_text()
					local r,n,t,i
					r,n = getRelatedObjects(rel_Watch_AppliesTo_Anything)
					if n == 0 then 
						t = "UNFINISHED - Relate with '"..rel_Watch_AppliesTo_Anything.."' or edit its formula directly."
					else
						t = r[0].code
						for i = 1, n-1 do
							t = t..", "..r[i].code
						end
					end
					return t
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="SymbolFrame" ><Formula>"Watch"</Formula></LuaExpression>

		<InsertPointObject VariantName="Watch" DisplayBlockName="NO-BN-2D-JBTRC_WATCH-INNSETTING-SYMBOL-Schematic"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3" SnapSensitivityDistance="6" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>      
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_WCH-WATCH-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}" />
			<BlockNameFormat JoinBy="-" >NO-BN-2D-JBTFE_WCH-WATCH-{{SymbolMode}}</BlockNameFormat>
			<SymbolAttribute Tag="W" >
				<Value>{{Text}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
	GENERAL
	COORDINATE LIST
	Watch object - Retrieves object info from the database and returns a formatted text string in Norwegian SOSI / KOF record type 05 format.
=========================================================================================================-->
 	<LuaFunction Name="NOBN_com_getKof05Records()" ReturnType="String"
		HideFromUser="false"
		Description="Returns text in KOF file 05 format (Northing, Easting, Elevation). ThemeCode is an optional Norwegian SOSI code. SearchArea is the name of an optional RcArea." >
        <Constructor>String NOBN_com_getKof05Records([int ThemeCode[,string SearchArea]])</Constructor>
		<Formula>
function NOBN_com_getKof05Records(ThemeCode, SearchArea)
	local d, df, n, r, t, s, i, areas 
	if ThemeCode == nil then -- No arguments given, return instructions for use:
		return "Returns text in the Norwegian KOF file 05 format (Northing, Easting, Elevation), for objects with RcType given by\n"
		    .."the first object that this KOF watch is related to, using the '"..rel_Watch_AppliesTo_Anything.."' watch relation. Specify the\n"
			.."desired theme code as the first argument to this function. The theme code denotes the 4-digit SOSI survey object\n"
			.."type, to be printed along with the KOF records. If an optional search area name has been given, then the object\n"
			.."search will be restricted to that area. Note: Only visible objects are considered.",_warning
	end
	if SearchArea == nil then 
		SearchArea = "" -- Don't care
	end
	if SearchArea == "" then 
		d = DocumentData.ObjectCollection
	else
		areas = DocumentData.ObjectCollection:filter(function (x) return x.RcType:lower():match("område") and x:isVisible() end)
		areas = areas:filter(function (x) return x.code == SearchArea end)
		if getCollectionLength(areas) == 0 then 
			return "No search area was found with code '"..SearchArea.."'.",_warning
		else
			d = DocumentData.ObjectCollection:filter(function (x) return x.RcArea.code == areas[0].code end)
		end
	end
	r = Relations[rel_Watch_AppliesTo_Anything]
	if (getCollectionLength(r) == 0) then
		return "Please relate KOF watch object to any object of the desired RcType, using the '"..rel_Watch_AppliesTo_Anything.."' relation.",_warning
	end
	t = r[0].RcType
	df = d:filter(function (x) return (x.RcType == t) end)
	n = getCollectionLength(df)
	if n == 0 then 
		if SearchArea ~= "" then
			return "No objects found in area '"..SearchArea.."' of type '"..t.."'.",_warning
		else
			return "No objects found of type '"..t.."'.",_warning
		end
	else
		--Make formatted string in KOF (Norway) format: "05 = KOORDINATBLOKK"
		--
		--Type            Point name     Pos    Beskrivelse
		-- -------------- -------------- ------ -----------
		--Linjestatus     ” ” eller ”-”  1      Angir om dataene i linja skal leses (” ”) eller ignoreres (”-”).
		--Datablokk type  05             2..3   Datablokk type, der 05 = koordinatblokk. Må ikke endres
		--Punktnavn       PPPPPPPPPP     5..14  Navn på målepunkt. Punktnavnet kan bestå av både tall og
	    --                                      bokstaver og påvirker ikke sorteringsrekkefølgen i netLIN 3.
		--Temakode        KKKKKKKK       16..23 Temakode/SOSI-kode. Kan endres, se tabeller nedenfor.
		--                                      Viktig: For horisontale retningsendringer langs traseen
		--                                      (horisontalvinkler) i må ”HV” legges inn som temakode.
		--X-koordinat     XXXXXXXX.XXX   25..36 North-koordinat.
		--Y-koordinat     YYYYYYY.YYY    38..48 East-koordinat.
		--Høyde           ZZZZ.ZZZ       50..57 Ortometrisk høyde.
		--Beregningskode  Bk             59     Brukes ikke av RailCOMPLETE
		--Kommentar                      61..79 Brukes ikke av RailCOMPLETE
		-- Alfanumeriske felt VENSTRE-justeres, numeriske felt HØYREjusteres. Rader har maks 80 tegn.
		--
		s = "-KOF file for "..n.." objects found with RcType matching '"..t.."'\n"
		s = s.."-Type Obj.name Theme NNNNNNNN.NNN EEEEEEE.EEE HHHH.HHH (Northing, Easting, Height)\n"
		for i = 1, n do 
			local c = df[i-1].geoCoord
			s = s..string.format(" 05 %10d %8d %12.3f %11.3f %8.3f\n",i,ThemeCode,c.Y,c.X,c.Z)
		end
		return s
	end
end
       </Formula>
    </LuaFunction>
 
 
 
	<ObjectType DataType="RailCOMPLETEWatch" Class="RailwayPlacedObject" LuaName="rctype_CoordinateList" Name="JBTFE_DIV KOF-format koordinatliste" 
				Layer="JBTFE_WATCH" Color="ByLayer"
				Group="Felles/Watch"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<RelationSpace>watch</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" /> 
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ANNOTATIVE_DISTANCE_TO_ALIGNMENT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<CustomAttribute DataType="String" Name="KofSearchArea" DisplayName="KOF_område" DefaultValue="" 
			Description="The 'KofSearchArea' custom attribute is void or should be assigned a valid name for an existing RcArea object. If non-empty, then only objects within this area are considered." /> 
		<CustomAttribute DataType="UInt16" Name="KofThemeCode" DisplayName="KOF_sosikode" DefaultValue="7871" 
			Description="The 'KofThemeCode' custom attribute [UInt16] should hold a 3- or 4-digit SOSI cartographic object nomenclature code according to Norwegian standard." /> 

		<Variants DefaultValue="KOF Koordinatliste" >
			<Variant Name="KOF Koordinatliste" >
				<SetValue Key="name" Value="" />
				<SetValue Key="Text" Value="KOF Koordinatliste" />
			</Variant>
		</Variants>

		<InsertPointObject VariantName="KOF Koordinatliste" DisplayBlockName="NO-BN-2D-JBTRC_WATCH-INNSETTING-SYMBOL-Schematic" >
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
			<SetValue Key="SymbolFrame" Value="Watch" />
		</InsertPointObject>      
		
		<LuaExpression Name="Text" ><Formula>NOBN_com_getKof05Records(KofThemeCode,KofSearchArea)</Formula></LuaExpression>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_WCH-WATCH-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}" />
			<BlockNameFormat JoinBy="-" >NO-BN-2D-JBTFE_WCH-WATCH-{{SymbolMode}}</BlockNameFormat>
			<SymbolAttribute Tag="W" >
				<Value>{{Text}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
	GENERAL
	MARKER
	Needle / goose beak / flashbox / balloon / fouling point marker etc
=========================================================================================================-->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" LuaName="rctype_Marker" Name="JBTFE_MRK Markør" 
				Layer="JBTFE_MARKØRER" Color="ByLayer"
				Group="Felles/Markører"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<RelationSpace>markør</RelationSpace>
		
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<LuaExpression Name="DistanceToAlignment" ><Formula>NOBN_trk_getDistanceToAlignmentFromCantAndTrackPlaneDistance(RightSided and 4e-4 or -4e-4)</Formula></LuaExpression>

		<Variants DefaultValue="Knappenål" >
			<Variant Name="Knappenål" />
			<Variant Name="Ref.spor posisjon / avstand" />
			<Variant Name="Høyde over havet / fall" />
			<Variant Name="Posisjonsmarkering i sporet" >
				<SetValue Key="Annotations3D" Value='
					&lt;?xml version="1.0" encoding="utf-8"?&gt;
					&lt;ArrayOfPlacedElementCadAnnotation 
						xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
						xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" &gt;  

						&lt;PlacedElementCadAnnotation 
								Tag="3D spornavn" 
								Invisible="false" 
								Oblique="0" 
								WidthFactor="1" 
								TextHeight="0.15"&gt;
							&lt;Formula&gt;Alignment.name&lt;/Formula&gt;       
							&lt;Offset X="-0.75" Y="0.00" Z="1.00" /&gt;       
							&lt;Rotation X="90" Y="0" Z="0" /&gt;    
						&lt;/PlacedElementCadAnnotation&gt;  

						&lt;PlacedElementCadAnnotation 
								Tag="3D Km" 
								Invisible="false" 
								Oblique="0" 
								WidthFactor="1" 
								TextHeight="0.25"&gt;
							&lt;Formula&gt;ReferenceMileage&lt;/Formula&gt;       
							&lt;Offset X="-0.75" Y="0.00" Z="0.50" /&gt;       
							&lt;Rotation X="90" Y="0" Z="0" /&gt;    
						&lt;/PlacedElementCadAnnotation&gt;  

					&lt;/ArrayOfPlacedElementCadAnnotation&gt;'
				/>
				<SetValue Key="Farge" Value="Gul" />
			</Variant>
		</Variants>

		<SetDynamicProperty DynamicPropertiesPropertyName="Representation" DynamicPropertyType="Model3D"/>
		
		<CustomAttribute DataType="Enumeration" Name="markerColor" DisplayName="Farge" DefaultValue="Rød" 
			Description="The 'markerColor' custom enum property [Rød | Gul | Grønn | Blå] holds the marker's color." 
			>
			<Values Variant="Knappenål" >
				<Value>Rød</Value>
				<Value>Gul</Value>
				<Value>Grønn</Value>
				<Value>Blå</Value>
			</Values>
			<Values Variant="Ref.spor posisjon / avstand" >
				<Value>Blå</Value>
			</Values>
			<Values Variant="Posisjonsmarkering" >
				<Value>Gul</Value>
			</Values>
		</CustomAttribute>

		<LuaExpression Name="Model3D_0.Model3DName" ><Formula>_JBTFE_MRK_marker_Model3DName()</Formula></LuaExpression>
		<LuaFunction Name="_JBTFE_MRK_marker_Model3DName()" ReturnType="String"
				Description="Obtains the marker's 3D model name." >
			<Constructor>String _JBTFE_MRK_marker_Model3DName()</Constructor>
			<Formula>
				function _JBTFE_MRK_marker_Model3DName()
					if (Variant == "Knappenål") then
						return "NO-BN-3D-FE-DIV-MARKØR-KNAPPENÅL-"..markerColor:upper()
					elseif (Variant == "Ref.spor posisjon / avstand") then
						return "NO-BN-3D-FE-DIV-MARKØR-KNAPPENÅL-"..markerColor:upper()
					elseif (Variant == "Posisjonsmarkering i sporet") then
						return "NO-BN-3D-FE-DIV-POSISJONSMARKERING" 
					end
				end
			</Formula>
		</LuaFunction>
		
		<LuaExpression Name="name" ><Formula>_JBTFE_MRK_marker_name()</Formula></LuaExpression>
		<LuaFunction Name="_JBTFE_MRK_marker_name()" ReturnType="String"
				Description="Returns the name of the related object or position/distance or elevation/slope, depending on the variant and the number of related objects." >
			<Constructor>String _JBTFE_MRK_marker_name([RailwayPlacedObject obj])</Constructor>
			<Formula>
				function _JBTFE_MRK_marker_name(obj)
					obj = obj or this
					s = rel_Marker_AppliesTo_Anything
					r,n = getRelatedObjects(s,obj)
					st = s
				
					if obj.Variant == "Ref.spor posisjon / avstand" then
						if n == 0 then
							return RC__identify(Alignment)..".("..obj.RcType..") : Km."..NOBN_trk_toKm(obj.ReferenceMileage)

						elseif n == 1 then
							if r[0].ReferenceMileage == nil then 
								return "ERROR - Cannot deduce reference mileage for target object "..
									"("..r[0].RcType.."):"..RC__identify(r[0])
							else
								return RC__identify(r[0].Alignment)..".("..r[0].RcType..") : Km."..NOBN_trk_toKm(r[0].ReferenceMileage)
							end

						else --n is 2 or more
							if r[0].ReferenceMileage == nil then 
								return "ERROR - Cannot deduce reference mileage for first target object "..
									"("..r[0].RcType.."):"..RC__identify(r[0])
							elseif r[1].ReferenceMileage == nil then 
								return "ERROR - Cannot deduce reference mileage for second target object "..
									"("..r[1].RcType.."):"..RC__identify(r[1])
							end
							if RC__isNan(distance(r[0],r[1])) then 
								return "ERROR - No path found between objects: "..
									RC__identify(r[0].Alignment)..".("..r[0].RcType.."):"..RC__identify(r[0])..
									" und "..
									RC__identify(r[1].Alignment)..".("..r[1].RcType.."):"..RC__identify(r[1]).."." 
							else
								if r[0].ReferenceMileage &lt; r[1].ReferenceMileage then
									return string.format("Distance from %s to %s = %.03f m",RC__identify(r[0]), RC__identify(r[1]), distance(r[0],r[1]))
								else
									return string.format("Distance from %s to %s = %.03f m",RC__identify(r[1]), RC__identify(r[0]), distance(r[0],r[1]))
								end
							end
						end
						
					elseif obj.Variant == "Høyde over havet / fall" then
						if n == 0 then
							--return string.format("%s.(%s) : Elevation above mean sea level = %.03f", RC__identify(obj.Alignment), obj.RcType, obj.geoCoord.Z)
				
						elseif n == 1 then
							local z0 = r[0].geoCoord.Z
							if z0 == nil then 
								return "ERROR - Cannot deduce elevation for first target object "..
									"("..r[0].RcType.."):"..RC__identify(r[0])
							else
								return string.format("%s.(%s) : Elevation = %.03f", RC__identify(r[0].Alignment), r[0].RcType, z0)
							end
				
						else --n is 2 or more
							local z0 = r[0].geoCoord.Z
							local z1 = r[1].geoCoord.Z
							if z0 == nil then 
								return "ERROR - Cannot deduce elevation for first target object "..
									"("..r[0].RcType.."):"..RC__identify(r[0])
							elseif z1 == nil then 
								return "ERROR - Cannot deduce elevation for second target object "..
									"("..r[1].RcType.."):"..RC__identify(r[1])
							end
							local d = distance(r[0],r[1])
							local dZ = z0 - z1 --from first clicked to last clicked
							if RC__isNan(d) then 
								return "ERROR - No path found between objects: "..
									RC__identify(r[0].Alignment)..".("..r[0].RcType.."):"..RC__identify(r[0])..
									" and "..
									RC__identify(r[1].Alignment)..".("..r[1].RcType.."):"..RC__identify(r[1]).."." 
							else
								return string.format("Slope (%s =&gt; %s) : (%.03f - %0.3f = %.03f) / (%.03f) = %.02f o/oo", 
									RC__identify(r[0]), RC__identify(r[1]), z0, z1, dZ, d, 1000*(dZ/d))
							end
						end
				
					else
						--All other variants - show the related item's identities:
						if n == 0 then 
							return "UNFINISHED - Relate with '"..st.."'."
						else
							local t,i
							function CodeOrId(x) return x.code ~= "" and x.code or x.id end
							t = "("..CodeOrId(r[0])
							for i = 1, n-1 do
								t = t..", "..CodeOrId(r[i])
							end
							return t..")"
						end
					end
				end
			</Formula>
		</LuaFunction>

		<!-- Snap to any type of alignment: -->
		<InsertPointObject VariantName="Knappenål" DisplayBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0" SnapSensitivityDistance="3" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
		</InsertPointObject>      

		<InsertPointObject VariantName="Ref.spor posisjon / avstand" DisplayBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0" SnapSensitivityDistance="3" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
		</InsertPointObject>

		<InsertPointObject VariantName="Høyde over havet / fall" DisplayBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0" SnapSensitivityDistance="3" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
		</InsertPointObject>

		<InsertPointObject VariantName="Posisjonsmarkering i sporet" DisplayBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0" SnapSensitivityDistance="3" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="true" />
			<BlockNameFormat JoinBy="-" >NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}</BlockNameFormat>
			<SymbolAttribute Tag="FARGE" >
				<Value>{{markerColor}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
	GENERAL
	CROSS SECTIONS
	Use to name a halting location for trains inside a station. In use by railML inside LUKS and OpenTrack.
=========================================================================================================-->
	<ObjectType DataType="tCrossSection" Class="RailwayPlacedObject" LuaName="rctype_RailmlCrossSection" Name="JBTFE_DIV Cross section" 
				Layer="JBTFE_DIVERSE" Color="ByLayer"
				Group="Felles/railML Cross Section"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
	>

		<RelationSpace>cross_section</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ANNOTATIVE_DISTANCE_TO_ALIGNMENT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<SetDynamicProperty DynamicPropertiesPropertyName="Representation" DynamicPropertyType="Model3D"/>

		<InsertPointObject VariantName="Cross section" DisplayBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
			<SetValue Key="Model3D_0.Model3DName" Value="NO-BN-3D-FE-DIV-MARKØR-KNAPPENÅL-RØD" />
		</InsertPointObject>      

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="true" />
			<BlockNameFormat JoinBy="-" >NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}</BlockNameFormat>
		</SymbolDefinition>
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>

	
	
<!--========================================================================================================
	GENERAL
	TRACK USAGE
	A circle with the type of usage that the track is intended for. This usage code spreads out to the 
	corresponding surrounding limiting objects. Works like track circuit isolations and track circuits numbers.
=========================================================================================================-->
	<LuaFunction Name="NOBN_trk_getTrackUsage()" ReturnType="String"
			Description="Obtains the intended usage for the track which is the Own Alignment to the calling object."
		>
		<Constructor>String NOBN_trk_getTrackUsage([ObjectRef obj])</Constructor>
		<Formula>
			function NOBN_trk_getTrackUsage(obj)
				obj = obj or this
				if obj.Alignment.RcType ~= rctype_Track then
					return _error, "*** NOBN_trk_getTrackUsage : The object's own alignment type must be '"..rctype_Track.."'."
				else
					return obj.Alignment.Variant
				end
			end
		</Formula>
	</LuaFunction>
		


	<ObjectType DataType="RailCOMPLETESection" Class="RailwayPlacedObject" LuaName="rctype_TrackUsage" Name="JBTFE_DIV Sporbruk"
				Layer="JBTFE_SPORBRUK" Color="ByLayer"
				Group="Felles/Sporbruk"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<RelationSpace>sporbruk</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ANNOTATIVE_DISTANCE_TO_ALIGNMENT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<Variants DefaultValue="Hovedspor" >
			<Variant Name="Hovedspor" />
			<Variant Name="Togspor" />
			<Variant Name="Hensettingsspor" />
			<Variant Name="Skiftespor" />
			<Variant Name="Sidespor" />
			<Variant Name="Buttspor" />
			<Variant Name="Uttrekksspor" />
			<Variant Name="Usikret område" />
		</Variants>
		
		<LuaExpression Name="code" ><Formula>_JBTFE_DIV_sporbruk_code()</Formula></LuaExpression>
		<LuaFunction Name="_JBTFE_DIV_sporbruk_code()" ReturnType="String"
				Description="Obtains the code for the track usage (Sporbruk) object [String]." >
			<Constructor>String _JBTFE_DIV_sporbruk_code()</Constructor>
			<Formula>
				function _JBTFE_DIV_sporbruk_code()
					if Variant == "Hovedspor" then return "Hv"
					elseif Variant == "Togspor" then return "Tg"
					elseif Variant == "Hensettingsspor" then return "He"
					elseif Variant == "Skiftespor" then return "Sk"
					elseif Variant == "Sidespor" then return "Si"
					elseif Variant == "Buttspor" then return "Bu"
					elseif Variant == "Uttrekksspor" then return "Ut"
					elseif Variant == "Usikret område" then return "Us"
					else return "Unrecognized variant ["..Variant.."].",_error
					end
				end
			</Formula>
		</LuaFunction>

		<InsertPointObject VariantName="Hovedspor" DisplayName="Sporbruk" DisplayBlockName="NO-BN-2D-JBTRC_SEKSJON-INNSETTING-SYMBOL-Schematic" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
			<SetValue Key="SymbolFrame" Value="Symbolramme-R2.75" />
			<LuaExpression Name="DelimiterType"><Formula>rctype_TrackUsageDelimiter</Formula></LuaExpression>
		</InsertPointObject>
		
		<!-- NB - The RailCOMPLETE SymbolFrame forms the frame around the section's visible text. -->
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_SEK-SEKSJON-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}" />
			<SymbolAttribute Tag="X" >
				<Value>{{Variant}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>
	
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>
	
	
	
<!--========================================================================================================
	GENERAL
	TRACK USAGE DELIMITER
	An object (needle, goose beak or similar) placed on a track and which picks up its left and right track
	usage type from the immediate track usage object to its left / to its right.
=========================================================================================================-->
	<ObjectType DataType="tDelimitedOrientedElement" Class="RailwayPlacedObject" LuaName="rctype_TrackUsageDelimiter" Name="JBTFE_DIV Sporbrukgrense"
				Layer="JBTFE_SPORBRUKGRENSE" Color="ByLayer"
				Group="Felles/Sporbruk"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<RelationSpace>sporbrukgrense</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___COM" />
		<xpp:expand select="NOBN_com_DISCIPLINE___COM" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" />

		<LuaExpression Name="DistanceToAlignment" ><Formula>RightSided and 4e-4 or -4e-4</Formula></LuaExpression>
			
		<LuaExpression Name="code" ><Formula>_JBTFE_DIV_sporbrukgrense_code()</Formula></LuaExpression>
		<LuaFunction Name="_JBTFE_DIV_sporbrukgrense_code()" ReturnType="String"
				Description="Obtains the name of a track usage delimiter element, inherited from the two surrounding track usage section elements." >
			<Constructor>String _JBTFE_DIV_sporbrukgrense_code()</Constructor>
			<Formula>
				function _JBTFE_DIV_sporbrukgrense_code()
					first = DownSections.Count == 0  and "-" or DownSections[0].Code
					second = UpSections.Count == 0  and "-" or UpSections[0].Code
					if MileageIncreasesTowardsLeft then	first,second = second,first end
					return "(" .. first .. "/" .. second .. ")"
				end
			</Formula>
		</LuaFunction>
		
	   <LuaExpression Name="ObjectInfo" ><Formula>_JBTFE_DIV_sporbrukgrense_objectInfo()</Formula></LuaExpression>
		<LuaFunction Name="_JBTFE_DIV_sporbrukgrense_objectInfo()" ReturnType="String"
				Description="Obtains the 'ObjectInfo' text for the track usage delimiter element." >
			<Constructor>String _JBTFE_DIV_sporbrukgrense_objectInfo()</Constructor>
			<Formula>
				function _JBTFE_DIV_sporbrukgrense_objectInfo()
					first = DownSections.Count == 0  and "-" or DownSections[0].Variant
					second = UpSections.Count == 0  and "-" or UpSections[0].Variant
					if MileageIncreasesTowardsLeft then	first,second = second,first end
					return "Sporbruk: " .. first .. "/" .. second
				end
			</Formula>
		</LuaFunction>

		<InsertPointObject VariantName="Sporbrukgrense" DisplayBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}"
				SnapToAlignment="true" SnapDistance="4e-4" >
			<JigSymbolAppearance EnableDirectionSetting="true" />
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}" />
			<BlockNameFormat JoinBy="-" >NO-BN-2D-JBTFE_MRK-MARKOER-{{SymbolMode}}</BlockNameFormat>
			<SymbolAttribute Tag="FARGE" >
				<Value>{{code}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
  RAILCOMPLETECloneObject
  TODO 2018-07-06 Still not specified - just an idea.
=========================================================================================================-->
	<!--Holds a reference to the original object. Used for schematic tracks.-->
	<ObjectType DataType="RailCOMPLETECloneObject" Class="CloneRailwayObject" LuaName="rctype_CloneObject" Name="CloneObject" DisplayName="Clone object" >
		<xpp:expand select="NOBN_com_PSET_BANE_NOR" />
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" />
		<xpp:expand select="NOBN_com_PSET_ISY_STK" />
		<xpp:expand select="NOBN_com_PSET_TITTELFELT" /></ObjectType>


	
<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>