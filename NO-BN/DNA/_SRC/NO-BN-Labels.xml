<!--========================================================================================================

    NO-BN-Labels.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml"/>.

	(c) Railcomplete AS, Norway, 2015-2023. All rights reserved.
	
=========================================================================================================-->
<xpp:bloc>



<!--========================================================================================================
	Lua functions
=========================================================================================================-->
	<LuaFunction Name="NOBN_trk_getSwitchLabelItem1()" ReturnType="String"
		Description="Returns the Fouling Point and Stock Rail joint reference mileages for a related switch.">
		<Constructor>String NOBN_trk_getSwitchLabelItem1([Boolean MileageIncreasesTowardsLeft])</Constructor>
		<Formula>
			function NOBN_trk_getSwitchLabelItem1(MileageIncreasesTowardsLeft)
				if MileageIncreasesTowardsLeft == nil then 
					MileageIncreasesTowardsLeft = false
				end
				local s,r,n,v,fp,srj --fp=fouling point, srj=stock rail joint
				s = rel_Label_AppliesTo_Anything
				r,n = getRelatedObjects(s)
				if n == 0 then
					return "UNFINISHED - Relate with '"..s.."'.",_unfinished
				else
					v = r[0]
					if v.RcType ~= rctype_Switch then
						return "Bad related object type ["..v.RcType.."], "..rctype_Switch.." was expected",_warning
					end
					local srjrm = v.ReferenceMileage --Stock rail joint reference mileage
					fp = getFoulingPoints(v)
					if getCollectionLength(fp) == 0 then	
						return "Km. "..NOBN_trk_toKm(srj).." (fant ikke Mid)",_warning
					else 
						fprm = fp[0].Branch1.ReferenceMileage  --Fouling point reference mileage
						if srjrm &lt; fprm then 
							if MileageIncreasesTowardsLeft then
								return "Km."..NOBN_trk_toKm(fprm).."/"..NOBN_trk_toKm(srjrm)
							else
								return "Km."..NOBN_trk_toKm(srjrm).."/"..NOBN_trk_toKm(fprm)
							end
						else
							if MileageIncreasesTowardsLeft then
								return "Km."..NOBN_trk_toKm(srjrm).."/"..NOBN_trk_toKm(fprm)
							else
								return "Km."..NOBN_trk_toKm(fprm).."/"..NOBN_trk_toKm(srjrm)
							end
						end
					end
				end
			end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_trk_getSwitchLabelItem2()" ReturnType="String"
		Description="Returns the related switch's name.">
		<Constructor>String NOBN_trk_getSwitchLabelItem2([Boolean MileageIncreasesTowardsLeft])</Constructor>
		<Formula>
			function NOBN_trk_getSwitchLabelItem2(MileageIncreasesTowardsLeft)
				if MileageIncreasesTowardsLeft == nil then 
					MileageIncreasesTowardsLeft = false
				end
				local s,r,n,v,fp,srj --fp=fouling point, srj=stock rail joint
				s = rel_Label_AppliesTo_Anything
				r,n = getRelatedObjects(s)
				if n == 0 then
					return "UNFINISHED - Relate with '"..s.."'.",_unfinished
				else
					v = r[0]
					if v.RcType ~= rctype_Switch then
						return "Bad related object type ["..v.RcType.."], "..rctype_Switch.." was expected",_warning
					end
					local srjrm = v.ReferenceMileage --Stock rail joint reference mileage
					fp = getFoulingPoints(v)
					if getCollectionLength(fp) == 0 then	
						return "SS"..v.code.." (fant ikke Mid)",_warning
					else
						local fprm = fp[0].Branch1.ReferenceMileage  --Fouling point reference mileage
						if srjrm &lt; fprm then 
							if MileageIncreasesTowardsLeft then
								return "Mid/SS".." "..v.code
							else
								return "SS/Mid".." "..v.code
							end
						else
							if MileageIncreasesTowardsLeft then
								return "SS/Mid".." "..v.code
							else
								return "Mid/SS".." "..v.code
							end
						end
					end
				end
			end
		</Formula>
	</LuaFunction>

	

	<LuaFunction Name="NOBN_trk_getSwitchLabelItem3()" ReturnType="String"
		Description="Returns the switch's reference alignment code.">
		<Constructor>String NOBN_trk_getSwitchLabelItem3()</Constructor>
		<Formula>
			function NOBN_trk_getSwitchLabelItem3()
				local s,r,n,v,fp,srj --fp=fouling point, srj=stock rail joint
				s = rel_Label_AppliesTo_Anything
				r,n = getRelatedObjects(s)
				if n == 0 then
					return "UNFINISHED - Relate with '"..s.."'.",_unfinished
				else
					v = r[0]
					if v.RcType ~= rctype_Switch then
						return "Bad related object type ["..v.RcType.."], "..rctype_Switch.." was expected",_warning
					end
					return "(Ref. "..v.ReferenceAlignment.code..")"
				end
			end
		</Formula>
	</LuaFunction>



<!--========================================================================================================
	GENERAL
	LABELS
	Standard labels
=========================================================================================================-->
	<ObjectType DataType="RailCOMPLETELabel" Class="RailwayPlacedObject" LuaName="rctype_Label" Name="JBTFE_DIV Etikett"
				Layer="JBTFE_ETIKETTER" Color="ByLayer"
				Group="Felles/Etiketter"
				>

		<RelationSpace>etikett</RelationSpace>
		
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___VAR"/>
		<xpp:expand select="NOBN_com_DISCIPLINE___COM"/>
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT"/> 
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE"/>
		<xpp:expand select="NOBN_com_PSET_BANE_NOR"/>
		<xpp:expand select="NOBN_com_PSET_FDV_BANEDATA"/>
		<xpp:expand select="NOBN_com_PSET_ISY_STK"/>
		<xpp:expand select="NOBN_com_PSET_TITTELFELT"/>

		<Variants DefaultValue="A-1-0-VLB-018">
			<Variant Name="A-1-0-VLB-018"/>
			<Variant Name="A-1-0-VLT-018"/>
			<Variant Name="A-1-0-VRB-018"/>
			<Variant Name="A-1-0-VRT-018"/>

			<Variant Name="B-1-0-HLB-018"/>
			<Variant Name="B-1-0-HLT-018"/>
			<Variant Name="B-1-0-HRB-018"/>
			<Variant Name="B-1-0-HRT-018"/>

			<Variant Name="C-1-0-HLB-025"/>
			<Variant Name="C-1-0-HLT-025"/>
			<Variant Name="C-1-0-HRB-025"/>
			<Variant Name="C-1-0-HRT-025"/>

			<Variant Name="C-1-1-HLB-025-018"/>
			<Variant Name="C-1-1-HLT-025-018"/>
			<Variant Name="C-1-1-HRB-025-018"/>
			<Variant Name="C-1-1-HRT-025-018"/>

			<Variant Name="C-1-2-HLB-025-018"/>
			<Variant Name="C-1-2-HLT-025-018"/>
			<Variant Name="C-1-2-HRB-025-018"/>
			<Variant Name="C-1-2-HRT-025-018"/>

			<Variant Name="D-1-1-HLB-025-018"/>
			<Variant Name="D-1-1-HLT-025-018"/>
			<Variant Name="D-1-1-HRB-025-018"/>
			<Variant Name="D-1-1-HRT-025-018"/>

			<Variant Name="D-1-2-HLB-025-018"/>
			<Variant Name="D-1-2-HLT-025-018"/>
			<Variant Name="D-1-2-HRB-025-018"/>
			<Variant Name="D-1-2-HRT-025-018"/>
		</Variants>
		
		<LuaExpression Name="VerticalOffset"><Formula>0</Formula></LuaExpression>
		<LuaExpression Name="LateralOffset"><Formula>RC__getNearestSnapDistance(getPropertyValue("LateralOffset"),5)</Formula></LuaExpression>
		<LuaExpression Name="ReferenceMileage">
			<Formula>
				s = rel_Label_AppliesTo_Anything
				r,n = getRelatedObjects(s)
				if n == 0 then 
					return getPropertyValue("ReferenceMileage"), _info("UNFINISHED - Relate with '"..s.."'.")
				else
					return r[0].ReferenceMileage
				end

				r,n = getRelatedObjects(rel_Label_AppliesTo_Anything)
				return (n &gt; 0) and r[0].ReferenceMileage or getPropertyValue("ReferenceMileage")
			</Formula>
		</LuaExpression>
		<LuaExpression Name="LabelItem1"><Formula>NOBN_com_getLabelItem1()</Formula></LuaExpression>
		<LuaExpression Name="LabelItem2"><Formula>NOBN_com_getLabelItem2()</Formula></LuaExpression>
        <LuaExpression Name="LabelItem3"><Formula>NOBN_com_getLabelItem3()</Formula></LuaExpression>

		<InsertPointObject DisplayName="Etikett A" Name="A-1-0-VRB-018" DisplayBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-A-1-0-VRB-018-{{SymbolMode}}">
			<JigSymbolAppearance EnableDirectionSetting="true"/>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}"/>
		</InsertPointObject>

		<InsertPointObject DisplayName="Etikett B" Name="B-1-0-HLT-018" DisplayBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-B-1-0-HRB-018-{{SymbolMode}}">
			<JigSymbolAppearance EnableDirectionSetting="true"/>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}"/>
		</InsertPointObject>

		<InsertPointObject DisplayName="Etikett C" Name="C-1-0-HLT-025" DisplayBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-C-1-0-HRB-025-{{SymbolMode}}">
			<JigSymbolAppearance EnableDirectionSetting="true"/>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}"/>
		</InsertPointObject>

		<InsertPointObject DisplayName="Etikett C (2 linjer)" Name="C-1-1-HLT-025-018" DisplayBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-C-1-0-HRB-025-{{SymbolMode}}">
			<JigSymbolAppearance EnableDirectionSetting="true"/>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}"/>
		</InsertPointObject>

		<InsertPointObject DisplayName="Etikett D" Name="D-1-1-HRB-025-018" DisplayBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-D-1-1-HRB-025-018-{{SymbolMode}}">
			<JigSymbolAppearance EnableDirectionSetting="true"/>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}"/>
		</InsertPointObject>

		<InsertPointObject DisplayName="Etikett D (3 linjer)" Name="D-1-2-HRB-025-018" DisplayBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-D-1-2-HRB-025-018-{{SymbolMode}}">
			<JigSymbolAppearance EnableDirectionSetting="true"/>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}"/>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE_ETI-ETIKETT-A-1-0-VLB-018" AllowSymbolMove="true">
			<Rotation Add180DegreesIfDirIsDown="true" 
						AddAngle="{% if MileageIncreasesTowardsLeft %}180{% else %}0{% endif %}"/>
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTFE_ETI-ETIKETT
				{% if    Variant == 'A-1-0-VLB-018' %}A-1-0-VLB-018
				{% elsif Variant == 'A-1-0-VLT-018' %}A-1-0-VLT-018
				{% elsif Variant == 'A-1-0-VRB-018' %}A-1-0-VRB-018
				{% elsif Variant == 'A-1-0-VRT-018' %}A-1-0-VRT-018
			
				{% elsif Variant == 'B-1-0-HLB-018' %}B-1-0-HLB-018
				{% elsif Variant == 'B-1-0-HLT-018' %}B-1-0-HLT-018
				{% elsif Variant == 'B-1-0-HRB-018' %}B-1-0-HRB-018
				{% elsif Variant == 'B-1-0-HRT-018' %}B-1-0-HRT-018

				{% elsif Variant == 'C-1-0-HLB-025' %}C-1-0-HLB-025
				{% elsif Variant == 'C-1-0-HLT-025' %}C-1-0-HLT-025
				{% elsif Variant == 'C-1-0-HRB-025' %}C-1-0-HRB-025
				{% elsif Variant == 'C-1-0-HRT-025' %}C-1-0-HRT-025

				{% elsif Variant == 'C-1-1-HLB-025-018' %}C-1-1-HLB-025-018
				{% elsif Variant == 'C-1-1-HLT-025-018' %}C-1-1-HLT-025-018
				{% elsif Variant == 'C-1-1-HRB-025-018' %}C-1-1-HRB-025-018
				{% elsif Variant == 'C-1-1-HRT-025-018' %}C-1-1-HRT-025-018

				{% elsif Variant == 'C-1-2-HLB-025-018' %}C-1-2-HLB-025-018
				{% elsif Variant == 'C-1-2-HLT-025-018' %}C-1-2-HLT-025-018
				{% elsif Variant == 'C-1-2-HRB-025-018' %}C-1-2-HRB-025-018
				{% elsif Variant == 'C-1-2-HRT-025-018' %}C-1-2-HRT-025-018

				{% elsif Variant == 'D-1-1-HLB-025-018' %}D-1-1-HLB-025-018
				{% elsif Variant == 'D-1-1-HLT-025-018' %}D-1-1-HLT-025-018
				{% elsif Variant == 'D-1-1-HRB-025-018' %}D-1-1-HRB-025-018
				{% elsif Variant == 'D-1-1-HRT-025-018' %}D-1-1-HRT-025-018

				{% elsif Variant == 'D-1-2-HLB-025-018' %}D-1-2-HLB-025-018
				{% elsif Variant == 'D-1-2-HLT-025-018' %}D-1-2-HLT-025-018
				{% elsif Variant == 'D-1-2-HRB-025-018' %}D-1-2-HRB-025-018
				{% elsif Variant == 'D-1-2-HRT-025-018' %}D-1-2-HRT-025-018
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>

			<!-- Insert stored values into the graphical symbol in modelspace: -->
			<SymbolAttribute Tag="T01">
				<Value>{{LabelItem1}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="T02">
				<Value>{{LabelItem2}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="T03">
				<Value>{{LabelItem3}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTRC_INNSETTINGSPUNKT-Schematic"></SymbolDefinition>
		
	</ObjectType>

	
	
<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>