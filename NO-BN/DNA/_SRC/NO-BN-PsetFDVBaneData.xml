<!--========================================================================================================

    NO-BN-PsetFDVBaneData.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml" />.

	(c) Railcomplete AS, Norway, 2015-2021. All rights reserved.
	
=========================================================================================================-->
<xpp:bloc>

<!--========================================================================================================
	Extended data property sets (will be picked up by AutoCAD as Extended Data, and exports to IFC using Civil 3D)
=========================================================================================================-->

<!-- Datasettet "FDV_BaneData" benyttes dersom det er objekter som skal registreres i BaneData. Disse objektene har  -->
<!-- fått Banedata ID under utarbeidelse av arbeidsgrunnlaget, og denne skal benyttes når supplerende informasjon skal sendes inn.  -->
<!-- Tilpasset for Multiconsult -->

<PropertySets>
	<ExtendedDataPropertySet Name="FDV_BaneData" IsVisible="true" IsWritable="true" IsLocked="false" >
		<Properties>
			<ExtendedDataProperty Name="FDV001_AvstandFraSpormidt(fra)" DataType="Text" Description="Fra avstand fra spormidt" DefaultValue="---" IsVisible="true" DisplayOrder="1" />
			<ExtendedDataProperty Name="FDV002_AvstandFraSpormidt(til)" DataType="Text" Description="Til avstand fra spormidt" DefaultValue="---" IsVisible="true" DisplayOrder="2" />
			<ExtendedDataProperty Name="FDV003_BanedataID" DataType="Text" Description="ID på objekt hentet fra Banedata" DefaultValue="---" IsVisible="true" DisplayOrder="3" />
			<ExtendedDataProperty Name="FDV004_NavnNr" DataType="Text" Description="Brukes når banedataID ikke er tilgjengelig" DefaultValue="---" IsVisible="true" DisplayOrder="4" />
			<ExtendedDataProperty Name="FDV005_Hovedobjekt" DataType="Text" Description="Tilhører objekt" DefaultValue="---" IsVisible="true" DisplayOrder="5" />
			<ExtendedDataProperty Name="FDV006_Eier" DataType="Text" Description="Eier til objektet" DefaultValue="---" IsVisible="true" DisplayOrder="6" />
			<ExtendedDataProperty Name="FDV007_Km(fra)" DataType="Text" Description="Kilometrering fra " DefaultValue="---" IsVisible="true" DisplayOrder="7" />
			<ExtendedDataProperty Name="FDV008_Km(til)" DataType="Text" Description="Kilometrering til" DefaultValue="---" IsVisible="true" DisplayOrder="8" />
			<ExtendedDataProperty Name="FDV009_Kontrakt" DataType="Text" Description="Kontrakt for dette oppdrag" DefaultValue="---" IsVisible="true" DisplayOrder="9" />
			<ExtendedDataProperty Name="FDV010_Lokasjon" DataType="Text" Description="Lokasjon for dette oppdrag" DefaultValue="---" IsVisible="true" DisplayOrder="10" />
			<ExtendedDataProperty Name="FDV011_Side(fra)" DataType="Text" Description="Side i forhold til spor (laveste km)" DefaultValue="---" IsVisible="true" DisplayOrder="11" />
			<ExtendedDataProperty Name="FDV011_Side(til)" DataType="Text" Description="Side i forhold til spor (høyeste km)" DefaultValue="---" IsVisible="true" DisplayOrder="12" />
			<ExtendedDataProperty Name="FDV012_Fag" DataType="Text" Description="Fagkode iht Banedata" DefaultValue="---" IsVisible="true" DisplayOrder="13" />
			<ExtendedDataProperty Name="FDV013_Objekttype" DataType="Text" Description="Objekttype iht Banedata" DefaultValue="---" IsVisible="true" DisplayOrder="14" />
			<ExtendedDataProperty Name="FDV014_SporNr" DataType="Text" Description="Spor nummer" DefaultValue="---" IsVisible="true" DisplayOrder="15" />
			<ExtendedDataProperty Name="FDV015_Sportype" DataType="Text" Description="Sportype" DefaultValue="---" IsVisible="true" DisplayOrder="16" />
			<ExtendedDataProperty Name="FDV016_Lenk" DataType="Text" Description="Link til objektet i omega365 " DefaultValue="---" IsVisible="true" DisplayOrder="17" />
		</Properties>
	</ExtendedDataPropertySet>
</PropertySets>

<!--========================================================================================================
    ObjectType element 'CustomAttribute' macros for FDV_BaneData
=========================================================================================================-->


 
 <!-- RailCOMPLETE benytter en extended data definisjon (element PropertySets / ExtendedDataPropertySet) for å definere et  -->
 <!-- property set som kan legges inn i objekters AutoCAD Extended Data. De dukker da opp i alle Autodesk produkter som  -->
 <!-- objektdata / Extended Data. -->
 
 <!-- Data som ligger som Extended Data i et AutoCAD-objekt vil "bli med på lasset" over til IFC dersom du har Civil 3D installert -->
 <!-- og benytter kommandoen for eksport til IFC, EXPORTIFC. -->

	<!-- <xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" /> -->
<xpp:define name="NOBN_com_PSET_FDV_BANEDATA" >
	<xpp:bloc>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV001_AvstandFraSpormidt(fra)" Name="FDV001_AvstandFraSpormidtFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV001_AvstandFraSpormidt(fra)"
				Description="Avstand i meter til relevant spor. Punktobjekt som tilhører et jernbanespor: Avstand måles fra objektets innsettingspunkt vinkelrett inn på eget spor. Punktobjekt som ikke tilhører et jernbanespor: Avstand måles fra objektets innsettingspunkt vinkelrett inn på mest relevante spor. Jernbanespor: Avstanden er alltid null (til seg selv). Linjeobjekter som ikke er jernbanespor: Som for punktobjekter som ikke tilhører et jernbanespor. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDV001_AvstandFraSpormidtFra()' om du trenger å gjenskape den."
		/>
			
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV002_AvstandFraSpormidt(til)" Name="FDV002_AvstandFraSpormidtTil" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV002_AvstandFraSpormidt(til)"
				Description="Til avstand fra spormidt"
		/>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV003_BanedataID" Name="FDV003_BanedataID" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV003_BanedataID"
				Description="ID på objekt hentet fra Banedata"
		/>		
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV004_NavnNr." Name="FDV004_NavnNr" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV004_NavnNr." />

		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV005_Hovedobjekt" Name="FDVBaneDataTilhorerObjekt" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV005_Hovedobjekt"
				Description="Tilhører objekt"
		/>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV006_Eier" Name="FDV006_Eier" DefaultValue="Bane NOR" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV006_Eier" />

		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV007_Km(fra)" Name="FDV007_KmFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV007_Km(fra)"
				Description="Kilometrering fra . For objekt som ikke tilhører et jernbanespor (isolator i kontaktledning osv.) vises referansespor-km utledet fra objektets projeksjon inn på nærmeste spor. For linjeobjekt vises det startpunktets referansespor-kilometer. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDV007_KmFra()' om du trenger å gjenskape den."
		/>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV008_Km(til)" Name="FDV007_KmFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV008_Km(til)"
				Description="Kilometrering til"
		/>	
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV009_Kontrakt" Name="FDV009_Kontrakt" DefaultValue="Baneservice AS" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV009_Kontrakt"
				Description="Kontrakt for dette oppdrag"
		/>			
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV010_Lokasjon" Name="FDV010_Lokasjon" DefaultValue="Hove Hensetting" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV010_Lokasjon"
				Description="Lokasjon for dette oppdrag."
		/>
		
		<CustomAttribute Category="FDV_BaneData" DataType="Enumeration" DisplayName="FDV011_Side(fra)" Name="FDV011_SideFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV011_Side(fra)"
				StandardValuesExclusive="true"
				Description="Objektets side av eget spor [Senter|Venstre|Høyre]. For objekt som ikke tilhører et jernbanespor (isolator i kontaktledning osv.) vises side av nærmeste spor. For linjeobjekt vises det startpunktets side av nærmeste spor. Hvilket spor som det henvises til vises i sveveteksten. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDV011_SideFra()' om du trenger å gjenskape den."
		>
			<Values>
				<!-- Merk: 'Ukjent' er ikke en tillatt kategori ved levering til BaneData. -->
				<Value>Ukjent</Value>
				<Value>Senter</Value>
				<Value>Venstre</Value>
				<Value>Høyre</Value>
			</Values>
		</CustomAttribute>
		
		<CustomAttribute Category="FDV_BaneData" DataType="Enumeration" DisplayName="FDV011_Side(til)" Name="FDV011_SideTil" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV011_Side(til)"
				StandardValuesExclusive="true"
				Description="Objektets side av eget spor [Senter|Venstre|Høyre]."
		>
			<Values>
				<!-- Merk: 'Ukjent' er ikke en tillatt kategori ved levering til BaneData. -->
				<Value>Ukjent</Value>
				<Value>Senter</Value>
				<Value>Venstre</Value>
				<Value>Høyre</Value>
			</Values>
		</CustomAttribute>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV012_Fag" Name="FDV012_Fag" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV012_Fag"
				Description="Fagkode iht Banedata"
		/>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV013_Objekttype" Name="FDV013_Objekttype" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV013_Objekttype"
				Description="Objekttype iht Banedata"
		/>
		
		<CustomAttribute Category="FDV_BaneData" DataType="String" DisplayName="FDV014_SporNr" Name="FDV014_SporNr" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV014_SporNr"
				Description="Spor nummer. Sporobjekt: Sporets navn/kode/id. Punktobjekter: Objektets eget jernbanespors navn/kode/id dersom objektet tilhører et jernbanespor. Punktobjekter som tilhører en annen linjetype enn jernbanespor eller som ikke tilhører en linje: Navn/kode/id for mest relevante jernbanespor benyttes. Linjeobjekter som ikke er jernbanespor: Som for punktobjekter som ikke tilhører et jernbanespor. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataSporNrFra()' om du trenger å gjenskape den."
		/>

		<CustomAttribute Category="FDV_BaneData" DataType="Enumeration" DisplayName="FDV015_Sportype" Name="FDV015_Sportype" DefaultValue="" 
				ExtendedDataPropertySet="FDV_BaneData" ExtendedDataPropertyDefinition="FDV015_Sportype" 
				StandardValuesExclusive="true"
				Description="Sporobjekt: Velg sportype [Ukjent | Hovedspor | Høyre hovedspor | Sidespor | Venstre hovedspor | Overkjøringsspor | Togspor | Øvrige spor] med Ctrl+UpArrow/DownArrow (formel beholdes), eller med F4 (formel slettes). Punktobjekter og linjeobjekter som ikke er jernbanspor: Ikke slett formelen - sportypen hentes automatisk fra det mest relevante sporet. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDV015_Sportype()' om du trenger å gjenskape den."
		>
			<Values>
				<!-- Merk: 'Ukjent' er ikke en tillatt kategori ved levering til BaneData. -->
				<Value>Ukjent</Value>
				<Value>Hovedspor</Value>
				<Value>Høyre hovedspor</Value>
				<Value>Sidespor</Value>
				<Value>Venstre hovedspor</Value>
				<Value>Overkjøringsspor</Value>
				<Value>Togspor</Value>
				<Value>Øvrige spor</Value>
			</Values>
		</CustomAttribute>





		<LuaExpression Name="FDV007_KmFra" >			<Formula>NOBN_com_Pset_FDV007_KmFra()</Formula></LuaExpression>
		<LuaExpression Name="FDV011_SideFra" >			<Formula>NOBN_com_Pset_FDV011_SideFra()</Formula></LuaExpression>
		<LuaExpression Name="FDV015_Sportype" >		<Formula>NOBN_com_Pset_FDV015_Sportype()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataSporNrFra" >		<Formula>NOBN_com_Pset_FDVBaneDataSporNrFra()</Formula></LuaExpression>
		<LuaExpression Name="FDV001_AvstandFraSpormidtFra" >	<Formula>NOBN_com_Pset_FDV001_AvstandFraSpormidtFra()</Formula></LuaExpression>


		
	</xpp:bloc>
</xpp:define>




    <LuaFunction Name="NOBN_com_Pset_FDV007_KmFra()" ReturnType="String"
		Description="Returnerer Km [Km] (ReferenceMileage). Punktobjekt: objektets Km målt som projeksjon på referansporet. Linjeobjekt: Startpunktets Km målt som projeksjon på linjens referansespor." >
        <Constructor>String NOBN_com_Pset_FDV007_KmFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDV007_KmFra()
				if RcAlignment then 
					--Linjeobjekt:
					x = RcAlignment.StartPoint.X
					y = RcAlignment.StartPoint.Y
					refId = getAlignmentInfo(this.id,x,y).ReferenceAlignmentId
					ai = getAlignmentInfo(refId,x,y)
					if ai.NormalProjectionExists then
						return string.format("%.03f",ai.Mileage/1000,3), 
							_info("Ref. "..RC__identify(getObjectFromId(refId)))
					else
						return _warning, "Ukjent",
							_info("Linjeobjektets startpunkt har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede Km.")
					end

				elseif Alignment then 
					--Punktobjekt som tilhører en linje:
					x = geoCoord.X
					y = geoCoord.Y
					if not getAlignmentInfo(Alignment.id,x,y).NormalProjectionExists then
						return _warning, "Ukjent",
							_info("Punktobjektet har ingen projeksjon på [Plassering langs linje].[Egen linje], kan ikke utlede Km.")
					end
					refId = getAlignmentInfo(Alignment.id,x,y).ReferenceAlignmentId
					ai = getAlignmentInfo(refId,x,y)
					if ai.NormalProjectionExists then
						return string.format("%.03f",ai.Mileage/1000,3), 
							_info("Ref. "..RC__identify(getObjectFromId(refId)))
					else
						return _warning, "Ukjent",
							_info("Punktobjektet har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede Km.")
					end

				else
					--Punktobjekt som ikke tilhører en linje:
					return _warning, "Ukjent", 
							_info("Punktobjektet mangler angivelse av [Plassering langs linje].[Egen linje], kan ikke utlede Km.")
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDV011_SideFra()" ReturnType="String"
		Description="Returnerer side av spor [Ukjent | Senter | Venstre | Høyre]. Punktobjekt: side i forhold til eget spor, eller side av nærmeste spor dersom objektet ikke tilhører et bestemt spor. Linjeobjekt: startpunktets side av referansesporet. Merk: 'Ukjent' er ikke en gyldig kategori ved levering til BaneData." >
        <Constructor>String NOBN_com_Pset_FDV011_SideFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDV011_SideFra()
				eps = 4e-4
				if RcAlignment then 
					--Linjeobjekt:
					x = RcAlignment.StartPoint.X
					y = RcAlignment.StartPoint.Y
					refId = getAlignmentInfo(this.id,x,y).ReferenceAlignmentId
					ai = getAlignmentInfo(refId,x,y)
					if ai.NormalProjectionExists then
						d = ai.DistanceToAlignment
						t = (math.abs(d) &lt; eps) and "Senter" or (d &lt; 0) and "Venstre" or "Høyre"
						return t, _info(t.." i forhold til referansespor "..RC__identify(getObjectFromId(refId))..".")
					else
						return _warning, "Ukjent",
							_info("Linjeobjektets startpunkt har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede side av spor.")
					end
				elseif Alignment then 
					--Punktobjekt som tilhører en linje:
					x = geoCoord.X
					y = geoCoord.Y
					if not getAlignmentInfo(Alignment.id,x,y).NormalProjectionExists then
						return _warning, "Ukjent",
							_info("Punktobjektet har ingen projeksjon på [Plassering langs linje].[Egen linje], kan ikke utlede side av spor.")
					end
					if Alignment.RcType == "JBTKO_SPO Spor" then
						--Punktobjekt som tilhører et jernbanespor:
						d = getAlignmentInfo(Alignment.id,x,y).DistanceToAlignment
						t = (math.abs(d) &lt; eps) and "Senter" or (d &lt; 0) and "Venstre" or "Høyre"
						return t, _info(t.." i forhold til eget spor "..RC__identify(Alignment))
					else
						--Punktobjekt som tilhører en linje som ikke er et jernbanespor:
						refId = getAlignmentInfo(Alignment.id,x,y).ReferenceAlignmentId
						ai = getAlignmentInfo(refId,x,y)
						if ai.NormalProjectionExists then
							d = ai.DistanceToAlignment
							t = (math.abs(d) &lt; eps) and "Senter" or (d &lt; 0) and "Venstre" or "Høyre"
							return t, _info(t.." i forhold til referansespor "..RC__identify(getObjectFromId(refId))..".")
						else
							return _warning, "Ukjent",
								_info("Punktobjektet har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede side av spor.")
						end
					end
				else
					--Punktobjekt som ikke tilhører en linje:
					return _warning, "Ukjent", 
						_info("Punktobjektet mangler angivelse av [Plassering langs linje].[Egen linje], kan ikke utlede side av spor.")
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDV015_Sportype()" ReturnType="String"
		Description="Identifiserer eget spors anvendelsestype [Ukjent | Hovedspor | Høyre hovedspor | Sidespor | Venstre hovedspor | Overkjøringsspor | Togspor | Øvrige spor]. Sporbjekter: sporets anvendelsestype. Øvrige linjeobjekter: nærmeste spors anvendelsestype ved linjens startpunkt. Punktobjekter: eget spors anvendelsestype, evt. nærmeste spors anvendelsestype dersom objektet ikke tilhører et bestemt spor. Merk: 'Ukjent' er ikke en gyldig kategori ved levering til BaneData." >
        <Constructor>String NOBN_com_Pset_FDV015_Sportype()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDV015_Sportype()
				if RcAlignment and RcType == "JBTKO_SPO Spor" then 
					--Linjeobjekt av type jernbanespor:
					--(Use getPropertyValue() to avoid an endless loop, since also tracks will be assigned this formula)
					return getPropertyValue("FDV015_Sportype")

				elseif Alignment and Alignment.RcType == "JBTKO_SPO Spor" then 
					--Punktobjekt i jernbanespor:
					return Alignment.FDV015_Sportype
					
				else
					--Ingen direkte angivelse av sportilhørighet:
					if RcAlignment then
						--Linjetype av annen type enn jernbanespor:
						x = RcAlignment.StartPoint.X
						y = RcAlignment.StartPoint.Y
					else
						--Punktobjekt i annen linjetype enn jernbanespor:
						x = geoCoord.X
						y = geoCoord.Y
					end
					t = getClosestTracks(x,y)
					n = getCollectionLength(t)
					--Exploit the fact that closest tracks are sorted by proximity:
					for i = 0,n-1 do
						ai = getAlignmentInfo(t[i].id,x,y)
						if ai.NormalProjectionExists then  
							return t[i].FDV015_Sportype
						end
					end
					--Fant ingen spor vi kunne projisere oss inn på:
					if RcAlignment then 
						return _warning, "Ukjent", 
							_info("Linjens startpunkt har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede tilhørende spors anvendelsestype.")
					else
						return _warning, "Ukjent", 
							_info("Punktobjektet har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede tilhørende spors anvendelsestype.")
					end
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDVBaneDataSporNrFra()" ReturnType="String"
		Description="Identifiserer sportilhørighet. Sporbjekter: sporets navn/kode/id. Øvrige linjeobjekter: nærmeste spors navn/kode/id ved linjens startpunkt. Punktobjekter: eget spors navn/kode/id, eller til nærmeste spors navn/kode/id dersom objektet ikke tilhører et bestemt spor." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataSporNrFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataSporNrFra()
				if RcAlignment and RcType == "JBTKO_SPO Spor" then 
					--Linjeobjekt av type jernbanespor:
					return RC__identify(this)

				elseif Alignment and Alignment.RcType == "JBTKO_SPO Spor" then 
					--Punktobjekt i jernbanespor:
					return RC__identify(Alignment)
					
				else
					--Ingen direkte angivelse av sportilhørighet:
					if RcAlignment then
						--Linjetype av annen type enn jernbanespor:
						x = RcAlignment.StartPoint.X
						y = RcAlignment.StartPoint.Y
					else
						--Punktobjekt i annen linjetype enn jernbanespor:
						x = geoCoord.X
						y = geoCoord.Y
					end
					t = getClosestTracks(x,y)
					n = getCollectionLength(t)
					--Exploit the fact that closest tracks are sorted by proximity:
					for i = 0,n-1 do
						ai = getAlignmentInfo(t[i].id,x,y)
						if ai.NormalProjectionExists then  
							return RC__identify(t[i])
						end
					end
					--Fant ingen spor vi kunne projisere oss inn på:
					if RcAlignment then 
						return _warning, "Linjens startpunkt har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede sportilhørighet."
					else
						return _warning, "Punktobjektet har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede sportilhørighet."
					end
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDV001_AvstandFraSpormidtFra()" ReturnType="String"
		Description="Retunerer vinkelrett avstand i meter til eget spor. Sporbjekter: Alltid null. Punktobjekter: vinkelrett avstand til eget spor eller til nærmeste spor dersom objektet ikke tilhører et bestemt spor. Øvrige linjeobjekter: vinkelrett sideveis avstand fra linjens startpunkt til nærmeste spor." >
        <Constructor>String NOBN_com_Pset_FDV001_AvstandFraSpormidtFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDV001_AvstandFraSpormidtFra()
				if RcAlignment and RcType == "JBTKO_SPO Spor" then 
					--Linjeobjekt av type jernbanespor:
					return string.format("%.03f",0.000), _info("Null avstand til seg selv, spor "..RC__identify(this))

				elseif Alignment and Alignment.RcType == "JBTKO_SPO Spor" then 
					--Punktobjekt i jernbanespor:
					return string.format("%.03f",RC__round(DistanceToAlignment)), _info("Avstand til spor "..RC__identify(Alignment))
					
				else
					--Ingen direkte angivelse av sportilhørighet:
					if RcAlignment then
						--Linjetype av annen type enn jernbanespor:
						x = RcAlignment.StartPoint.X
						y = RcAlignment.StartPoint.Y
					else
						--Punktobjekt tilhørende en annen linjetype enn jernbanespor:
						x = geoCoord.X
						y = geoCoord.Y
					end
					t = getClosestTracks(x,y)
					n = getCollectionLength(t)
					--Exploit the fact that closest tracks are sorted by proximity:
					for i = 0,n-1 do
						ai = getAlignmentInfo(t[i].id,x,y)
						if ai.NormalProjectionExists then  
							return string.format("%.03f",RC__round(ai.DistanceToAlignment)), _info("Avstand til spor "..RC__identify(t[i]))
						end
					end
					--Fant ingen spor vi kunne projisere oss inn på:
					if RcAlignment then 
						return _warning, 0, _info("Linjens startpunkt har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede avstand sideveis til noe spor.")
					else
						return _warning, 0, _info("Punktobjektet har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede avstand sideveis til noe spor.")
					end
				end
			end
        </Formula>
    </LuaFunction> 


<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>
