<!--========================================================================================================

    NO-BN-PsetFDVBaneData.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml" />.

	(c) Railcomplete AS, Norway, 2015-2023. All rights reserved.
	
=========================================================================================================-->
<xpp:bloc>

<!--========================================================================================================
	Extended data property sets (will be picked up by AutoCAD as Extended Data, and exports to IFC using Civil 3D)
=========================================================================================================-->

<!-- Datasettet "FDV BaneData" benyttes dersom det er objekter som skal registreres i BaneData. Disse objektene har  -->
<!-- fått Banedata ID under utarbeidelse av arbeidsgrunnlaget, og denne skal benyttes når supplerende informasjon skal sendes inn.  -->

<PropertySets>
	<ExtendedDataPropertySet Name="FDV BaneData" IsVisible="true" IsWritable="true" IsLocked="false" >
		<Properties>
			<ExtendedDataProperty Name="ObjektID" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="1" />
			<ExtendedDataProperty Name="Beskrivelse" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="2" />
			<ExtendedDataProperty Name="Tilhører objekt" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="3" />
			<ExtendedDataProperty Name="Tilhører lokasjon" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="4" />
			<ExtendedDataProperty Name="Navn/nr" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="5" />
			<ExtendedDataProperty Name="Idriftssatt dato" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="6" />
			<!-- Added to Pset by the RC agent ( changes all element's sort number: -->
			<ExtendedDataProperty Name="Referansespor(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="7" />
			<!-- End Pset addition -->
			<ExtendedDataProperty Name="Km(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="8" />
			<ExtendedDataProperty Name="Side(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="9" />
			<ExtendedDataProperty Name="Sportype(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="10" />
			<ExtendedDataProperty Name="Spornr. (fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="11" />
			<ExtendedDataProperty Name="Avst/Spormidt(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="12" />
			<ExtendedDataProperty Name="Eier" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="13" />
			<ExtendedDataProperty Name="Nord(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="14" />
			<ExtendedDataProperty Name="Øst(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="15" />
			<ExtendedDataProperty Name="Høyde(fra)" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="16" />
			<ExtendedDataProperty Name="Dokument referanse" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="17" />
			<ExtendedDataProperty Name="Serienr." DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="18" />
		</Properties>
	</ExtendedDataPropertySet>
</PropertySets>

<!--========================================================================================================
    ObjectType element 'CustomAttribute' macros for FDV BaneData
=========================================================================================================-->


 
 <!-- RailCOMPLETE benytter en extended data definisjon (element PropertySets / ExtendedDataPropertySet) for å definere et  -->
 <!-- property set som kan legges inn i objekters AutoCAD Extended Data. De dukker da opp i alle Autodesk produkter som  -->
 <!-- objektdata / Extended Data. -->
 
 <!-- Data som ligger som Extended Data i et AutoCAD-objekt vil "bli med på lasset" over til IFC dersom du har Civil 3D installert -->
 <!-- og benytter kommandoen for eksport til IFC, EXPORTIFC. -->

	<!-- <xpp:expand select="NOBN_com_PSET_FDV_BANEDATA" /> -->
<xpp:define name="NOBN_com_PSET_FDV_BANEDATA" >
	<xpp:bloc>

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData ObjektID" Name="FDVBaneDataObjektID" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="ObjektID"
				Description="Read-only gjengivelse av property [Pset Bane NOR].BaneNORBaneDataID, med kontroll mot formatkravet 'ff-ttt-nnnnnn'. Tomt felt eller galt formatert kode er ikke en gyldig kategori ved levering til BaneData. Fagkode ff er en av KU, KO, EH,SA, TE, EL. Objekttype skal ha tre bokstaver som samsvarer med innmeldingsarkene for Banedata fagkoden. Tallet skal være seks-sifret, større enn null og unikt innenfor fagkode og objekttype. Bruk RC Object Manager med visning av property [Pset FDV BaneData].FDVBaneDataObjektID og sorter på denne i sorteringsmodus 'Include symbols in sort' for å lete etter duplikater og 'hull' før levering til BaneData. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataObjektID()' om du trenger å gjenskape den."
				ReadOnly="false"
		/>

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Beskrivelse" Name="FDVBaneDataBeskrivelse" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Beskrivelse"
				Description="Kopi av [Pset Bane NOR].BaneNORBeskrivelse (readonly)."
				ReadOnly="false" 
		/>

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Tilhører objekt" Name="FDVBaneDataTilhorerObjekt" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Tilhører objekt"
				Description="Angi BaneData Objekt-ID for nærmeste forelder-objekt."
		/>
				
		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Tilhører lokasjon" Name="FDVBaneDataTilhorerLokasjon" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Tilhører lokasjon"
				Description="Angi BaneData lokasjonskode."
		/>
				
		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Navn/nr" Name="FDVBaneDataNavnnr" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Navn/nr"
		/>
		
		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Idriftssatt dato" Name="FDVBaneDataIdriftssattDato" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Idriftssatt dato"
				Description="Angi dato for idriftsettelse på ISO standard format YYYY-MM-DD."
		/>

		<!-- Added to Pset by the RC agent: -->
		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Referansespor(fra)" Name="FDVBaneDataReferansesporFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Referansespor(fra)"
				Description="Objektets referansespor for beregning av Km. For linjeobjekter angis referansesporet som er definert i linjeobjektets startpunkt. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataReferansesporFra()' om du trenger å gjenskape den. MERK: For at referansespor-Km skal kunne utledes korrekt så må (1) absolutt alle punktobjekter tilhøre en egen linje (property [Plassering langs linje].[Egen linje]), og (2) absolutt alle linjer må definere hvilket referansespor de avhenger av. For å definere et linjeobjekts referansespor: (a) Start kommando 'RC-AlignmentManager' (b) Åpne flik 'Reference Alignment' (c) Aktiver editeringsmodus (d) Selekter linjeobjektet (e) Editer radene i tabellvisningen. Dersom tabellen er tom så er sporet sin egen referanse (og kan være referanse for andre linjer). Hver rad i tabellen angir et startsted i linjen samt hvilken linje som er dens referansespor herfra. Angivelsen gjelder fram til neste rads startpunkt, eller til linjens ende."
				ReadOnly="false"
		/>
		<!-- End Pset addition -->

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Km(fra)" Name="FDVBaneDataKmFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Km(fra)"
				Description="Objektets referansespor-kilometer [km] (readonly). For objekt som ikke tilhører et jernbanespor (isolator i kontaktledning osv.) vises referansespor-km utledet fra objektets projeksjon inn på nærmeste spor. For linjeobjekt vises det startpunktets referansespor-kilometer. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataKmFra()' om du trenger å gjenskape den."
				ReadOnly="false" 
		/>

		<CustomAttribute Category="Pset FDV BaneData" DataType="Enumeration" DisplayName="Pset FDV BaneData Side(fra)" Name="FDVBaneDataSideFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Side(fra)"
				StandardValuesExclusive="true"
				Description="Objektets side av eget spor [Senter|Venstre|Høyre] (readonly). For objekt som ikke tilhører et jernbanespor (isolator i kontaktledning osv.) vises side av nærmeste spor. For linjeobjekt vises det startpunktets side av nærmeste spor. Hvilket spor som det henvises til vises i sveveteksten. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataSideFra()' om du trenger å gjenskape den."
				ReadOnly="false"
		>
			<Values>
				<!-- Merk: 'Ukjent' er ikke en tillatt kategori ved levering til BaneData. -->
				<Value>Ukjent</Value>
				<Value>Senter</Value>
				<Value>Venstre</Value>
				<Value>Høyre</Value>
			</Values>
		</CustomAttribute>

		<CustomAttribute Category="Pset FDV BaneData" DataType="Enumeration" DisplayName="Pset FDV BaneData Sportype(fra)" Name="FDVBaneDataSportypeFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Sportype(fra)" 
				StandardValuesExclusive="true"
				Description="Sporobjekt: Velg sportype [Ukjent | Hovedspor | Høyre hovedspor | Sidespor | Venstre hovedspor | Overkjøringsspor | Togspor | Øvrige spor] med Ctrl+UpArrow/DownArrow (formel beholdes), eller med F4 (formel slettes). Punktobjekter og linjeobjekter som ikke er jernbanspor: Ikke slett formelen - sportypen hentes automatisk fra det mest relevante sporet. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataSportypeFra()' om du trenger å gjenskape den."
		>
			<Values>
				<!-- Merk: 'Ukjent' er ikke en tillatt kategori ved levering til BaneData. -->
				<Value>Ukjent</Value>
				<Value>Hovedspor</Value>
				<Value>Høyre hovedspor</Value>
				<Value>Sidespor</Value>
				<Value>Venstre hovedspor</Value>
				<Value>Overkjøringsspor</Value>
				<Value>Togspor</Value>
				<Value>Øvrige spor</Value>
			</Values>
		</CustomAttribute>

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Spornr.(fra)" Name="FDVBaneDataSporNrFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Spornr.(fra)"
				Description="Tilhørighet til relevant spor. Sporobjekt: Sporets navn/kode/id. Punktobjekter: Objektets eget jernbanespors navn/kode/id dersom objektet tilhører et jernbanespor. Punktobjekter som tilhører en annen linjetype enn jernbanespor eller som ikke tilhører en linje: Navn/kode/id for mest relevante jernbanespor benyttes. Linjeobjekter som ikke er jernbanespor: Som for punktobjekter som ikke tilhører et jernbanespor. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataSporNrFra()' om du trenger å gjenskape den."
		/>

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Avst/Spormidt(fra)" Name="FDVBaneDataAvstSpormidtFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Avst/Spormidt(fra)"
				Description="Avstand i meter til relevant spor. Punktobjekt som tilhører et jernbanespor: Avstand måles fra objektets innsettingspunkt vinkelrett inn på eget spor. Punktobjekt som ikke tilhører et jernbanespor: Avstand måles fra objektets innsettingspunkt vinkelrett inn på mest relevante spor. Jernbanespor: Avstanden er alltid null (til seg selv). Linjeobjekter som ikke er jernbanespor: Som for punktobjekter som ikke tilhører et jernbanespor. Trykk F3 og skriv inn formelens navn 'NOBN_com_Pset_FDVBaneDataAvstSpormidtFra()' om du trenger å gjenskape den."
		/>

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Eier" Name="FDVBaneDataEier" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Eier" />

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Nord(fra)" Name="FDVBaneDataNordFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Nord(fra)" />

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Øst(fra)" Name="FDVBaneDataØstFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Øst(fra)" />

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Høyde(fra)" Name="FDVBaneDataHøydeFra" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Høyde(fra)" />

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Dokument referanse" Name="FDVBaneDataDokumentReferanse" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Dokument referanse" />

		<CustomAttribute Category="Pset FDV BaneData" DataType="String" DisplayName="Pset FDV BaneData Serienr." Name="FDVBaneDataSerienr" DefaultValue="" 
				ExtendedDataPropertySet="FDV BaneData" ExtendedDataPropertyDefinition="Serienr." />

		<!-- Pset automation expressions (declared inside each instantiated object) -->
		<LuaExpression Name="FDVBaneDataObjektID" >			<Formula>NOBN_com_FDVBaneDataObjektID()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataBeskrivelse" >		<Formula>NOBN_com_FDVBaneDataBeskrivelse()</Formula></LuaExpression>
		<!-- FDVBaneDataTilhorerObjekt -->		<!-- TODO: Deduce value from new relation "tilhører objekt", or other method(s) -->
		<!-- FDVBaneDataTilhorerLokasjon -->
		<!-- FDVBaneDataNavnnr -->
		<!-- FDVBaneDataIdriftssattDato -->
		<LuaExpression Name="FDVBaneDataReferansesporFra" >	<Formula>NOBN_com_Pset_FDVBaneDataReferansesporFra()</Formula></LuaExpression> <!-- Added by the RC Agent -->
		<LuaExpression Name="FDVBaneDataKmFra" >			<Formula>NOBN_com_Pset_FDVBaneDataKmFra()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataSideFra" >			<Formula>NOBN_com_Pset_FDVBaneDataSideFra()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataSportypeFra" >		<Formula>NOBN_com_Pset_FDVBaneDataSportypeFra()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataSporNrFra" >		<Formula>NOBN_com_Pset_FDVBaneDataSporNrFra()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataAvstSpormidtFra" >	<Formula>NOBN_com_Pset_FDVBaneDataAvstSpormidtFra()</Formula></LuaExpression>
		<!-- FDVBaneDataEier -->
		<LuaExpression Name="FDVBaneDataNordFra" >			<Formula>NOBN_com_FDVBaneDataNordFra()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataØstFra" >			<Formula>NOBN_com_FDVBaneDataOestFra()</Formula></LuaExpression>
		<LuaExpression Name="FDVBaneDataHøydeFra" >			<Formula>NOBN_com_FDVBaneDataHoeydeFra()</Formula></LuaExpression>
		<!-- FDVBaneDataDokumentReferanse -->
		<!-- FDVBaneDataSerienr -->
		
	</xpp:bloc>
</xpp:define>


	<!-- Pset global automation functions (kept in DNA, called from object instances) -->
	<!-- Forutsetning: (1) Alle punktobjekter tilhører en linje (2) Alle linjer angir korrekt sitt/sine referansespor -->

    <LuaFunction Name="NOBN_com_FDVBaneDataObjektID()" ReturnType="String"
		Description="Returnerer BaneData Objekt-ID og utfører en formatkontroll 'ff-ttt-nnnnnn'." >
        <Constructor>String NOBN_com_FDVBaneDataObjektID()</Constructor>
        <Formula>
			function NOBN_com_FDVBaneDataObjektID()
				a,b,c = BaneNORBaneDataID:upper():match("^(%a%a)%-(%a%a%a)%-(%d%d%d%d%d%d)$")
				if a and b and c then 
					--Syntax OK, check semantics:
					if a == "KU" or a == "KO" or a == "EH" or a == "SA" or a == "TE" or a == "EL" then
						if tonumber(c) == 0 then
							return _warning, string.format("%s-%s-%06d",a:upper(),b:upper(),tonumber(c)),
								_info("Objekt-ID format er syntaktisk korrekt, men nummer kan ikke være null.")
						else
							return string.format("%s-%s-%06d",a:upper(),b:upper(),tonumber(c)),
								_info("Objekt-ID format er syntaktisk korrekt, men unikhet er ikke kontrollert her.")
						end
					elseif a == "FE" then
						return _warning, string.format("%s-%s-%06d",a:upper(),b:upper(),tonumber(c)),
							_info("Objekt-ID av kategori 'FE-xxx-nnnnnn' må avklares med Bane NOR ved levering til BaneData.")
					else
						return _warning, string.format("%s-%s-%06d",a:upper(),b:upper(),tonumber(c)),
							_info("Objekt-ID av ukjent kategori må avklares med Bane NOR ved levering til BaneData.")
					end
				else
					return _warning, "Formatfeil", _info("[Pset Bane NOR].BaneDataID må korrigeres, se denne.")
				end
			end
        </Formula>
    </LuaFunction> 
	


    <LuaFunction Name="NOBN_com_FDVBaneDataBeskrivelse()" ReturnType="String"
		Description="Returnerer en beskrivelse, hentet fra [Pset Bane NOR].BaneNORBeskrivelse. Verdien kan være blank (tomt felt)." >
        <Constructor>String NOBN_com_FDVBaneDataBeskrivelse()</Constructor>
        <Formula>
			function NOBN_com_FDVBaneDataBeskrivelse()
				return BaneNORBeskrivelse, _info("Verdi er hentet fra [Pset Bane NOR].Beskrivelse")
			end
        </Formula>
    </LuaFunction> 



    <LuaFunction Name="NOBN_com_Pset_FDVBaneDataReferansesporFra()" ReturnType="String"
		Description="Returnerer referansespor for punktobjekt, eller referansespor i linjeobjekts startpunkt. MERK: For at referansespor-Km skal kunne utledes korrekt så må (1) absolutt alle punktobjekter tilhøre en egen linje (property [Plassering langs linje].[Egen linje]), og (2) absolutt alle linjer må definere hvilket referansespor de avhenger av. For å definere et linjeobjekts referansespor: (a) Start kommando 'RC-AlignmentManager' (b) Åpne flik 'Reference Alignment' (c) Aktiver editeringsmodus (d) Selekter linjeobjektet (e) Editer radene i tabellvisningen. Dersom tabellen er tom så er sporet sin egen referanse (og kan være referanse for andre linjer). Hver rad i tabellen angir et startsted i linjen samt hvilken linje som er dens referansespor herfra. Angivelsen gjelder fram til neste rads startpunkt, eller til linjens ende." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataReferansesporFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataReferansesporFra()
				if RcAlignment then 
					--Linjeobjekt:
					x = RcAlignment.StartPoint.X
					y = RcAlignment.StartPoint.Y
					refId = getAlignmentInfo(this.id,x,y).ReferenceAlignmentId
					if getObjectFromId(refId).RcType ~= rctype_Track then
						return _warning, (getObjectFromId(refId).name or getObjectFromId(refId).code or ""),
							_info("Referansesporet "..RC__identify(getObjectFromId(refId)).." som er angitt i linjeobjektets startpunkt må ha RcType '"..rctype_Track.."'.")
					else
						if refId == this.id then
							return (getObjectFromId(refId).name or getObjectFromId(refId).code or ""), _info(refId).." (self)"
						else
							return (getObjectFromId(refId).name or getObjectFromId(refId).code or ""), _info(refId)
						end
					end

				elseif Alignment then 
					--Punktobjekt som tilhører en linje:
					x = geoCoord.X
					y = geoCoord.Y
					if not getAlignmentInfo(Alignment.id,x,y).NormalProjectionExists then
						return _warning, "Ukjent",
						_info("Punktobjektet har ingen projeksjon på [Plassering langs linje].[Egen linje], kan ikke utlede hvilket referansespor som er gjeldende.")
					end
					refId = getAlignmentInfo(Alignment.id,x,y).ReferenceAlignmentId
					if getObjectFromId(refId).RcType ~= rctype_Track then
						return _warning, refId.." / "..(getObjectFromId(refId).name or getObjectFromId(refId).code or ""),
							_info("Punktobjektets referansespor "..RC__identify(getObjectFromId(refId)).." må ha RcType '"..rctype_Track.."'.")
					else
						return (getObjectFromId(refId).name or getObjectFromId(refId).code or ""), _info(refId)
					end

				else
					--Punktobjekt som ikke tilhører en linje:
					return _warning, "Ukjent", 
						_info("Punktobjektet mangler angivelse av [Plassering langs linje].[Egen linje], kan ikke utlede hvilket referansespor som er gjeldende.")
				end
			end
        </Formula>
    </LuaFunction> 



    <LuaFunction Name="NOBN_com_Pset_FDVBaneDataKmFra()" ReturnType="String"
		Description="Returnerer Km [Km] (ReferenceMileage). Punktobjekt: objektets Km målt som projeksjon på referansporet. Linjeobjekt: Startpunktets Km målt som projeksjon på linjens referansespor." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataKmFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataKmFra()
				if RcAlignment then 
					--Linjeobjekt:
					x = RcAlignment.StartPoint.X
					y = RcAlignment.StartPoint.Y
					refId = getAlignmentInfo(this.id,x,y).ReferenceAlignmentId
					ai = getAlignmentInfo(refId,x,y)
					if ai.NormalProjectionExists then
						return string.format("%.03f",ai.Mileage/1000,3), 
							_info("Ref. "..RC__identify(getObjectFromId(refId)))
					else
						return _warning, "Ukjent",
							_info("Linjeobjektets startpunkt har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede Km.")
					end

				elseif Alignment then 
					--Punktobjekt som tilhører en linje:
					x = geoCoord.X
					y = geoCoord.Y
					if not getAlignmentInfo(Alignment.id,x,y).NormalProjectionExists then
						return _warning, "Ukjent",
							_info("Punktobjektet har ingen projeksjon på [Plassering langs linje].[Egen linje], kan ikke utlede Km.")
					end
					refId = getAlignmentInfo(Alignment.id,x,y).ReferenceAlignmentId
					ai = getAlignmentInfo(refId,x,y)
					if ai.NormalProjectionExists then
						return string.format("%.03f",ai.Mileage/1000,3), 
							_info("Ref. "..RC__identify(getObjectFromId(refId)))
					else
						return _warning, "Ukjent",
							_info("Punktobjektet har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede Km.")
					end

				else
					--Punktobjekt som ikke tilhører en linje:
					return _warning, "Ukjent", 
							_info("Punktobjektet mangler angivelse av [Plassering langs linje].[Egen linje], kan ikke utlede Km.")
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDVBaneDataSideFra()" ReturnType="String"
		Description="Returnerer side av spor [Ukjent | Senter | Venstre | Høyre]. Punktobjekt: side i forhold til eget spor, eller side av nærmeste spor dersom objektet ikke tilhører et bestemt spor. Linjeobjekt: startpunktets side av referansesporet. Merk: 'Ukjent' er ikke en gyldig kategori ved levering til BaneData." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataSideFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataSideFra()
				eps = 4e-4
				if RcAlignment then 
					--Linjeobjekt:
					x = RcAlignment.StartPoint.X
					y = RcAlignment.StartPoint.Y
					refId = getAlignmentInfo(this.id,x,y).ReferenceAlignmentId
					ai = getAlignmentInfo(refId,x,y)
					if ai.NormalProjectionExists then
						d = ai.DistanceToAlignment
						t = (math.abs(d) &lt; eps) and "Senter" or (d &lt; 0) and "Venstre" or "Høyre"
						return t, _info(t.." i forhold til referansespor "..RC__identify(getObjectFromId(refId))..".")
					else
						return _warning, "Ukjent",
							_info("Linjeobjektets startpunkt har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede side av spor.")
					end
				elseif Alignment then 
					--Punktobjekt som tilhører en linje:
					x = geoCoord.X
					y = geoCoord.Y
					if not getAlignmentInfo(Alignment.id,x,y).NormalProjectionExists then
						return _warning, "Ukjent",
							_info("Punktobjektet har ingen projeksjon på [Plassering langs linje].[Egen linje], kan ikke utlede side av spor.")
					end
					if Alignment.RcType == rctype_Track then
						--Punktobjekt som tilhører et jernbanespor:
						d = getAlignmentInfo(Alignment.id,x,y).DistanceToAlignment
						t = (math.abs(d) &lt; eps) and "Senter" or (d &lt; 0) and "Venstre" or "Høyre"
						return t, _info(t.." i forhold til eget spor "..RC__identify(Alignment))
					else
						--Punktobjekt som tilhører en linje som ikke er et jernbanespor:
						refId = getAlignmentInfo(Alignment.id,x,y).ReferenceAlignmentId
						ai = getAlignmentInfo(refId,x,y)
						if ai.NormalProjectionExists then
							d = ai.DistanceToAlignment
							t = (math.abs(d) &lt; eps) and "Senter" or (d &lt; 0) and "Venstre" or "Høyre"
							return t, _info(t.." i forhold til referansespor "..RC__identify(getObjectFromId(refId))..".")
						else
							return _warning, "Ukjent",
								_info("Punktobjektet har ikke en projeksjon på referansespor "..RC__identify(getObjectFromId(refId))..", kan ikke utlede side av spor.")
						end
					end
				else
					--Punktobjekt som ikke tilhører en linje:
					return _warning, "Ukjent", 
						_info("Punktobjektet mangler angivelse av [Plassering langs linje].[Egen linje], kan ikke utlede side av spor.")
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDVBaneDataSportypeFra()" ReturnType="String"
		Description="Identifiserer eget spors anvendelsestype [Ukjent | Hovedspor | Høyre hovedspor | Sidespor | Venstre hovedspor | Overkjøringsspor | Togspor | Øvrige spor]. Sporbjekter: sporets anvendelsestype. Øvrige linjeobjekter: nærmeste spors anvendelsestype ved linjens startpunkt. Punktobjekter: eget spors anvendelsestype, evt. nærmeste spors anvendelsestype dersom objektet ikke tilhører et bestemt spor. Merk: 'Ukjent' er ikke en gyldig kategori ved levering til BaneData." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataSportypeFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataSportypeFra()
				if RcAlignment and RcType == rctype_Track then 
					--Linjeobjekt av type jernbanespor:
					--(Use getPropertyValue() to avoid an endless loop, since also tracks will be assigned this formula)
					return getPropertyValue("FDVBaneDataSporTypeFra")

				elseif Alignment and Alignment.RcType == rctype_Track then 
					--Punktobjekt i jernbanespor:
					return Alignment.FDVBaneDataSporTypeFra
					
				else
					--Ingen direkte angivelse av sportilhørighet:
					if RcAlignment then
						--Linjetype av annen type enn jernbanespor:
						x = RcAlignment.StartPoint.X
						y = RcAlignment.StartPoint.Y
					else
						--Punktobjekt i annen linjetype enn jernbanespor:
						x = geoCoord.X
						y = geoCoord.Y
					end
					t = getClosestTracks(x,y)
					n = getCollectionLength(t)
					--Exploit the fact that closest tracks are sorted by proximity:
					for i = 0,n-1 do
						ai = getAlignmentInfo(t[i].id,x,y)
						if ai.NormalProjectionExists then  
							return t[i].FDVBaneDataSporTypeFra
						end
					end
					--Fant ingen spor vi kunne projisere oss inn på:
					if RcAlignment then 
						return _warning, "Ukjent", 
							_info("Linjens startpunkt har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede tilhørende spors anvendelsestype.")
					else
						return _warning, "Ukjent", 
							_info("Punktobjektet har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede tilhørende spors anvendelsestype.")
					end
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDVBaneDataSporNrFra()" ReturnType="String"
		Description="Identifiserer sportilhørighet. Sporbjekter: sporets navn/kode/id. Øvrige linjeobjekter: nærmeste spors navn/kode/id ved linjens startpunkt. Punktobjekter: eget spors navn/kode/id, eller til nærmeste spors navn/kode/id dersom objektet ikke tilhører et bestemt spor." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataSporNrFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataSporNrFra()
				if RcAlignment and RcType == rctype_Track then 
					--Linjeobjekt av type jernbanespor:
					return RC__identify(this)

				elseif Alignment and Alignment.RcType == rctype_Track then 
					--Punktobjekt i jernbanespor:
					return RC__identify(Alignment)
					
				else
					--Ingen direkte angivelse av sportilhørighet:
					if RcAlignment then
						--Linjetype av annen type enn jernbanespor:
						x = RcAlignment.StartPoint.X
						y = RcAlignment.StartPoint.Y
					else
						--Punktobjekt i annen linjetype enn jernbanespor:
						x = geoCoord.X
						y = geoCoord.Y
					end
					t = getClosestTracks(x,y)
					n = getCollectionLength(t)
					--Exploit the fact that closest tracks are sorted by proximity:
					for i = 0,n-1 do
						ai = getAlignmentInfo(t[i].id,x,y)
						if ai.NormalProjectionExists then  
							return RC__identify(t[i])
						end
					end
					--Fant ingen spor vi kunne projisere oss inn på:
					if RcAlignment then 
						return _warning, "Linjens startpunkt har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede sportilhørighet."
					else
						return _warning, "Punktobjektet har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede sportilhørighet."
					end
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_Pset_FDVBaneDataAvstSpormidtFra()" ReturnType="String"
		Description="Retunerer vinkelrett avstand i meter til eget spor. Sporbjekter: Alltid null. Punktobjekter: vinkelrett avstand til eget spor eller til nærmeste spor dersom objektet ikke tilhører et bestemt spor. Øvrige linjeobjekter: vinkelrett sideveis avstand fra linjens startpunkt til nærmeste spor." >
        <Constructor>String NOBN_com_Pset_FDVBaneDataAvstSpormidtFra()</Constructor>
        <Formula>
			function NOBN_com_Pset_FDVBaneDataAvstSpormidtFra()
				if RcAlignment and RcType == rctype_Track then 
					--Linjeobjekt av type jernbanespor:
					return string.format("%.03f",0.000), _info("Null avstand til seg selv, spor "..RC__identify(this))

				elseif Alignment and Alignment.RcType == rctype_Track then 
					--Punktobjekt i jernbanespor:
					return string.format("%.03f",RC__round(DistanceToAlignment)), _info("Avstand til spor "..RC__identify(Alignment))
					
				else
					--Ingen direkte angivelse av sportilhørighet:
					if RcAlignment then
						--Linjetype av annen type enn jernbanespor:
						x = RcAlignment.StartPoint.X
						y = RcAlignment.StartPoint.Y
					else
						--Punktobjekt tilhørende en annen linjetype enn jernbanespor:
						x = geoCoord.X
						y = geoCoord.Y
					end
					t = getClosestTracks(x,y)
					n = getCollectionLength(t)
					--Exploit the fact that closest tracks are sorted by proximity:
					for i = 0,n-1 do
						ai = getAlignmentInfo(t[i].id,x,y)
						if ai.NormalProjectionExists then  
							return string.format("%.03f",RC__round(ai.DistanceToAlignment)), _info("Avstand til spor "..RC__identify(t[i]))
						end
					end
					--Fant ingen spor vi kunne projisere oss inn på:
					if RcAlignment then 
						return _warning, 0, _info("Linjens startpunkt har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede avstand sideveis til noe spor.")
					else
						return _warning, 0, _info("Punktobjektet har ikke en projeksjon på noen av sporene i modellen, kan ikke utlede avstand sideveis til noe spor.")
					end
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_FDVBaneDataNordFra()" ReturnType="String"
		Description="Returnerer nord-koordinat. Punktobjekt: Y-koordinat i gjeldende horisontalt datum. Linjeobjekt: startpunktets Y-koordinat i gjeldende horisontalt datum." >
        <Constructor>String NOBN_com_FDVBaneDataNordFra()</Constructor>
        <Formula>
			function NOBN_com_FDVBaneDataNordFra()
				if RcAlignment then
					--Alignment object:
					return RC__round(RcAlignment.StartPoint.Y,3), _info("Nord (Y) i kartprojeksjon "..DocumentData.CoordinateSystem)
				else
					--Point object:
					return string.format("%.3f",geoCoord.Y), _info("Nord (Y) i kartprojeksjon "..DocumentData.CoordinateSystem)
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_FDVBaneDataOestFra()" ReturnType="String"
		Description="Returnerer øst-koordinat. Punktobjekt: X-koordinat i gjeldende horisontalt datum. Linjeobjekt: startpunktets X-koordinat i gjeldende horisontalt datum." >
        <Constructor>String NOBN_com_FDVBaneDataOestFra()</Constructor>
        <Formula>
			function NOBN_com_FDVBaneDataOestFra()
				if RcAlignment then
					--Alignment object:
					return RC__round(RcAlignment.StartPoint.X,3), _info("Øst (X) i kartprojeksjon "..DocumentData.CoordinateSystem)
				else
					--Point object:
					return string.format("%.3f",geoCoord.X), _info("Øst (X) i kartprojeksjon "..DocumentData.CoordinateSystem)
				end
			end
        </Formula>
    </LuaFunction> 



	<LuaFunction Name="NOBN_com_FDVBaneDataHoeydeFra()" ReturnType="String"
		Description="Returnerer høyde over midlere havnivå. Punktobjekt: Z-koordinat i gjeldende vertikalt datum. Linjeobjekt: startpunktets Z-koordinat i gjeldende vertikalt datum." >
        <Constructor>String NOBN_com_FDVBaneDataHoeydeFra()</Constructor>
        <Formula>
			function NOBN_com_FDVBaneDataHoeydeFra()
				if RcAlignment then
					--Alignment object:
					return RC__round(RcAlignment.StartPoint.Z,3), _info("Høyde over midlere havnivå (Z) i vertikalt datum "..DocumentData.CoordinateSystem)
				else
					--Point object:
					return string.format("%.3f",geoCoord.Z), _info("Høyde over midlere havnivå (Z) i vertikalt datum "..DocumentData.CoordinateSystem)
				end
			end
        </Formula>
    </LuaFunction> 



<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>
