<!--========================================================================================================

    NO-BN-PsetBaneNOR.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml"/>.

	Copyright (c) 2015-2024 Railcomplete AS, Norway, NO916118503
	
=========================================================================================================-->
<xpp:bloc>

<!--========================================================================================================
	Extended data property sets (will be picked up by AutoCAD as Extended Data, and exports to IFC using Civil 3D)
=========================================================================================================-->

<!-- «Bane NOR» skal inneholde data om område- og faginndeling, info om riving/bygging og MMI nivå -->
<!-- Datasettet og finnes under …\BIM\Config\ISY\Properties. -->

<PropertySets>
	<ExtendedDataPropertySet Name="Bane NOR" IsVisible="true" IsWritable="true" IsLocked="false">
		<Properties>
			<ExtendedDataProperty Name="Modelltype" DataType="Text" Description="«Fagmodell» eller «Grunnlagsmodell»" DefaultValue="---" IsVisible="true" DisplayOrder="1"/>
			<ExtendedDataProperty Name="BaneData ID" DataType="Text" Description="BaneData ID nummer" DefaultValue="---" IsVisible="true" DisplayOrder="2"/>
			<ExtendedDataProperty Name="Rives" DataType="Text" Description="«Ja» eller «Nei»" DefaultValue="---" IsVisible="true" DisplayOrder="3"/>
			<ExtendedDataProperty Name="Rives fase" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="4"/>
			<ExtendedDataProperty Name="Bygges fase" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="5"/>
			<ExtendedDataProperty Name="Beskrivelse" DataType="Text" Description="Beskrivelse tekst fra BaneData" DefaultValue="---" IsVisible="true" DisplayOrder="6"/>
			<ExtendedDataProperty Name="Rives av" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="7"/>
			<ExtendedDataProperty Name="Bygges av" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="8"/>
			<ExtendedDataProperty Name="Fag" DataType="Text" Description="Se «Fagkoder Bane NOR»" DefaultValue="---" IsVisible="true" DisplayOrder="9"/>
			<ExtendedDataProperty Name="Prosjekterende" DataType="Text" Description="" DefaultValue="" IsVisible="true" DisplayOrder="10"/>
			<ExtendedDataProperty Name="Type og dimensjon" DataType="Text" Description="Kort faglig forklaring" DefaultValue="---" IsVisible="true" DisplayOrder="11"/>
			<ExtendedDataProperty Name="MMI" DataType="Text" Description="" DefaultValue="---" IsVisible="true" DisplayOrder="12"/>
		</Properties>
	</ExtendedDataPropertySet>
</PropertySets>



<!--========================================================================================================
    ObjectType element 'CustomProperty' macros for Bane NOR koder
=========================================================================================================-->


 
 <!-- RailCOMPLETE benytter en extended data definisjon (element PropertySets / ExtendedDataPropertySet) for å definere et  -->
 <!-- property set som kan legges inn i objekters AutoCAD Extended Data. De dukker da opp i alle Autodesk produkter som  -->
 <!-- objektdata / Extended Data. -->
 
 <!-- Data som ligger som Extended Data i et AutoCAD-objekt vil "bli med på lasset" over til IFC dersom du har Civil 3D installert -->
 <!-- og benytter kommandoen for eksport til IFC, EXPORTIFC. -->

	

	<!-- <xpp:expand select="NOBN_com_PSET_BANE_NOR"/> -->
<xpp:define name="NOBN_com_PSET_BANE_NOR">
	<xpp:bloc>
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Modelltype" Name="BaneNORModelltype" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Modelltype"/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR BaneData ID" Name="BaneNORBaneDataID" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="BaneData ID" 
				Description="Formatkrav : FF-TTT-nnnnnn (fagkode, objekttype, 6-sifret tall)."
		/>				
				
	    <CustomProperty Category="Pset Bane NOR" DataType="Enumeration" DisplayName="Pset Bane NOR Rives" Name="BaneNORRives" DefaultValue="Ukjent"
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Rives" 
				StandardValuesExclusive="true"
				Description="Avledet fra [Generelt].[Fasekode XXxx-YYyy] (Stage). Rivestatus er 'Ja' dersom objektet har en firesifret rivefase YYyy lavere enn '9999', dette representerer 'rives før prosjektavslutning'. Rivestatus er 'Nei' dersom YYyy er '9999', dette representerer 'blir værende i anlegget etter prosjektavslutning'. Rivestatus er 'Ukjent' dersom property [Generelt].[Fasekode XXxx-YYyy] ikke tilfredsstiller formatkravet 'XXxx-YYyy'."		
		>
			<Values>
				<Value>Ukjent</Value>
				<Value>Ja</Value>
				<Value>Nei</Value>
			</Values>
		</CustomProperty>
		
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Rives fase" Name="BaneNORRivesFase" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Rives fase"
				Description="Avledet fra [Generelt].[Fasekode XXxx-YYyy] (Stage). Rivefasen er de fire siste sifrene YYyy i fasekoden, dette representerer 'Utgår mot hovedfase YY, underfase yy'. Returnerer '---' dersom objektet aldri rives. Returnerer 'Ukjent' dersom fasekoden ikke har gyldig format 'XXxx-YYyy' eller dersom ingen faseinformasjon er angitt."		
		/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Bygges fase" Name="BaneNORByggesFase" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Bygges fase"
				Description="Avledet fra [Generelt].[Fasekode XXxx-YYyy] (Stage). Byggefasen er de fire første sifrene XXxx i fasekoden, dette representerer 'Oppstår i hovedfase XX, underfase xx'. 'Ukjent' vises dersom ingen gyldig byggefase kunne utledes fra fasekoden."	
		/>

	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Beskrivelse" Name="BaneNORBeskrivelse" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Beskrivelse"/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Rives av" Name="BaneNORRivesAv" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Rives av"/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Bygges av" Name="BaneNORByggesAv" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Bygges av"/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Fag" Name="BaneNORFag" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Fag"
				Description="Avledet fra [Generelt].[Fag] (discipline). Byggefasen er de fire første sifrene XXxx i fasekoden, dette representerer 'Oppstår i hovedfase XX, underfase xx'. '---' vises dersom ingen gyldig byggefase kunne utledes fra fasekoden."
		/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Prosjekterende" Name="BaneNORProsjekterende" DefaultValue=""
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Prosjekterende"/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR Type og dimensjon" Name="BaneNORTypeOgDimensjon" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="Type og dimensjon"/>
				
	    <CustomProperty Category="Pset Bane NOR" DataType="String" DisplayName="Pset Bane NOR MMI" Name="BaneNORMMI" DefaultValue="" 
				ExtendedDataPropertySet="Bane NOR" ExtendedDataPropertyDefinition="MMI"/>

		<!-- Pset automation formulas-->
		<!-- BaneNORModelltype -->
		<LuaExpression Name="BaneNORBaneDataID">	<Formula>NOBN_com_Pset_BaneNORBaneDataID()</Formula></LuaExpression>						
		<LuaExpression Name="BaneNORRives">			<Formula>NOBN_com_Pset_BaneNORRives()</Formula></LuaExpression>						
		<LuaExpression Name="BaneNORRivesFase">		<Formula>NOBN_com_Pset_BaneNORRivesFase()</Formula></LuaExpression>						
		<LuaExpression Name="BaneNORByggesFase">	<Formula>NOBN_com_Pset_BaneNORByggesFase()</Formula></LuaExpression>						
		<!-- BaneNORBeskrivelse -->
		<!-- BaneNORRivesAv -->
		<!-- BaneNORByggesAv -->
		<LuaExpression Name="BaneNORFag">			<Formula>RcType:sub(4,5)</Formula></LuaExpression>						
		<!-- BaneNORProsjekterende -->
		<!-- BaneNORTypeOgDimensjon -->
		<!-- BaneNORMMI -->
		
	</xpp:bloc>
</xpp:define>



	<!-- Pset global automation functions (kept in DNA, called from object instances) -->
	<LuaFunction Name="NOBN_com_Pset_BaneNORBaneDataID()" ReturnType="String"
		Description="Dummy startverdi for BaneData objekt-ID på formen 'ff-ttt-000000'. Feltet er avledet fra property 'RcType' ([Grunnleggende].[RC Type]). 'ff' er en av [FE|KU|KO|EH|SA|TE|EL], ttt er 3-bokstavers BaneData objekttypekode innenfor fagkoden. Slett formelen og erstatt '000000' med et unikt nummer som tildeles av Bane NOR.  RcType må være på formen 'JBTff_ttt &lt;objekttypenavn&gt;'.

		Fagkoder: FE=felles (markører, tabeller, områder m.m.), KU=konstruksjon underbygning (terreng, fundamenter, føringsveier, broer, veier, bygninger, drenering), KO=konstruksjon overbygning (ballast, spor, sporobjekter, plattformer), EH=elektro høyspent (KL, jording, kjørestrøm), SA=signalanlegg, TE=tele, EL=elektro lavspent. Skilt er fordelt på alle disipliner. Merk at fagkode FE er ikke en offisiell BaneData fagkode.">
        <Signature>String NOBN_com_Pset_BaneNORBaneDataID()</Signature>
		<!--
			-- Accept only RcType strings with format: 'SA-SIG-123456' / 'TE-AVA-654321' etc.
			-- ^  : Start of string
			-- %a : Any letter (uppercase or lowercase)
			-- %- : The dash character '-'
			-- %d : Any digit 0..9
			-- %w : Any alphanumeric character (excluding whitespace)
			-- cc+: Zero or more occurrences of matching item 'cc'
			-- $  : End of string
		-->
        <Formula>
			function NOBN_com_Pset_BaneNORBaneDataID()
				--Expected RcType format: 'JBTff_ttt ObjectTypeName'
				local a,b = RcType:upper():match("^JBT(%a%a)_(%a%a%a)")
				if a and b then 
					return string.format("%s-%s-%06d",a:upper(),b:upper(),0)
				else
					return _warning, "Ukjent", 
						_info("[Grunnleggende].[RC Type] (RcType) har ikke forventet format 'JBTff_ttt-dddddd &lt;objekttypenavn&gt;' - slett denne formelen og skriv inn Objekt-ID manuelt på korrekt format.")
				end
			end
        </Formula>
    </LuaFunction> 



    <LuaFunction Name="NOBN_com_Pset_BaneNORRives()" ReturnType="String"
		Description="Avledet fra property [Generelt].[Fasekode XXxx-YYyy] (Stage). Returnerer 'Ja' dersom fasekoden har en har Ut-mot-fase lavere enn 9999, som representerer 'før prosjektavslutning'.  Returnerer 'Nei' dersom dersom fasekoden har Ut-mot-fase lik 9999, som representerer 'etter prosjektavslutning'. Returnerer 'Ukjent' dersom fasekoden ikke har gyldig format 'XXxx-YYyy'.">
        <Signature>String NOBN_com_Pset_BaneNORRives()</Signature>
        <Formula>
			function NOBN_com_Pset_BaneNORRives()
				YYyy = tostring(Stage):match("^%d%d%d%d%-(%d%d%d%d)$")
				if YYyy == nil then 
					return _warning, 'Ukjent', 
						_info("WARNING - Ugyldig fasekode i [Generelt].[Fasekode XXxx-YYyy] (Stage), kan ikke avgjøre om objektet skal rives.")
				else
					if YYyy == '9999' then
						return 'Nei'
					else
						return 'Ja'
					end
				end
			end
        </Formula>
    </LuaFunction> 



    <LuaFunction Name="NOBN_com_Pset_BaneNORRivesFase()" ReturnType="String"
		Description="Avledet fra property [Generelt].[Fasekode XXxx-YYyy] (Stage). Returnerer Ut-mot-Fase YYyy, der YYyy angir fasen der objektet først fremstår som fjernet. Returnerer '---' dersom objektet aldri rives. Returnerer 'Ukjent' dersom fasekoden ikke har gyldig format 'XXxx-YYyy' eller dersom ingen faseinformasjon er angitt.">
        <Signature>String NOBN_com_Pset_BaneNORRivesFase()</Signature>
        <Formula>
			function NOBN_com_Pset_BaneNORRivesFase()
				YYyy = tostring(Stage):match("^%d%d%d%d%-(%d%d%d%d)$")
				if YYyy == nil then
					return _warning, 'Ukjent', 
						_info("WARNING - Ugyldig fasekode i [Generelt].[Fasekode XXxx-YYyy] (Stage), kan ikke avgjøre når objektet rives.")
				else
					if YYyy == 9999 then
						return "---"
					else
						return string.format("%02d.%02d",YYyy//100,YYyy%100)
					end
				end
			end
        </Formula>
    </LuaFunction> 



    <LuaFunction Name="NOBN_com_Pset_BaneNORByggesFase()" ReturnType="String"
		Description="Avledet fra property [Generelt].[Fasekode XXxx-YYyy] (Stage). Returnerer Inn-i-fase XXxx, der XXxx angir fasen som objektet første gang eksisterer i. Returnerer 'Ukjent' dersom fasekoden ikke har gyldig format 'XXxx-YYyy' eller dersom ingen faseinformasjon er angitt.">
        <Signature>String NOBN_com_Pset_BaneNORByggesFase()</Signature>
        <Formula>
			function NOBN_com_Pset_BaneNORByggesFase()
				XXxx = tostring(Stage):match("^.*(%d%d%d%d)%-%d%d%d%d.*")
				if XXxx == nil then 
					return _warning, 'Ukjent',
						_info("WARNING - Ugyldig fasekode i [Generelt].[Fasekode XXxx-YYyy] (Stage), kan ikke avgjøre når objektet bygges.")
				else
					return string.format("%02d.%02d",XXxx//100,XXxx%100)
				end
			end
        </Formula>
    </LuaFunction> 



<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>
