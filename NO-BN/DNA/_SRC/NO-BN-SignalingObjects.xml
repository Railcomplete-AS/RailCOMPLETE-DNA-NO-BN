<!--========================================================================================================

    NO-BN-SignalObjects.xml
	
	Include in DNA file using XPPq XML preprocessor directive <xpp:expand href="fileName.xml" />.

	(c) Railcomplete AS, Norway, 2015-2021. All rights reserved.
	
=========================================================================================================-->
<xpp:bloc>



<!--========================================================================================================
	sig - 
	Global Lua formulas for signaling objects (for signals: see other DNA file).
	Domain-specific Lua functions, stored in Global Extension Dictionary (not in each object),
	such that several ObjectType declarations may use theses functions.
=========================================================================================================-->
	<LuaFunction Name="NOBN_sig_getCabinetName()" ReturnType="String"
		Description="Returns a string for each cabinet variant. Keylock cabinets receive a code based on the object's OCP area and the 'seq' property." >
        <Constructor>String NOBN_sig_getCabinetName()</Constructor>
        <Formula>
function NOBN_sig_getCabinetName()
	if string.find(Variant, "apparat") then
		return "As."..code
	elseif string.find(Variant, "Nøkkel") then 
		local v = "Arbeidsområde"
		local n,a
		n,a = RC_com_getAreasOfVariant(v)
		if n == 1 then
			return "Nøk."..RC_com_getOcpCode().." "..a[0].code.."-"..seq 
		else 
			return "*** Zero or multiple ("..n..") areas found of Variant '"..v.."' - cannot deduce a unique name for keylock cabinet." 
		end
	elseif string.find(Variant, "Sveiv") then
		return "Ss."..code
	elseif string.find(Variant, "Kabel") then
		return "Kabelboks "..code
	else
		return "Unknown variant",_warning
	end
end
		</Formula>
	</LuaFunction>

	 
	 
<!--========================================================================================================
	Signaling - ATP (automatic train protection)
=========================================================================================================-->
    <LuaFunction Name="NOBN_sig_getBaliseGroupId()" ReturnType="String" 
		Description="Returns balise group object ID (7 chars) (Ref Signal-Prosj-ATC-7.11-Baliseidentitet)." >
        <Constructor>String NOBN_sig_getBaliseGroupId()</Constructor>
        <Formula>
function NOBN_sig_getBaliseGroupId()
	if Variant == "Hastighetsbalisegruppe" then
		a = "-H"
	elseif Variant == "Signalhøyningsbalisegruppe" then
		a = "-S"
	elseif Variant == "Grensebalisegruppe" then
		a = "-G"
	elseif Variant == "Lenkingsbalisegruppe" then
		a = "-L"
	elseif Variant == "Sporvekselbalisegruppe" then
		a = "-V"
	elseif Variant == "ETCS L2 balisegruppe" then 
		a = "!"
	elseif Variant == "Hovedsignalbalisegruppe" then 
		a = "_"
	elseif Variant == "Forsignalbalisegruppe" then
		a = "F"
	elseif Variant == "Repeterbalisegruppe" then
		local s = "Gjelder for signal/markerboard/skilt/stolpe/sporveksel"
		local r,n = RC__getCollectionOfRelatedObjects(s)
		if n == 0 then
			-- Balise group has no relation to a signal yet:
			return "UNFINISHED - Relate with '"..s.."'."
		else
			sig = r[0] --should be a signal here, repeater groups don't repeat switches directly
			bg = RC__getCollectionOfRelatedObjects("Har balisegruppe",sig)
			bg = bg:filter(function (x) return x.Variant == "Repeterbalisegruppe" end)
			nbg = getCollectionLength(bg)
			if nbg == 0 then
				--I am here, so n *must* be greater than zero:
				return "Should not happen - bad relation loop." 
			elseif nbg == 1 then
				-- I am the only repeater group:
				a = "R"
			elseif nbg == 2 then
				-- Assign 'U' to the one farthest away, 'R' to the one closest to signal: 
				b1 = bg[0]
				b2 = bg[1]
				if distance(b1,sig) &gt; distance(b2,sig) then
					b1,b2 = b2,b1
					--Now b1 is closest to signal
				end
				if this.id == b1.id then
					--I am the closest repeater group:
					a = "R"
				else
					--I am the farthest repeater group:
					a = "U"
				end
			elseif nbg == 3 then
				-- Assign 'V' to the one farthest away, then 'U' and then 'R' to the one closest to signal:
				b1 = bg[0]
				b2 = bg[1]
				b3 = bg[2]
				-- Three pairwise swaps and they're sorted:
				if distance(b1,sig) &gt; distance(b2,sig) then b1,b2 = b2,b1 end
				if distance(b2,sig) &gt; distance(b3,sig) then b2,b3 = b3,b2 end
				if distance(b1,sig) &gt; distance(b2,sig) then b1,b2 = b2,b1 end
				if this.id == b1.id then
					--I am the closest repeater group:
					a = "R"
				elseif this.id == b2.id then
					--I am the middle repeater group:
					a = "U"
				else 
					a = "V"
				end
			end
		end
	end
	ocpMsg = "Create an Operation / Control Point (OCP) area around your object and refresh it to replace '???' with the relevant OCP's codes."
	if Variant == "Hastighetsbalisegruppe" then
		r,n = RC__getCollectionOfRelatedObjects("Har bremsekurve målpunkt i balisegruppe")
		if n == 0 then
			--Group is braking curve target:
			ocp = RC_com_getOcpCode(getObjectFromId(id))
		else
			--Warning board, use target's ocp:
			ocp = RC_com_getOcpCode(r[0])
		end
		return ocp..a..string.format("%02d",seq)
	elseif Variant == "Signalhøyningsbalisegruppe" or Variant == "Sporvekselbalisegruppe" then
		ocp = RC_com_getOcpCode(this)
		if seq == 0 then
			return ocp..a.."UNFINISHED - Set balise group's 'seq' property to the required balise group number (01..99), use '100' for '0'."
		else
			return ocp..a..string.format("%02d",seq%100)
		end
	elseif Variant =="Lenkingsbalisegruppe" or Variant == "Grensebalisegruppe" then
		s = "Lenker til balisegruppe"
		r,n = RC__getCollectionOfRelatedObjects(s)
		if n == 0 then
			ocp = RC_com_getOcpCode(getObjectFromId(id))
		else
			ocp = RC_com_getOcpCode(r[0])
		end
		if seq == 0 then
			return ocp..a.."UNFINISHED - Set balise group's 'seq' property to the required balise group number (01..99), use '100' for '0'."
		else
			return ocp..a..string.format("%02d",seq%100)
		end
	else
		s = "Gjelder for signal/markerboard/skilt/stolpe/sporveksel"
		r,n = RC__getCollectionOfRelatedObjects(s)
		if n == 0 then
			return "UNFINISHED - Relate with '"..s.."'."
		else
			--Assume r[0] holds object dictating the group's number:
			ocp = RC_com_getOcpCode(r[0])
			if r[0].code == nil then 
				return ocp..a.."???",_info(ocpMsg)
			elseif tostring(r[0].code):match("%d+") == nil then
				return ocp..a.."???",_info(ocpMsg)
			else
				return ocp..a..tostring(r[0].code):match("%d+"):sub(-3) 
			end 
		end
		return ocp..a..code:match("%d+"):sub(-3)
	end
end
        </Formula>
    </LuaFunction> 

	
	
    <LuaFunction Name="NOBN_sig_getBaliseId()" ReturnType="String" 
		Description="Returns balise object Id (8 chars) from the 7-char balise group ID and the P/A/B/C balise type (Ref Signal-Prosj-ATC-7.11-Baliseidentitet)." >
        <Constructor>String NOBN_sig_getBaliseId()</Constructor>
        <Formula>
function NOBN_sig_getBaliseId()
	r,n = RC__getCollectionOfRelatedObjects("Tilhører balisegruppe")
	if n == 0 then  
		return "UNFINISHED - Relate with '".."Tilhører balisegruppe".."' to balise group.",
				_info("Balises derive their ID (code property) from their balise group's code, direction, and the balise's relative position within the balise group. The 'A' balise must be related to the balise group using the relation for position defining balise.")
	else
		bg = r[0]
	end
	if bg.dir ~= "up" and bg.dir ~= "down" then 
		return "Bad direction ["..bg.dir.."]",_warning 
	end
	
	q,nq = RC__getCollectionOfRelatedObjects("Har posisjonsdefinerende balise",bg)
	if nq == 0 then 
		return "UNFINISHED - No A-balise in balise group - relate to balise group with relation 'Definerer posisjon for balisegruppe'."
	else
		Abalise = q[0]
		qq,nqq = RC__getCollectionOfRelatedObjects("Definerer posisjon for balisegruppe")
		isA = (nqq == 1) --it's me...
		siblings,nsiblings = RC__getCollectionOfRelatedObjects("Inneholder balise",bg)
	end

	if isA == true then
		suffix = "A"
	else
		if nsiblings == 2 then
			suffix = "B"            
		elseif nsiblings &gt; 2 then
			Pbalise={id=0, diff=math.huge}
			Bbalise={id=0, diff=math.huge}
			Cbalise={id=0, diff=math.huge}
			for i = 0, nsiblings-1 do
				diff = (bg.dir == "up") and (siblings[i].ReferenceMileage - Abalise.ReferenceMileage) or (Abalise.ReferenceMileage - siblings[i].ReferenceMileage)
				if (diff &lt; 0) then
					if Pbalise.id == 0 then
						Pbalise.id = siblings[i].id
						Pbalise.diff = diff
					elseif Pbalise.diff &gt; diff then
						Pbalise.id = siblings[i].id
						Pbalise.diff = diff
					end                
				elseif (diff &gt; 0) then
					if Bbalise.id == 0 then
						Bbalise.id = siblings[i].id
						Bbalise.diff = diff
					elseif Bbalise.diff &gt; diff then
						Cbalise.id = Bbalise.id
						Cbalise.diff = Bbalise.diff
						Bbalise.id = siblings[i].id
						Bbalise.diff = diff                    
					elseif Cbalise.diff &gt; diff then
						Cbalise.id = siblings[i].id
						Cbalise.diff = diff                    
					end                        
				else
					--diff==0: Do nothing
				end
			end    
			if this.id == Bbalise.id then 
				suffix = "B"
			elseif this.id == Cbalise.id then
				suffix = "C"
			elseif this.id == Pbalise.id then
				suffix = "P"
			else
				suffix = "WARNING - Bad balise group configuration - cannot determine PABC type.",_warning
			end
		end
	end
	groupId = RC__identify(bg)
	return groupId:sub(1,2):lower():match("unfinished") and suffix or groupId..suffix
end 
		</Formula>
     </LuaFunction>

	 
	 
    <LuaFunction Name="NOBN_sig_getBaliseTextAboveSymbol()" ReturnType="String"
		Description="Returns text over the 2D balise symbol (Ref Signal-Prosj.-ATC-7.1/7.2-Enkeltrettede/Dobbeltrettede balisegrupper)." >
        <Constructor>String NOBN_sig_getBaliseTextAboveSymbol()</Constructor>
        <Formula>
function NOBN_sig_getBaliseTextAboveSymbol()
	s = "Tilhører balisegruppe"
	r,n = RC__getCollectionOfRelatedObjects(s)
	if n == 0 then
		return "UNFINISHED - Relate with '"..s.."' to balise group."
	else
		bg = r[0]
		t = code:sub(-1)
		if bg.Variant == "Hastighetsbalisegruppe" then
			if t == "A" then
				return "H"
			elseif t == "B" then
				if Variant:lower():match("fylt") then
					return "H"
				else
					return ""
				end
			elseif t == "C" then
				return ""
			else
				return "?",_warning,_info("WARNING - Cannot determine text above balise symbol (balise is neither A, B or C balise).")
			end
		elseif bg.Variant == "ET-balisegruppe" then
			if t == "A" then
				return "EH"
			elseif t == "B" then
				if Variant:lower():match("fylt") then
					return "EH"
				else
					return ""
				end
			elseif t == "C" then
				return ""
			else
				return "?",_warning,_info("WARNING - Cannot determine text above balise symbol (balise is neither A, B or C balise).")
			end
		elseif code:sub(-1) == "P" then
			return "P"
		else
			return ""
		end
	end
end
		</Formula>
     </LuaFunction>


	 
    <LuaFunction Name="NOBN_sig_getBaliseTextBelowSymbol()" ReturnType="String"
		Description="Returns text below the 2D balise symbol (Ref Signal-Prosj.-ATC-7.1/7.2-Enkeltrettede/Dobbeltrettede balisegrupper)." >
        <Constructor>String NOBN_sig_getBaliseTextBelowSymbol()</Constructor>
        <Formula>
function NOBN_sig_getBaliseTextBelowSymbol()
	r,n = RC__getCollectionOfRelatedObjects("Definerer posisjon for balisegruppe")
	if n > 0 then
		return RC__identify(r[0])
	else
		return ""
	end
end
		</Formula>
     </LuaFunction>

	 
	 
    <LuaFunction Name="NOBN_sig_getBaliseGroupDirection()" ReturnType="String"
		Description="Returns the source object balise's balise group direction [up/down/unknown]." >
        <Constructor>String NOBN_sig_getBaliseGroupDirection([Reference balise])</Constructor>
        <Formula>
function NOBN_sig_getBaliseGroupDirection(balise)
	--TODO: Replace with a function which finds out where the closest cable duct is, and rotates the balise with the cable towards that duct.
	balise = (balise == nil) and this or balise
	r,n = RC__getCollectionOfRelatedObjects("Tilhører balisegruppe")
	if n == 0 then
		return "unknown",_info("UNFINISHED - Relate balise with 'Tilhører balisegruppe' to a balise group to inherit direction.")
	else
		return r[0].Dir
	end
end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToPreviousBalise()" ReturnType="String"
		Description="Checks distance to previous balise. Error if too close (2.35) or not far enough (10.5), warning if (2.35 - 2.8) or (3.2 - 3.5) or (10.5 11.8)." >
		<Constructor>String NOBN_sig_chkBaliseDistanceToPreviousBalise()</Constructor>
		<Formula>
function NOBN_sig_chkBaliseDistanceToPreviousBalise()
	searchDir = "down"
	if Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
	obj = getDownObject(RcType)
	if obj == nil then return "OK - No "..RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
	dist = distance(obj)
	t = string.format("%.3f", dist)

	if (dist &lt; 2.35 ) then
		return t..": ERROR - Balise magnetic fields may merge - increase distance.",{obj},_error
	elseif (dist &gt;= 2.35 and dist &lt; 2.8) then
		return t..": WARNING - Outside recommended tolerance - increase distance.",{obj},_warning
	elseif (dist &gt;= 2.8 and dist &lt; 3.2) then
		return t..": OK - The train will treat the balises as belonging to the same group.",{obj},_ok
	elseif (dist &gt;= 3.2 and dist &lt; 3.5) then
		return t..": WARNING - Outside recommended tolerance - decrease distance.",{obj},_warning
	elseif (dist &gt;= 3.5 and dist &lt; 10.5) then
		return t..": ERROR - The train cannot determine which balise group the balise belongs to.",{obj},_error
	elseif (dist &gt;= 10.5 and dist &lt; 11.8) then
		return t..": WARNING - Outside recommended tolerance - increase distance.",{obj},_warning
	elseif (dist &gt; 11.8) then
		return t..": OK - The train will treat the balises as belonging to different balise groups.",{obj},_ok
	else
		return "ERROR - Bad calculation of distance to neighbour object.",_error,
			_info("DNA error - please notify your DNA agent company - send to support@railcomplete.com.")
	end
end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToNextBalise()" ReturnType="String"
		Description="Checks distance to next balise. Error if too close (2.35) or not far enough (10.5), warning if (2.35 - 2.8) or (3.2 - 3.5) or (10.5 11.8)." >
		<Constructor>String NOBN_sig_chkBaliseDistanceToNextBalise()</Constructor>
		<Formula>
function NOBN_sig_chkBaliseDistanceToNextBalise()
	searchDir = "up"
	if Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
	obj = getUpObject(RcType)
	if obj == nil then return "OK - No "..RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
	dist = distance(obj)
	t = string.format("%.3f", dist)

	if (dist &lt; 2.35 ) then
		return t..": ERROR - Balise magnetic fields may merge - increase distance.",{obj},_error
	elseif (dist &gt;= 2.35 and dist &lt; 2.8) then
		return t..": WARNING - Outside recommended tolerance - increase distance.",{obj},_warning
	elseif (dist &gt;= 2.8 and dist &lt; 3.2) then
		return t..": OK - The train will treat the balises as belonging to the same group.",{obj},_ok
	elseif (dist &gt;= 3.2 and dist &lt; 3.5) then
		return t..": WARNING - Outside recommended tolerance - decrease distance.",{obj},_warning
	elseif (dist &gt;= 3.5 and dist &lt; 10.5) then
		return t..": ERROR - The train cannot determine which balise group the balise belongs to.",{obj},_error
	elseif (dist &gt;= 10.5 and dist &lt; 11.8) then
		return t..": WARNING - Outside recommended tolerance - increase distance.",{obj},_warning
	elseif (dist &gt; 11.8) then
		return t..": OK - The train will treat the balises as belonging to different balise groups.",{obj},_ok
	else
		return "ERROR - Bad calculation of distance to neighbour object.",_error,
			_info("DNA error - please notify your DNA agent company - send to support@railcomplete.com.")
	end
end
		</Formula>
	</LuaFunction>

	
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToTrackVertically()" ReturnType="String"
		Description="Checks vertical distance to track above or below balise." >
		<Constructor>String NOBN_sig_chkBaliseDistanceToTrackVertically()</Constructor>
		<Formula>
function NOBN_sig_chkBaliseDistanceToTrackVertically()
	if (Alignment == nil) then return "UNFINISHED - Missing own alignment.",_error end
	closestTracks = getClosestTracks("KO-SPO Spor")
	nearestId = ""
	nearestDist = math.huge
	i = 0
	while (closestTracks[i]) do
		local aId = closestTracks[i].id
		local sDist = math.abs(getAlignmentInfo(aId).DistanceToAlignment)
		if (Alignment.id ~= aId and sDist &lt; nearestDist) then
			nearestId = aId
			nearestDist = sDist
		else
			i = i + 1
		end
	end
	-- Consider only other alignments being no more than 5 meter sideways apart from balise 
	if (nearestDist &gt; 5.0) then return "OK - No conflicting tracks within 5 meters sideways.",_ok end
	hDiff = math.abs(getAlignmentInfo().Elevation - getAlignmentInfo(nearestId).Elevation)
	if (hDiff &lt;= 0.8) then
		-- Assume that closest other track is part of a point or crossing, but still accept 80 cm difference for diverging track profiles
		return string.format("%.3f",hDiff)..": OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing.",_ok
	elseif (hDiff &gt; 0.8 and hDiff &lt;= 7.0) then 
		return string.format("%.3f",hDiff)..": ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise.",_error
	elseif (distance &lt;= 8.0) then 
		return string.format("%.3f",hDiff)..": WARNING - Outside recommended tolerance - increase vertical track separation or move balise.",_warning
	else 
		return string.format("%.3f",hDiff)..": OK - A Train in a track above/under us will pass without reading the balise.",_ok 
	end
end
		</Formula>
	</LuaFunction>
	
	<LuaFunction Name="NOBN_sig_chkBaliseDistanceToTrackSideways()" ReturnType="String"
		Description="Checks distance from balise to neighbour tracks" >
		<Constructor>String NOBN_sig_chkBaliseDistanceToTrackSideways()</Constructor>
		<Formula>
function NOBN_sig_chkBaliseDistanceToTrackSideways()
	if (Alignment == nil) then return "UNFINISHED - Missing own alignment.",_error end
	closestTracks = getClosestTracks("KO-SPO Spor")
	nearestId = ""
	i = 0
	while (closestTracks[i]) do
		if (Alignment.id ~= closestTracks[i].id) then
			nearestId = closestTracks[i].id
			break
		else
			i = i+1
		end
	end
	if (nearestId == "") then return "OK - No neighbouring track(s).",_ok end
	sDist = math.abs(getAlignmentInfo(nearestId).DistanceToAlignment)
	if RC__isNan(sDist) then return "No sideways distance found.", _noSymbol end
	if (sDist &lt; 2.0) then 
		return string.format("%.3f",sDist)..": ERROR – Balise may be read by a train in a neighbouring track – increase distance.",_error
	elseif (sDist &gt; 2.0 and sDist &lt; 2.6) then 
		return string.format("%.3f",sDist)..": WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 meter from neighbouring track (large balise) resp. 2.3 meter (minibalise) – increase distance.",_warning
	else
		return string.format("%.3f",sDist)..": OK – a Train in neighbouring track will pass without reading the balise.",_ok
	end
end
		</Formula>
	</LuaFunction>



	<LuaFunction Name="NOBN_sig_getBaliseModel3DName()" ReturnType="String"
		Description="Returns the name of a standard 3D object model. The BaliseModel argument is either 'Large' (default), 'Mini' or 'Euro'." >
        <Constructor>String NOBN_sig_getBaliseModel3DName(BaliseModel)</Constructor>
        <Formula>
function NOBN_sig_getBaliseModel3DName(BaliseModel)
	if BaliseModel == nil then BaliseModel = "Large" end
	s = "NO-BN-3D-SA-ATB-BALISE"
	if BaliseModel:lower():match("large") then s = s.."-STOR"
	elseif BaliseModel:lower():match("mini") then s = s.."-MINI"
	elseif BaliseModel:lower():match("euro") then s = s.."-LITEN"
	else return "Unknown BaliseModel ["..BaliseModel.."].",_warning
	end
	if Variant:lower():match("fast") then s = s.."-FAST"
	elseif Variant:lower():match("styrt") then s = s.."-STYRT"
	else return "Unknown Variant ["..Variant.."].",_warning
	end
	return s,_info(Variant.." "..BaliseModel.." balise.")
end
		</Formula>
	</LuaFunction>



<!--========================================================================================================
	SIGNAL
	KABLER
	SI-KAB Signalkabel
	TODO: Modelleres ferdig, krever ny funksjonalitet
 =========================================================================================================>
	<ObjectType DataType="tElementWithAlignment" Class="RailwayAlignment" Name="JBTSA_KAB Signalkabel" 
				Layer="JBTSA_KAB" Color="ByLayer" 
				Group="Signal/Kabler"
				>
TODO: Ref Issue #5708 fra 2019-07-09: Add element: Description="https://trv.banenor.no/wiki/Vedlegg_b_Skj%C3%B8ting_og_terminering_av_kabel"

		<RelationSpace>signalkabel</RelationSpace>
		
		<Variants DefaultValue="EESI" >
			<Variant Objektinfo="EEBI" >
			</Variant>
			<Variant Objektinfo="EESI" >
			</Variant>
			<Variant Objektinfo="IFSI" >
			</Variant>
		</Variants>
				
		(...diverse makroer med standard-stæsj...)
		
		<CustomAttribute DataType="Enumeration" Name="Wiring" DisplayName="Lederantall" DefaultValue="4A1,5" >
			<Values>
				<Value>4A1,5</Value>
				<Value>3</Value>
				<Value>7</Value>
				<Value>12</Value>
				<Value>19</Value>
				<Value>27</Value>
				<Value>37</Value>
				<Value>48</Value>
				<Value>65</Value>
				<Value>80</Value>
			</Values>
		</CustomAttribute>

		<LuaExpression Name="name" >
			<Formula>"Kab."..code</Formula>
		</LuaExpression>
	
	</ObjectType>
-->	
	
	
	
	
<!--========================================================================================================
	SIGNAL
	DIVERSE
	SA-SAM Samlelås
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_SAM S-lås"
				Layer="JBTSA_SAM" Color="ByLayer"
				Group="Signal/Diverse"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
<!-- TODO: Add element: Description="Se også SA-FUN Stolpe for S-lås / https://trv.banenor.no/wiki/Signal/Prosjektering/Andre_anlegg#L.C3.A5sanlegg / https://trv.banenor.no/wiki/Signal/Vedlikehold/Annet_teknisk_utstyr#S-l.C3.A5s" -->

		<RelationSpace>s_lås</RelationSpace>
		<AttachmentCategory Name="s_lås" />
		<AttachTo Category="stolpe_med_fot" />

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<!-- Note: The pole to which the S-lock is screwed firmly will be the actual earth provider, but we want the S-lock to appear in earthing drawings / tables. -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<Variants>
			<Variant Name="S-lås" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SAM-SAMLELÅS" />
				<SetValue Key="Offset3D.Z" Value="1.25" />
			</Variant>
			<!--<Variant Name="Overdragstrafo" />-->
		</Variants>

		<LuaExpression Name="name" ><Formula>"S-lås."..code</Formula></LuaExpression>
		
		<InsertPointObject VariantName="S-lås" DisplayBlockName="NO-BN-2D-JBTSI-SAMLELAAS-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" EnableDirectionSetting="false" RotateIfRightSideOfAlignment="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSI-SAMLELAAS-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
			<BlockNameFormat JoinBy="-">
				{% if Variant == 'S-lås' %}NO-BN-2D-JBTSI-SAMLELAAS
				{% else %}BAD_Variant
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{code}}</Value>
			</Attribute>
		</Model3DDefinition>

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="0.0" Y="0.0" TargetSpace="stolpe_med_fot" />
			</SnapPoints>
		</DockPointDefinitions>
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />
	</ObjectType>



<!--========================================================================================================
	SIGNAL
	DIVERSE
	JBTSA_FUN Stolpe med fot
	UNP80 stolper for S-lås, lokalstiller og overdragstrafo på UNP80 medf L-jern fot (med ulike feste plater).
	Ø76 rørmast med L-jern fot for togsporsignal, dvergsignal (2000), dvergsignal+togsporsignal (3000)og kryssvekselsignal (1600)
	Ø127 rørmast for (hvilke?) lyssignaler og for frittstående signalskap og bokser.
	For selve S-låsen, se over
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_FUN Stolpe med fot"
				Layer="JBTSA_FUN" Color="ByLayer"
				Group="Signal/Stolpe med fot"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>stolpe_med_fot</RelationSpace>
		<AttachmentCategory Name="stolpe_med_fot" PassAttachmentToTarget="true" />
		
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<!-- Earthing = None, since the object that the pole is supporting shall be the one to appear as earthed in the earthing drawings / tables. -->
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" /> 


		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<SetValue Key="SupplierName" Value="Bane NOR" />
		<SetValue Key="SupplierArchive" Value="SIGNAL" />

		<!-- Note: If present, the S-lock or local control panel switch should be earthed through the mounting screws, i.e. 'None'. -->
		<LuaExpression Name="EarthingMethod" ><Formula>"Rail"</Formula></LuaExpression>

		<Variants>
			<Variant Name="Stolpe for enkel S-lås" >
				<SetValue Key="name" Value="Stolpe, S-lås" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-STOLPE-UNP80-MED-LJERN-FOR-ENKEL-SAMLELÅS" />
			</Variant>
			<Variant Name="Stolpe for dobbel S-lås" >
				<SetValue Key="name" Value="Stolpe, S-lås x2" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-STOLPE-UNP80-MED-LJERN-FOR-DOBBEL-SAMLELÅS" />
			</Variant>
			<Variant Name="Stolpe for lokalstiller" >
				<SetValue Key="name" Value="Stolpe, Lok." />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-STOLPE-UNP80-MED-LJERN-FOR-LOKALSTILLER" />
			</Variant>								
			<Variant Name="Stolpe for overdragstrafo" >
				<SetValue Key="name" Value="Stolpe, Lok." />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-STOLPE-UNP80-MED-LJERN-FOR-OVERDRAGSTRAFO" />
			</Variant>								

			<!-- Ø76 rørmaster S.002347 med L-jern S.005382 -->
			<Variant Name="Rørmast Ø76 for togsporsignal og dvergsignal, 2m" >
				<SetValue Key="name" Value="Stolpe Ø76, 2m" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-RØRMAST-Ø76-MED-LJERN-FOR-TSS-OG-DS-2000" />
				<SetValue Key="SupplierModelName" Value="Rørmast for dverg- og togsporsignal, normal høyde med L-jern S.005382/S.030065" />
				<SetValue Key="SupplierPartName" Value="Pos.2,3,4" />
				<SetValue Key="SupplierDrawingNumber" Value="S.022896-014" />
				<SetValue Key="SupplierDrawingTitle" Value="Sikringsanlegg, utvendig; Togsporsignal, sammenstilling" />
			</Variant>
			<Variant Name="Rørmast Ø76 for togsporsignal og dvergsignal, 3m" >
				<SetValue Key="name" Value="Stolpe Ø76, 3m" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-RØRMAST-Ø76-MED-LJERN-FOT-FOR-HØYT-TSS-OG-DS-3000" /> 
				<SetValue Key="SupplierModelName" Value="Rørmast for dverg- og togsporsignal, høy med L-jern S.005382/S.030065" />
				<SetValue Key="SupplierPartName" Value="Pos.2,3,4" />
				<SetValue Key="SupplierDrawingNumber" Value="S.022896-014" />
				<SetValue Key="SupplierDrawingTitle" Value="Sikringsanlegg, utvendig; Togsporsignal, sammenstilling" />
			</Variant>	
			<Variant Name="Rørmast Ø76 for kryssvekselsignal, 1.6m" >
				<SetValue Key="name" Value="Stolpe Ø76, 1.6m" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-RØRMAST-Ø76-MED-LJERN-FOT-FOR-KRYSSVEKSELSIGNAL-1600" /> 
				<SetValue Key="SupplierModelName" Value="Rørmast for kryssvekselsignal, med L-jern S.005382/S.030065" />
				<SetValue Key="SupplierPartName" Value="Pos.4,5,6" />
				<SetValue Key="SupplierDrawingNumber" Value="S.004463-000" />
				<SetValue Key="SupplierDrawingTitle" Value="Sikringsanlegg, utvendig; Kryssvekselsignal; Sammenstilling" />
			</Variant>
			<!-- Ø127 rørmast S.013354 med L-jern S.005382 -->
			<Variant Name="Rørmast Ø127 for jernbanesignal, 3.2m" >
				<SetValue Key="name" Value="Rørmast Ø127, 3.2m" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-FUN-NSI63-RØRMAST-Ø76-MED-LJERN-FOT-FOR-SIGNAL-3200" />
				<SetValue Key="SupplierModelName" Value="Rørmast for jernbanesignal, lav med L-jern S.005382/S.030065" />
				<SetValue Key="SupplierPartName" Value="" />
				<SetValue Key="SupplierDrawingNumber" Value="S.013354-000" />
				<SetValue Key="SupplierDrawingTitle" Value="Sikringsanlegg, utvendig; Rørmast for jernbanesignal; Lavt, uten fundament; F.nr.708.215.540" />
			</Variant>
		</Variants>

		<InsertPointObject VariantName="Stolpe for enkel S-lås"
				DisplayBlockName="NO-BN-2D-JBTSI-STOLPE-MED-LJERN-FOR-ENKEL-SAMLELAAS-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" EnableDirectionSetting="false" RotateIfRightSideOfAlignment="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Stolpe for dobbel S-lås"
				DisplayBlockName="NO-BN-2D-JBTSI-STOLPE-MED-LJERN-FOR-DOBBEL-SAMLELAAS-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" EnableDirectionSetting="false" RotateIfRightSideOfAlignment="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Stolpe for lokalstiller"
				DisplayBlockName="NO-BN-2D-JBTSI-STOLPE-MED-LJERN-FOR-LOKALSTILLER-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="2.5" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" EnableDirectionSetting="false" RotateIfRightSideOfAlignment="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>

		<InsertPointObject VariantName="Stolpe for overdragstrafo"
				DisplayBlockName="NO-BN-2D-JBTSI-STOLPE-MED-LJERN-FOR-OVERDRAGSTRAFO-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="2.5" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" EnableDirectionSetting="false" RotateIfRightSideOfAlignment="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>

		<InsertPointObject VariantName="Rørmast Ø76 for togsporsignal og dvergsignal, 2m"
				DisplayBlockName="NO-BN-2D-JBTSI-ROERMAST-76-MED-LJERN-FOR-DS-OG-TSS-2000-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="-90" EnableDirectionSetting="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Rørmast Ø76 for togsporsignal og dvergsignal, 3m"
				DisplayBlockName="NO-BN-2D-JBTSI-ROERMAST-76-MED-LJERN-FOR-HOEY-DS-OG-TSS-3000-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="-90" EnableDirectionSetting="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>

		<InsertPointObject VariantName="Rørmast Ø76 for kryssvekselsignal, 1.6m"
				DisplayBlockName="NO-BN-2D-JBTSI-ROERMAST-76-MED-LJERN-FOR-KRYSSVEKSELSIGNAL-1600-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="-90" EnableDirectionSetting="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Rørmast Ø127 for jernbanesignal, 3.2m"
				DisplayBlockName="NO-BN-2D-JBTSI-ROERMAST-127-MED-LJERN-FOR-SIGNAL-3200-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="-90" EnableDirectionSetting="true" />
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSI-ROERMAST-127-MED-LJERN-FOR-SIGNAL-3200-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
			<BlockNameFormat JoinBy="-" >
				NO-BN-2D-JBTSI
				{% if Variant == 'Stolpe for enkel S-lås' %}STOLPE-MED-LJERN-FOR-ENKEL-SAMLELAAS
				{% elsif Variant == 'Stolpe for dobbel S-lås' %}STOLPE-MED-LJERN-FOR-DOBBEL-SAMLELAAS
				{% elsif Variant == 'Stolpe for lokalstiller' %}STOLPE-MED-LJERN-FOR-LOKALSTILLER
				{% elsif Variant == 'Stolpe for overdragstrafo' %}STOLPE-MED-LJERN-FOR-OVERDRAGSTRAFO
				{% elsif Variant == 'Rørmast Ø76 for togsporsignal og dvergsignal, 2m' %}ROERMAST-76-MED-LJERN-FOR-DS-OG-TSS-2000
				{% elsif Variant == 'Rørmast Ø76 for togsporsignal og dvergsignal, 3m' %}ROERMAST-76-MED-LJERN-FOR-HOEY-DS-OG-TSS-3000
				{% elsif Variant == 'Rørmast Ø76 for kryssvekselsignal, 1.6m' %}ROERMAST-76-MED-LJERN-FOR-KRYSSVEKSELSIGNAL-1600
				{% elsif Variant == 'Rørmast Ø127 for jernbanesignal, 3.2m' %}ROERMAST-127-MED-LJERN-FOR-SIGNAL-3200
				{% else %}BAD_Variant
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

		<DockPointDefinitions>
			<SnapPoints>
				<!-- TODO Hmmm det er så mange ulike objekttyper å tilby snapping for at vi lar det stå åpent for alle inntil videre -->
				<SnapPoint X="0" Y="0" />
			</SnapPoints>
		</DockPointDefinitions>
	</ObjectType>



<!--========================================================================================================
	SIGNAL
	DIVERSE
	JBTSA_AVI Avsporingsindikator
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_AVI Avsporingsindikator"
				Layer="JBTSA_AVI" Color="ByLayer"
				Group="Signal/Diverse"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>avsporingsindikator</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<xpp:expand select="NOBN_com_ISY_STK" />

		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<LuaExpression Name="DistanceToAlignment" ><Formula>NOBN_trk_getDistanceToAlignmentFromCantAndTrackPlaneDistance(RightSided and 4e-4 or -4e-4)</Formula></LuaExpression>
		
		<Variants>
			<Variant Name="Avsporingsindikator" >
				<SetValue Key="name" Value="Ai." />
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-AVI-AVSPORINGSINDIKATOR" />
			</Variant>
		</Variants>	
		
		<InsertPointObject VariantName="Avsporingsindikator" DisplayBlockName="NO-BN-2D-JBTSI-DIVERSE-DERAILMENT-INDICATOR-{{SymbolMode}}"
                DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" EnableDirectionSetting="true" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSI-DIVERSE-DERAILMENT-INDICATOR-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="true" />	
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />
	</ObjectType>



<!--========================================================================================================
	SIGNAL
	SPORSPERRER
	JBTSA_SSP Sporsperre
	NB! SSP er et SA Signalobjekt! Ref epost Bjarne Green til CLFEY, 2016-12-15
	TODO 2018-07-06: Uvisst hvor avsporingstunger skal høre hjemme, vi legger dem inntil videre også på SA-SSP.
=========================================================================================================-->
	<!--SPORSPERRE-->
	<!--TODO modellere enkel og dobbel avsporingstunge-->
	<!--TODO Modellere normalstilling AVLAGT eller PÅLAGT, med tilhørende 2D-symbolfor avlagt stilling (ingen pil, men må vise likevel)-->
	<ObjectType DataType="tDerailer" Class="RailwayPlacedObject" Name="JBTSA_SSP Sporsperre"
				Layer="JBTSA_SSP" Color="ByLayer"
				Group="Signal/Sporsperrer"
				>
				
		<ObjectTypeAttribute 
			Key="quadrant" 
			Value="{% if dir == 'up' and LeftSided == 'True' %}1{% elsif dir == 'down' and LeftSided == 'True' %}2{% elsif dir == 'down' and RightSided == 'True' %}3{% elsif dir== 'up' and RightSided == 'True' %}4{% endif %}"
		 />

		<RelationSpace>sporsperre</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<LuaExpression Name="name" ><Formula>return "Sp."..code</Formula></LuaExpression>

		<LuaExpression Name="DistanceToAlignment" ><Formula>_JBTSA_SSP_DistanceToAlignment()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_SSP_DistanceToAlignment()" ReturnType="Double"
			Description="Returns the XY plane distance to alignment for a derailer or catch points (cant taken into consideration)." >
			<Constructor>Double _JBTSA_SSP_DistanceToAlignment()</Constructor>
			<Formula>
				function _JBTSA_SSP_DistanceToAlignment()
					return NOBN_trk_getDistanceToAlignmentFromCantAndTrackPlaneDistance(RightSided and 0.75 or -0.75)
				end
			</Formula>
		</LuaFunction>

		<CustomAttribute DataType="Enumeration" Name="DerailerState" DisplayName="SporsperreStilling" DefaultValue="derailing" 
			Description="The 'DerailingState' custom attribute [open | closed] reflects the activation state of the derailer." >
			<Values>
				<Value DisplayName="Avlagt" >passive</Value>
				<Value DisplayName="Pålagt" >derailing</Value>
			</Values>
		</CustomAttribute>

		<LuaExpression Name="derailSide" ><Formula>_JBTSA_SSP_derailSide()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_SSP_derailSide()" 
			ReturnType="String"
			Description="Returns the derail side ('Avsporingsretning') for a derailer, deduced from its dir and mounting side (left/right rail)." >
			<Constructor>String _JBTSA_SSP_derailSide()</Constructor>
			<Formula>
				function _JBTSA_SSP_derailSide()
					return ((dir == 'up' and LeftSided) or (dir == 'down' and RightSided)) and "left" or "right"
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="Model3DName" ><Formula>_JBTSA_SSP_Model3DName()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_SSP_Model3DName()" 
			ReturnType="String"
			Description="Returns the 3D model name for a derailer object (we have no catch points in 3D yet)." >
			<Constructor>String _JBTSA_SSP_Model3DName()</Constructor>
			<Formula>
				function _JBTSA_SSP_Model3DName()
					--Ignore the DerailerState property - always draw the derailer in its derailing state.
					local t = "NO-BN-3D-SA-SSP-SPORSPERRE"
					if Variant:lower():match("enkel") then t = t.."-ENKEL" 
					elseif Variant:lower():match("dobbel") then t = t.."-DOBBEL" 
					else t = t.."-BAD_Variant"
					end
					if derailSide == 'left' then t = t.."-VSIDE"
					elseif derailSide == 'right' then t = t.."-HSIDE"
					else t = t.."-BAD_derailSide"
					end
					return t
				end
			</Formula>
		</LuaFunction>

		<Variants DefaultValue="Enkel sporsperre" >
			<Variant Name="Enkel sporsperre" Description="Single-sided derailer" >
				<SetValue Key="kind" Value="blockDerail" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Dobbel sporsperre" Description="Double-sided derailer" >
				<SetValue Key="kind" Value="blockDerail" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Enkel avsporingstunge" Description="Single catch points" >
				<SetValue Key="kind" Value="singleCatchPoints" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Dobbel avsporingstunge" Description="Double catch points" >
				<SetValue Key="kind" Value="doubleCatchPoints" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
		</Variants>
		
		<InsertPointObject VariantName="Enkel sporsperre" DisplayBlockName="NO-BN-2D-JBTSA_SSP-SPORSPERRE-SINGLE-ACTIVE-1-{{SymbolMode}}" 
                DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true" MirrorAboutJigYAxisIfRightSideOfAlignment="true" />
			<!-- <SetValue Key="derailSide" Value="{{insertionSide}}" /> -->
		</InsertPointObject>
		
		<InsertPointObject VariantName="Dobbel sporsperre" DisplayBlockName="NO-BN-2D-JBTSA_SSP-SPORSPERRE-DOUBLE-ACTIVE-1-{{SymbolMode}}" 
                DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true" MirrorAboutJigYAxisIfRightSideOfAlignment="true" />
			<!-- <SetValue Key="derailSide" Value="{{insertionSide}}" /> -->
		</InsertPointObject>
		
		<!-- TODO Mangler 2D-symbol for avsporingstunger enkel og dobbel (EAT, DAT) -->
		<InsertPointObject VariantName="Enkel avsporingstunge" DisplayBlockName="NO-BN-2D-JBTSA_SSP-AVSPORINGSTUNGE-SINGLE-ACTIVE-1-{{SymbolMode}}" 
                DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true" MirrorAboutJigYAxisIfRightSideOfAlignment="true" />
			<!-- <SetValue Key="derailSide" Value="{{insertionSide}}" /> -->
		</InsertPointObject>
		
		<InsertPointObject VariantName="Dobbel avsporingstunge" DisplayBlockName="NO-BN-2D-JBTSA_SSP-AVSPORINGSTUNGE-DOUBLE-ACTIVE-1-{{SymbolMode}}"
                DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true" MirrorAboutJigYAxisIfRightSideOfAlignment="true" />
			<!-- <SetValue Key="derailSide" Value="{{insertionSide}}" /> -->
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE-THUMBNAIL-UNSPECIFIED-SCHEMATIC" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="0" />
			<BlockNameFormat JoinBy="-" >
			NO-BN-2D-JBTSA_SSP
			{% if Variant == 'Enkel sporsperre' %}SPORSPERRE-SINGLE
			{% elsif Variant == 'Dobbel sporsperre' %}SPORSPERRE-DOUBLE
			{% elsif Variant == 'Enkel avsporingstunge' %}AVSPORINGSTUNGE-SINGLE
			{% elsif Variant == 'Dobbel avsporingstunge' %}AVSPORINGSTUNGE-DOUBLE
			{% else %}BAD_Variant
			{% endif %}
			{% if DerailerState == 'passive' %}INACTIVE{% else %}ACTIVE{% endif %}
			{{quadrant}}
			{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

		<DockPointDefinitions>
			<!-- Note: We account for the derailer being inserted at 0.75 from its track: -->
			<SnapPoints MirrorAboutAlignmentNormal="{% if dir == 'down' %}true{% else %}false{% endif %}"
						MirrorAboutAlignmentTangent="{% if RightSided %}true{% else %}false{% endif %}" >
				<SnapPoint X="-1.0" Y="1.0" TargetSpace="lokalstiller" />
				<SnapPoint X="-1.0" Y="-2.5" TargetSpace="lokalstiller" />
			</SnapPoints>
			<SnapPoints MirrorAboutAlignmentTangent="{% if RightSided %}true{% else %}false{% endif %}" >
				<SnapPoint X="0.0" Y="1.0" TargetSpace="sporsperredrivmaskin" />
				<SnapPoint X="0.0" Y="-2.5" TargetSpace="sporsperredrivmaskin" />
			</SnapPoints>
		</DockPointDefinitions>
		
	</ObjectType>



<!--========================================================================================================
	SIGNALING
	CABINET
=========================================================================================================-->
	<!-- Innvendig og utvendig sikringsanlegg (ikke bokser) -->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_APS Apparatskap"
				Layer="JBTSA_APS" Color="ByLayer"
				Group="Signal/Apparatskap"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<!-- TODO (2018-11-06) The Insert Jig code handles only 2 directions. After inserting the symbol the first time, -->
		<!-- the default direction is defined using the SetValue element in the InsertPointObject element. -->
		<!-- After insertion, the SymbolDefinition code translates strict directions (up, down) or lax directions  -->
		<!-- (up, down, none, both, unknown) into rotations, using DotLiquid code. -->
		<RelationSpace>apparatskap</RelationSpace>

		<AttachmentCategory Name="signalskap" />
		<AttachTo Category="apparatskapfundament" />
		
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<Variants>
			<Variant Name="Stort apparatskap, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Stort apparatskap, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Stort apparatskap, dobbeldør" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-APS-APPARATSKAP-STORT-1200x1200x400-MED-SOKKEL" />
			</Variant>
		</Variants>
	
		<LuaExpression Name="dir" ><Formula>"both"</Formula></LuaExpression>
		<LuaExpression Name="name" ><Formula>NOBN_sig_getCabinetName()</Formula></LuaExpression>

		<LuaExpression Name="Offset3D.Z" ><Formula>if Variant:find("stort") ~= 0 then return -0.1 else return 0.95 end</Formula></LuaExpression>

		<InsertPointObject VariantName="Stort apparatskap, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-STORT-VHENGSLET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Stort apparatskap, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-STORT-HHENGSLET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Stort apparatskap, dobbeldør" DisplayBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-STORT-DOBBEL-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-STORT-VHENGSLET-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
			<BlockNameFormat JoinBy="-" >
				NO-BN-2D-JBTSA_APS-APPARATSKAP
				{% if Variant == 'Stort apparatskap, venstrehengslet' %}STORT-VHENGSLET
				{% elsif Variant == 'Stort apparatskap, høyrehengslet' %}STORT-HHENGSLET
				{% elsif Variant == 'Stort apparatskap, dobbeldør' %}STORT-DOBBEL
				{% else %}BAD_Variant
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{Name}}</Value>
			</Attribute>
		</Model3DDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />
	
		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="0" Y="0" TargetSpace="apparatskapfundament" />
			</SnapPoints>
		</DockPointDefinitions>
	</ObjectType>

	

<!--========================================================================================================
	SIGNALING
	DISTRIBUTION CABINETS AND BOXES
=========================================================================================================-->
	<!-- Innvendig og utvendig sikringsanlegg (nøkkelskap, sveivskap, bokser på vegg eller stolpe) -->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_APS Lite skap og boks"
				Layer="JBTSA_APS" Color="ByLayer"
				Group="Signal/Skap og bokser"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>

		<RelationSpace>kabelboks</RelationSpace>

		<AttachmentCategory Name="kabelboks" />
		<AttachTo Category="signalfundament" />
		
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<LuaExpression Name="Offset3D.Z" ><Formula>(Variant:find("Nøkkelskap") or Variant:find("Sveivskap")) and 1.50 or 1.20</Formula></LuaExpression>
		<LuaExpression Name="PoleRouting3D" ><Formula>"Vertical"</Formula></LuaExpression>
		<LuaExpression Name="dir" ><Formula>"both"</Formula></LuaExpression>
		<LuaExpression Name="name" ><Formula>NOBN_sig_getCabinetName()</Formula></LuaExpression>

		<!-- NB already declared in macro -->
		<LuaExpression Name="Tag" >
			<Formula>
				if Variant:lower():match("nøkkel") then return "SA-NØK-nnnnnn"
				else if Variant:lower():match("sveiv") then return "SA-SVB-nnnnnn"
				else if Variant:lower():match("apparat") then return "SA-APS-nnnnnn"
				else if Variant:lower():match("boks") then return "SA-APS-nnnnnn"
				else return "UNFINISHED - Bad variant ["..Variant.."] - cannot deduce Tag - ."
				end
			</Formula>
		</LuaExpression>

		<Variants>
			<Variant Name="Nøkkelskap, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-NØK-NØKKELSKAP-250x350x230-Ø76" />
			</Variant>
			<Variant Name="Nøkkelskap, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-NØK-NØKKELSKAP-250x350x230-Ø76" />
			</Variant>
			<Variant Name="Sveivskap, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SVB-SVEIVSKAP-500x760x320-Ø76" />
			</Variant>
			<Variant Name="Sveivskap, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SVB-SVEIVSKAP-500x760x320-Ø76" />
			</Variant>
			<Variant Name="Lite apparatskap, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Lite apparatskap, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
			<Variant Name="Kabelboks 280x190x100 på Ø76 rørmast, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x100-Ø76" />
			</Variant>
			<Variant Name="Kabelboks 280x190x100 på Ø76 rørmast, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x100-Ø76" />
			</Variant>
			<Variant Name="Kabelboks 280x190x100 på Ø127 rørmast, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x100-Ø127" />
			</Variant>
			<Variant Name="Kabelboks 280x190x100 på Ø127 rørmast, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x100-Ø127" />
			</Variant>
			<Variant Name="Kabelboks 280x190x165 på Ø76 rørmast, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x165-Ø76" />
			</Variant>
			<Variant Name="Kabelboks 280x190x165 på Ø76 rørmast, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x165-Ø76" />
			</Variant>
			<Variant Name="Kabelboks 280x190x165 på Ø127 rørmast, venstrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x165-Ø127" />
			</Variant>
			<Variant Name="Kabelboks 280x190x165 på Ø127 rørmast, høyrehengslet" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SIG-NSI63-KABELBOKS-190x280x165-Ø127" />
			</Variant>
			<!--TODO: <Variant Name=Kabelboks for overdragstrafo" />-->
		</Variants>
	
		<InsertPointObject VariantName="Nøkkelskap, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-NOEKKELSKAP-VHENGSLET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4.0" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Nøkkelskap, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-NOEKKELSKAP-HHENGSLET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4.0" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>

		<InsertPointObject VariantName="Sveivskap, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-SVEIVSKAP-VHENGSLET-{{SymbolMode}}"  
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4.0" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Sveivskap, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-SVEIVSKAP-HHENGSLET-{{SymbolMode}}"  
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4.0" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>

		<InsertPointObject VariantName="Lite apparatskap, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-LITE-VHENGSLET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>

		<InsertPointObject VariantName="Lite apparatskap, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-LITE-HHENGSLET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x100 på Ø76 rørmast, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-VHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x100 på Ø76 rørmast, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-HHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x100 på Ø127 rørmast, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-VHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x100 på Ø127 rørmast, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-HHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x165 på Ø76 rørmast, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-VHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x165 på Ø76 rørmast, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-HHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x165 på Ø127 rørmast, venstrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-VHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Kabelboks 280x190x165 på Ø127 rørmast, høyrehengslet" DisplayBlockName="NO-BN-2D-JBTSA_APS-KABELBOKS-HHENGSLET-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="3.5" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" AddAngle="0" EnableDirectionSetting="false" />
		</InsertPointObject>
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_APS-APPARATSKAP-STORT-VHENGSLET-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
			<BlockNameFormat JoinBy="-">
				NO-BN-2D-JBTSA_APS
				{% if Variant == 'Nøkkelskap, venstrehengslet' %}NOEKKELSKAP-VHENGSLET
				{% elsif Variant == 'Nøkkelskap, høyrehengslet' %}NOEKKELSKAP-HHENGSLET
				{% elsif Variant == 'Sveivskap, venstrehengslet' %}SVEIVSKAP-VHENGSLET
				{% elsif Variant == 'Sveivskap, høyrehengslet' %}SVEIVSKAP-HHENGSLET
				{% elsif Variant == 'Lite apparatskap, venstrehengslet' %}APPARATSKAP-LITE-VHENGSLET
				{% elsif Variant == 'Lite apparatskap, høyrehengslet' %}APPARATSKAP-LITE-HHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x100 på Ø76 rørmast, venstrehengslet' %}KABELBOKS-VHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x100 på Ø127 rørmast, venstrehengslet' %}KABELBOKS-VHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x165 på Ø76 rørmast, venstrehengslet' %}KABELBOKS-VHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x165 på Ø127 rørmast, venstrehengslet' %}KABELBOKS-VHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x100 på Ø76 rørmast, høyrehengslet' %}KABELBOKS-HHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x100 på Ø127 rørmast, høyrehengslet' %}KABELBOKS-HHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x165 på Ø76 rørmast, høyrehengslet' %}KABELBOKS-HHENGSLET
				{% elsif Variant == 'Kabelboks 280x190x165 på Ø127 rørmast, høyrehengslet' %}KABELBOKS-HHENGSLET
				{% else %}BAD_Variant
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{Name}}</Value>
			</Attribute>
		</Model3DDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />
	
		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="0" Y="0" TargetSpace="signalfundament" />
			</SnapPoints>
		</DockPointDefinitions>
	</ObjectType>



<!--========================================================================================================
	SIGNAL
	TEKNISKE BYGNINGER
=========================================================================================================-->
	<!-- Relerom, signalkiosk, container med signalanlegg med mer. -->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_TER Tekniske bygninger og rom"
				Layer="JBTSA_TER" Color="ByLayer"
				Group="Signal/Tekniske Bygninger"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>teknisk_bygg</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<SetValue Key="name" Value="Relerom" />
		<SetValue Key="Tag" Value="SA-TER-nnnnnn" />
		<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />

		<!-- Connect earth to "jordspyd" typically: -->
		<LuaExpression Name="EarthingMethod" ><Formula>"Object"</Formula></LuaExpression>

		<Variants>
			<Variant Name="Relerom" >
				<SetValue Key="name" Value="Relerom" />
				<SetValue Key="Model3DName" Value="NO-BN-3D-FE-DIV-UKJENT" />
			</Variant>
		</Variants>
		
		<InsertPointObject VariantName="Relerom" DisplayBlockName="NO-BN-2D-JBTSA_TER-TEKNISK-BEBYGGELSE-RELEROM-{{SymbolMode}}" 
				DefaultSnapMode="None" SnapToAlignment="true" SnapDistance="15" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_TER-TEKNISK-BEBYGGELSE-RELEROM-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="true" AddAngle="{% if RightSided %}0{% else %}180{% endif %}" />	
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />
		
	</ObjectType>

	

<!--========================================================================================================
    SIGNALING
	TRAIN DETECTION
=========================================================================================================-->
	<!-- TVD Section - Track vacancy detection section - Togdeteksjonsavsnitt for akseltellere = tellepunktavsnitt -->
	<!-- Dette er et fiktivt objekt, ringen med avsnitt-nummeret i. Akseltellerne søker etter dem for å tilegne seg nr. -->
	<!-- TODO: Avklare med Bane NOR om vi kan benytte SA-SPF (eller SA-TVD?) for "tellepunktavsnitt" som ny objekt-type for Banedata. -->
	<ObjectType DataType="RailCOMPLETESection" Class="RailwayPlacedObject" Name="JBTSA_TEA Tellepunktavsnitt"
				Layer="JBTSA_TEA" Color="ByLayer"
				Group="Signal/Togdeteksjon"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
	>
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ALIGNMENT_ANNOTATION_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<!-- Ikke ISY beskrivelse - fiktivt objekt -->

		<Variants>
			<Variant Name="Tellepunktavsnitt" >
			</Variant>
		</Variants>

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_AxleCountersToBeModelchecked" 
			DisplayName="Axle counters to be refreshed" 
			Description="When this section object is refreshed, then the nearest limiting object on each side is refreshed as well." />
		<LuaExpression Name="mc_AxleCountersToBeModelchecked" IsModelCheck="true" ><Formula>_JBTSA_TEA_chkTriggerNeighbourAxleCounters()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_TEA_chkTriggerNeighbourAxleCounters()" ReturnType="String"
			Description="Triggers modelchecking in neighbour axle counters." >
			<Constructor>_JBTSA_TEA_chkTriggerNeighbourAxleCounters()</Constructor>
			<Formula>
				function _JBTSA_TEA_chkTriggerNeighbourAxleCounters()
					if Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
					local n = 0
					local t = {}
					prevAc = getDownObject("JBTSA_TEL Akselteller sensor") --Axle counter
					if prevAc then 
						n = n + 1
						table.insert(t,prevAc)
					end
					nextAc = getUpObject("JBTSA_TEL Akselteller sensor") --Axle counter
					if nextAc then 
						n = n + 1
						table.insert(t,nextAc)
					end
					return n,t,_info(n.." axle counters have been refreshed.")
				end
			</Formula>
		</LuaFunction>
		<LuaExpression Name="SymbolFrame" ><Formula>NOBN__setSymbolFrame()</Formula></LuaExpression>

		<LuaExpression Name="name" ><Formula>"Ta("..code..")"</Formula></LuaExpression>	

		<!-- Snap-distance 1.6 means that the snap-function with argument '3' snaps it to dist 3 from track, snapping to the correct track. -->
		<InsertPointObject VariantName="Togdeteksjonsavsnitt for akseltellere" DisplayBlockName="NO-BN-2D-JBTFE-SECTION-JIGSYMBOL-{{SymbolMode}}"
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="6" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance EnableDirectionSetting="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
			<SetValue Key="DelimiterType" Value="JBTSA_TEL Akselteller sensor" />
		</InsertPointObject>
		
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE-SECTION-SYMBOL-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft == 'True'%}180{% else %}0{% endif %}" />
			<SymbolAttribute Tag="X" >
				<Value>{{code}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

	</ObjectType>



<!--========================================================================================================
    SIGNAL
	TOGDETEKSJON
	JBTSA_TEL Akselteller sensor [akselteller sensor i skinnelivet]
	railML:	2.3
	Element:	<trainDetector>
	Parent: 	<trainDetectionElements>
	Children: <additionalName> (introduced with version 2.1), <any>, <geoCoord>, <states>
=========================================================================================================-->
<!-- Note: If cant has been exaggerated, then the axle counter sensors will move with the superelevated rails and may come closer to the -->
<!-- track / alignment axis than expected, and a model check for XY-plane distance less than 5e-3 to own alignment will flag the axle counter as misplaced... -->
<!-- if (math.abs(math.abs(DistanceToAlignment) - cantGauge/2) &gt; 5e-3) then -->
<!-- 	return string.format("%.3f",DistanceToAlignment)..": WARNING - Distance (2D) to own alignment should be about +/- half railseparation.",_warning -->
<!-- end -->
	<ObjectType DataType="tTrainDetector" Class="RailwayPlacedObject" Name="JBTSA_TEL Akselteller sensor"
				Layer="JBTSA_TEL" Color="ByLayer"
				Group="Signal/Togdeteksjon"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>tellepunkt</RelationSpace>
		
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_MEDIUM_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<Variants>
			<Variant Name="Tellepunkt" >
				<SetValue Key="controllerRef" Value="" />  <!--This refers to the id attribute of the associated <controller> element-->
				<SetValue Key="detectionObject" Value="axle" />  <!--wheel axle train endOfTrain obstacle other:anything--> 
				<SetValue Key="medium" Value="magnetic" />	<!--mechanical hydraulic pneumatic magnetic inductive optical radio other:anything-->
				<SetValue Key="directionDetection" Value="false" />	<!--boolean-->
				<SetValue Key="model" Value="" />	<!--string-->
				<SetValue Key="axleCounting" Value="true" />	<!--Boolean-->
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-TEL-L905-TELLEPUNKT-SK30K" />
			</Variant>
		</Variants>

		<LuaExpression Name="DistanceToAlignment" ><Formula>_JBTSA_TEL_DistanceToAlignment()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_TEL_DistanceToAlignment()" ReturnType="String"
			Description="Returns the distance to alignment for an axle counter sensor, either +/- 1.5 in schematic drawings or  otherwise +/-0.75." >
			<Constructor>Double _JBTSA_TEL_DistanceToAlignment()</Constructor>
			<Formula>
				function _JBTSA_TEL_DistanceToAlignment()
					if Scale == "S" then 
						return RightSided and 1.5 or -0.75
					else 
						return NOBN_trk_getDistanceToAlignmentFromCantAndTrackPlaneDistance(RightSided and .75 or -.75)
					end
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="code" ><Formula>_JBTSA_TEL_code()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_TEL_code()" ReturnType="String"
			Description="Returns a text string 'DownSection/UpSection' for an axle counter sensor." >
			<Constructor>_JBTSA_TEL_code()</Constructor>
			<Formula>
				function _JBTSA_TEL_code()
					first = "-"
					shortestDistanceSoFar = math.huge
					for i = 0, DownSections.count-1 do
						obj = DownSections[i]
						if obj:isVisible() then
							dist = RC__getDistance2D(obj)
							if dist &lt; shortestDistanceSoFar then
								first = DownSections[i].code
								shortestDistanceSoFar = dist
							end
						end
					end
					second = "-"
					shortestDistanceSoFar = math.huge
					for i = 0, UpSections.count-1 do
						obj = UpSections[i]
						if obj:isVisible() then 
							dist = RC__getDistance2D(obj)
							if dist &lt; shortestDistanceSoFar then
								second = UpSections[i].code
								shortestDistanceSoFar = dist
							end
						end
					end
					if (MileageIncreasesTowardsLeft == 'True') then first,second = second,first end
					if first == "-" and second == "-" then
						return first.."/"..second,_info("UNFINISHED - Create axle counter Section object(s) to obtain the section numbers 'a/b' for the sensor.")
					else
						return first.."/"..second
					end
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="name" ><Formula>"Tp("..code..")"</Formula></LuaExpression>	
		<LuaExpression Name="dir" ><Formula>"both"</Formula></LuaExpression>	
		
		<LuaFunction Name="_JBTSA_TEL_chkAxleCounterDistanceToPreviousAxleCounter()" ReturnType="String"
			Description="Checks distance to previous axle counter. Error if below 21 m, warning if below 23 m." >
			<Constructor>String _JBTSA_TEL_chkAxleCounterDistanceToPreviousAxleCounter()</Constructor>
			<Formula>
				function _JBTSA_TEL_chkAxleCounterDistanceToPreviousAxleCounter()
					searchDir = "down"
					if Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
					r,n = RC__getCollectionOfRelatedObjects("Har akseltellersopp")
					if n == 0 then tps = nil else tps = r[0] end --tps (tellepunktsopp) is nil if no tuning unit connected yet (used to trigger check of related object)
					ac = getDownObject(RcType)
					if ac == nil then return "OK - No "..RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
					dist = distance(ac)
					t = string.format("%.3f", dist)
					Etol = 21.0 --[m] error level tolerance
					Wtol = Etol + 2.0 --[m] warning level tolerance
					if dist &lt; Etol then 
						return string.format("%.03f: ERROR - %s too close in '%s' direction, outside tolerance %0.3f m.", dist,ac.name,searchDir,Etol),{ac,tps},_error
					elseif dist &lt; Wtol then 
						return string.format("%.03f: WARNING - %s close in '%s' direction, but within tolerance %0.3f m.", dist,ac.name,searchDir,Etol),{ac,tps},_warning
					else
						return string.format("%.03f: OK - %s is nearest axle counter in '%s' direction, farther away than tolerance %0.3f m.", dist,ac.name,searchDir,Etol),{ac,tps},_ok
					end
				end
			</Formula>
		</LuaFunction>



		<LuaFunction Name="_JBTSA_TEL_chkAxleCounterDistanceToNextAxleCounter()" ReturnType="String"
			Description="Checks distance to next axle counter. Error if below 21 m, warning if below 23 m." >
			<Constructor>String _JBTSA_TEL_chkAxleCounterDistanceToNextAxleCounter()()</Constructor>
			<Formula>
				function _JBTSA_TEL_chkAxleCounterDistanceToNextAxleCounter()
					searchDir = "up"
					if Alignment == nil then return "UNFINISHED - Missing own alignment.",_error end
					r,n = RC__getCollectionOfRelatedObjects("Har akseltellersopp")
					if n == 0 then tps = nil else tps = r[0] end --tps (tellepunktsopp) is nil if no tuning unit connected yet (used to trigger check of related object)
					ac = getUpObject(RcType)
					if ac == nil then return "OK - No "..RcType:sub(8).." within reach in the '"..searchDir.."' direction.",_ok end
					dist = distance(ac)
					t = string.format("%.3f", dist)
					Etol = 21.0 --[m] error level tolerance
					Wtol = Etol + 2.0 --[m] warning level tolerance
					if dist &lt; Etol then 
						return string.format("%.03f: ERROR - %s too close in '%s' direction, outside tolerance %0.3f m.", dist,ac.name,searchDir,Etol),{ac,tps},_error
					elseif dist &lt; Wtol then 
						return string.format("%.03f: WARNING - %s close in '%s' direction, but within tolerance %0.3f m.", dist,ac.name,searchDir,Etol),{ac,tps},_warning
					else
						return string.format("%.03f: OK - %s is nearest axle counter in '%s' direction, farther away than tolerance %0.3f m.", dist,ac.name,searchDir,Etol),{ac,tps},_ok
					end
				end
			</Formula>
		</LuaFunction>

		<!-- Set railML properties: -->
		<LuaExpression Name="posInTrack" ><Formula>RightSided and "leftRail" or "rightRail"</Formula></LuaExpression>	

		<!-- Model checks -->
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToPreviousAxleCounter" DisplayName="Avstand til forrige tellepunkt" 
				Description="Axle counters need at least 21 m between any two consecutive sensors, preferably 23 m, such that the longest admissible wagon will not free the track occupation under the wagon." />
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToNextAxleCounter" DisplayName="Avstand til neste tellepunkt" 
				Description="Axle counters need at least 21 m between any two consecutive sensors, preferably 23 m, such that the longest admissible wagon will not free the track occupation under the wagon." />
		<LuaExpression Name="SymbolFrame" ><Formula>NOBN__setSymbolFrame()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToPreviousAxleCounter" IsModelCheck="true" ><Formula>_JBTSA_TEL_chkAxleCounterDistanceToPreviousAxleCounter()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToNextAxleCounter" IsModelCheck="true" ><Formula>_JBTSA_TEL_chkAxleCounterDistanceToNextAxleCounter()</Formula></LuaExpression>
			
		<InsertPointObject VariantName="Tellepunkt" DisplayBlockName="NO-BN-2D-JBTSA_TEL-AKSELTELLER-SENSOR-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" RotateIfRightSideOfAlignment="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<SymbolDefinition X="0.0" Y="0" DefaultBlockName="NO-BN-2D-JBTSA_TEL-AKSELTELLER-SENSOR-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
			<BlockNameFormat>NO-BN-2D-JBTSA_TEL-AKSELTELLER-SENSOR-{{SymbolMode}}</BlockNameFormat>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

		<DockPointDefinitions>
			<SnapPoints>
				<SnapPoint X="0.0" Y="3.0" TargetSpace="akseltellersopp" />
				<SnapPoint X="0.0" Y="4.5" TargetSpace="akseltellersopp" />
				<SnapPoint X="0.0" Y="-3.0" TargetSpace="akseltellersopp" />
				<SnapPoint X="0.0" Y="-4.5" TargetSpace="akseltellersopp" />
			</SnapPoints>
		</DockPointDefinitions>

	</ObjectType>



<!--========================================================================================================
    SIGNAL
	TOGDETEKSJON
	JBTSA_TET Akselteller tuningenhet
	Dette er tuningenhet eller evalueringsenhet for akseltellerens svake sensorsignaler, plassert ved sporet.
	TODO: Avklare med Bane NOR om vi får innføre SA-TET for Tellepunkt tuningenhet
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_TET Akselteller tuningenhet"
				Layer="JBTSA_TET" Color="ByLayer"
				Group="Signal/Togdeteksjon"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>akseltellersopp</RelationSpace>
		
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />
		
		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<Variants>
			<Variant Name="Sopp for enkelt tellepunkt" >
				<SetValue Key="name" Value="Tp-sopp, enkel" />
			</Variant>
			<Variant Name="Sopp for dobbelt tellepunkt" >
				<SetValue Key="name" Value="Tp-sopp, dobbel" />
			</Variant>
		</Variants>

		<LuaExpression Name="SymbolFrame" ><Formula>NOBN__setSymbolFrame()</Formula></LuaExpression>
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_CableDistanceFromMushroomToAxleCounter" 
						DisplayName="Kabelavstand fra sopp til tellepunkt" 
						Description="Axle counters send very weak signals to the nearby tuning box, using impedance-matched coaxial cables of predefined lengths, typically from 3 to 7 meters." />
		<LuaExpression Name="mc_CableDistanceFromMushroomToAxleCounter" IsModelCheck="true" ><Formula>_JBTSA_TET_chkCableDistanceFromTunerToAxleCounter()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_TET_chkCableDistanceFromTunerToAxleCounter()" ReturnType="String"
			Description="Checks 'grid distance' (perp to track + along track), from axle counter tuner (mushroom) to its axle counter. Error if outside (1.0 - 7.5), warning if outside (3.0 - 3.4) meter." >
			<Constructor>String _JBTSA_TET_chkCableDistanceFromTunerToAxleCounter()</Constructor>
			<Formula>
				function _JBTSA_TET_chkCableDistanceFromTunerToAxleCounter()
					--Assume mushroom has same own alignment and approximate position as the axle counter it belongs to:
					s = "Er akseltellersopp for tellepunkt"
					r,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "UNFINISHED - Relate with '"..s.."' to  its axle counter sensor."
					else
						tol = 1.0 -- meter
						ac = r[0]
						gridDistancePerpendicular = math.abs(distanceToAlignment - ac.distanceToAlignment)
						gridDistanceColinear = math.abs(mileage - ac.mileage)
						-- Their sum is a cool metric:
						gridDistance = gridDistancePerpendicular + gridDistanceColinear
						msg = "Grid distance is the sum of "..RC__round(gridDistancePerpendicular,1).." (perpendicular to alignment) and "..RC__round(gridDistanceColinear,1).." (colinear to alignment)"
						gt = string.format("%.1f=%.03f+%.03f",gridDistance,gridDistancePerpendicular,gridDistanceColinear)
						if (gridDistance &lt; tol) then return gridDistance..": ERROR - Tuner is located too close to axle counter wrt minimum tolerance 1m.",{ac},_error,_info(msg)
						elseif (gridDistance &gt;= 1.0 and gridDistance &lt; 3.0) then return gt..": WARNING - Tuner is located close to axle counter but above min 1m - try increase to 3.0.",{ac},_warning,_info(msg)
						elseif (gridDistance &gt;= 3.0 and gridDistance &lt; 3.4) then return gt..": OK - Distance from tuner to axle counter is suitable for standard cabling 3m to 3.4m.",{ac},_ok,_info(msg)
						elseif (gridDistance &gt;= 3.4 and gridDistance &lt;= 7.5) then return gt..": WARNING - Tuner is located far from axle counter, but below max 7.5m - try reduce to 3.4.",{ac},_warning,_info(msg)
						else return gt..": ERROR - Tuner is located too far from axle counter, reduce distance.",{ac},_error,_info(msg) end
					end
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="dir" ><Formula>"both"</Formula></LuaExpression>
		
		<LuaExpression Name="code" ><Formula>_JBTSA_TET_code()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_TET_code()" ReturnType="String"
			Description="Obtains the 'code' for axle counter tuning unit (mushroom). Uses relation 'Er akseltellersopp for tellepunkt' to , the related object's data." >
			<Constructor>String _JBTSA_TET_code()</Constructor>
			<Formula>
				function _JBTSA_TET_code()
					s = "Er akseltellersopp for tellepunkt"
					r,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "UNFINISHED - Relate with '"..s.."' to  its axle counter sensor."
					elseif n == 1 then
						return "Tps("..r[0].code..")"
					elseif n == 2 then
						return "Tps("..r[0].code.."+"..r[1].code..")"
					elseif n &gt;= 3 then
						return "*** ERROR - Too many axle counters sensors related to mushroom with '"..s.."."
					end
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="name" ><Formula>"Tps("..code..")"</Formula></LuaExpression>
		<LuaExpression Name="Mileage" ><Formula>RC__getMileageFromRelatedObject("Er akseltellersopp for tellepunkt")</Formula></LuaExpression>

		<InsertPointObject VariantName="Sopp for enkelt tellepunkt" DisplayBlockName="NO-BN-2D-JBTSA_TET-AKSELTELLER-TUNINGHENHET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.75" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" />
		</InsertPointObject>

		<InsertPointObject VariantName="Sopp for dobbelt tellepunkt" DisplayBlockName="NO-BN-2D-JBTSA_TET-AKSELTELLER-TUNINGHENHET-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="3.75" AskForAttachment="true" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateIfRightSideOfAlignment="true" />
		</InsertPointObject>

		<SymbolDefinition X="0.0" Y="0" DefaultBlockName="NO-BN-2D-JBTSA_TET-AKSELTELLER-TUNINGHENHET-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>

	

<!--========================================================================================================
    SIGNALING (and TRACK AND EMBANKMENT as well)
	RAIL JOINT
=========================================================================================================-->
	<!-- JBTKO_SKJ Skinneskjøt -->
	<!-- Isolert skinneskjøt. Tilhører Overbygningsfaget, som har sporet. Brukes også i returstrømkretsen. -->
	<!-- TODO: Vurder om den skal bytte Group i CratePointObject innsettingsdialogen og i Object Manager. -->
	<ObjectType DataType="tTrackCircuitBorder" Class="RailwayPlacedObject" Name="JBTKO_SKJ Skinneskjøt"
				Layer="JBTKO_SKJ" Color="ByLayer"
				Group="Signal/Togdeteksjon"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>skinneskjøt</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTOB" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTOB" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<Variants>
			<Variant Name="Skinneskjøt" >
			</Variant>
		</Variants>

		<LuaExpression Name="DistanceToAlignment" >		   
			<Formula>0</Formula>
		</LuaExpression>
		
		<CustomAttribute DataType="Boolean" Name="UpSectionLeftRailDetection" DisplayName="Deteksjon venstreskinne i stigende kilometerretning" DefaultValue="False" />
		<CustomAttribute DataType="Boolean" Name="DownSectionLeftRailDetection" DisplayName="Deteksjon venstreskinne i synkende kilometerretning" DefaultValue="False" />
		<CustomAttribute DataType="Boolean" Name="DownSectionRightRailDetection" DisplayName="Deteksjon høyreskinne i synkende kilometerretning" DefaultValue="False" />
		<CustomAttribute DataType="Boolean" Name="UpSectionRightRailDetection" DisplayName="Deteksjon høyreskinne i stigende kilometerretning" DefaultValue="False" />

		<LuaExpression Name="name" ><Formula>"Iso."..code</Formula></LuaExpression>

		<!-- TODO: Lage 3D-modell for isolasjon med sporfelttilkoblinger -->
		<SetValue Key="Model3DName" Value="" />

		<LuaExpression Name="UpSectionLeftRailDetection" ><Formula>insulatedRail == "left" or insulatedRail == "both"</Formula></LuaExpression>
		<LuaExpression Name="UpSectionRightRailDetection" ><Formula>insulatedRail == "right" or insulatedRail == "both"</Formula></LuaExpression>
		<LuaExpression Name="DownSectionLeftRailDetection" >
			<Formula>
				prev = getDownObject(RcType)
				if prev == nil then return false 
				else
					return prev.insulatedRail == "left" or prev.insulatedRail == "both"
				end
			</Formula>
		</LuaExpression>
		<LuaExpression Name="DownSectionRightRailDetection" >
			<Formula>
				prev = getDownObject(RcType)
				if prev == nil then return false 
				else
					return prev.insulatedRail == "right" or prev.insulatedRail == "both"
				end
			</Formula>
		</LuaExpression>
			
		<!-- NB! Point snapping works for some switches (for those where we had data on insulation joint placements (point on straight / deviating alignment axis). -->
		<InsertPointObject VariantName="skinneskjøt" DisplayBlockName="NO-BN-2D-JBTKO_SKJ-SKINNESKJOET-0-0-0-0-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance AddAngle="0" RotateIfRightSideOfAlignment="false" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>
		
		<SymbolDefinition X="0.0" Y="0" DefaultBlockName="NO-BN-2D-JBTKO_SKJ-SKINNESKJOET-0-0-0-0-{{SymbolMode}}" AllowSymbolMove="true" />
		
		<SymbolDefinition X="0" Y="0" DefaultBlockName="" AllowSymbolMove="true" Layer="JBTKO_SKJ" >
			<BlockNameFormat JoinBy="-" >
				NO-BN-2D-JBTKO_SKJ-SKINNESKJOET
				{% if UpSectionRightRailDetection %}1{% elsif UpSectionLeftRailDetection or DownSectionLeftRailDetection or DownSectionRightRailDetection or UpSectionRightRailDetection %}0{% else %}{% endif %}
				{% if DownSectionRightRailDetection %}1{% elsif UpSectionLeftRailDetection or DownSectionLeftRailDetection or DownSectionRightRailDetection or UpSectionRightRailDetection %}0{% else %}{% endif %}
				{% if DownSectionLeftRailDetection %}1{% elsif UpSectionLeftRailDetection or DownSectionLeftRailDetection or DownSectionRightRailDetection or UpSectionRightRailDetection %}0{% else %}{% endif %}
				{% if UpSectionLeftRailDetection %}1{% elsif UpSectionLeftRailDetection or DownSectionLeftRailDetection or DownSectionRightRailDetection or UpSectionRightRailDetection %}0{% else %}{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
    SIGNAL
	TOGDETEKSJON
	SA-???
	TODO: Halemagnet
=========================================================================================================-->



<!--========================================================================================================
    SIGNAL
	TOGDETEKSJON
	JBTSA_SPF Sporfelt
	TVD Section - Track vacancy detection section - Togdeteksjonsavsnitt for isolerte skinneskjøter
=========================================================================================================-->
	<ObjectType DataType="RailCOMPLETESection" Class="RailwayPlacedObject" Name="JBTSA_SPF Sporfelt"
				Layer="JBTSA_SPF" Color="ByLayer"
				Group="Signal/Togdeteksjon"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
	>
				
		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ALIGNMENT_ANNOTATION_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />

		<!-- Fiktivt objekt - ikke ISY beskrivelse -->
		
		<!-- 2020-04-29 CLFEY Deprecated properties - can't assign a definite rail as insulated or not, this varies over the track circuit: -->
		<!-- <CustomAttribute DataType="Enumeration" Name="LeftRailDetection" DisplayName="Deteksjon venstreskinne" DefaultValue="False" > -->
			<!-- <Values> -->
				<!-- <Value>true</Value> -->
				<!-- <Value>false</Value> -->
			<!-- </Values> -->
		<!-- </CustomAttribute> -->
		<!-- <CustomAttribute DataType="Enumeration" Name="RightRailDetection" DisplayName="Deteksjon høyreskinne" DefaultValue="False" > -->
			<!-- <Values> -->
				<!-- <Value>true</Value> -->
				<!-- <Value>false</Value> -->
			<!-- </Values> -->
		<!-- </CustomAttribute> -->
		
		<Variants>
			<Variant Name="Sporfelt" >
			</Variant>
		</Variants>

		<InsertPointObject VariantName="Sporfelt" DisplayBlockName="NO-BN-2D-JBTFE-SECTION-JIGSYMBOL-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
			<SetValue Key="SymbolFrame" Value="SectionFrame-2.75" />
			<SetValue Key="DelimiterType" Value="JBTKO_SKJ Skinneskjøt" />
		</InsertPointObject>
	
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTFE-SECTION-SYMBOL-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft == 'True'%}180{% else %}0{% endif %}" />
			<SymbolAttribute Tag="X" >
				<Value>{{code}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
    SIGNAL
	SIKRINGSANLEGG
	SA-??? 
	TODO: Lage Veibomdrivmaskin
=========================================================================================================-->
	
	

<!--========================================================================================================
    SIGNAL
	SIKRINGSANLEGG
	JBTSA_DRV Sporvekseldrivmaskin
	Drivmaskin for sporveksler, til tunger og bevegelig kryss
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_DRV Sporvekseldrivmaskin"
				Layer="JBTSA_DRV" Color="ByLayer"
				Group="Signal/Sikringsanlegg"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>sporvekseldrivmaskin</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />
		
		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<LuaExpression Name="DistanceToAlignment" >		   
			<Formula>NOBN_trk_getDistanceToAlignmentFromCantAndTrackPlaneDistance(RightSided and 1.75 or -1.75)</Formula>
		</LuaExpression>

		<CustomAttribute DataType="Boolean" Name="HasHeatingElement" DisplayName="Har varmeelement" DefaultValue="False" >
			<Values>
				<Value>true</Value>
				<Value>false</Value>
			</Values>
		</CustomAttribute>
		
		<Variants DefaultValue="Uspesifisert" >
			<Variant Name="Uspesifisert" >
			</Variant>
			<Variant Name="Alstom MET" >
			</Variant>
			<Variant Name="Siemens Bsg9" >
			</Variant>
			<Variant Name="Siemens ELS 710" >
			</Variant>
		</Variants>
		
		<LuaExpression Name="code" ><Formula>_JBTSA_DRV_code()</Formula></LuaExpression>	
		<LuaFunction Name="_JBTSA_DRV_code()" ReturnType="String"
				Description="Obtains the code for a point machine, derived from the switch it is related to with 'Driver sporveksel'." >
			<Constructor>String _JBTSA_DRV_code()</Constructor>
			<Formula>
				function _JBTSA_DRV_code()
					local s,i,r,n,d,j
					s = "Driver sporveksel"
					r,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "Relate with '"..s.."' to switch object (turnout).",
							_info("Point machines derive their code from the switch they are related to with '"..s.."'.")
					else    
						pm,npm = RC__getCollectionOfRelatedObjects("Har sporvekseldrivmaskin",r[0])
						j = 0
						for i = 0, npm-1 do 
							d = (r[0].dir == "up") and 1 or -1
							if ((ReferenceMileage - pm[i].ReferenceMileage)*d &gt;= 0) then 
								j = j + 1 
							end
						end
						return string.format("%d.%d",r[0].code,j)
					end
				end	
			</Formula>
		</LuaFunction>

		<LuaExpression Name="name" ><Formula>"Drv."..code</Formula></LuaExpression>	
		
		<LuaExpression Name="dir" ><Formula>_JBTSA_DRV_dir()</Formula></LuaExpression>
		<LuaFunction Name="_JBTSA_DRV_dir()" ReturnType="String"
				Description="Obtains the direction (dir) for a point machine, derived from the switch it is related to with 'Driver sporveksel'." >
			<Constructor>String _JBTSA_DRV_dir()</Constructor>
			<Formula>
				function _JBTSA_DRV_dir()
					local s,sw,n
					s = "Driver sporveksel"
					sw,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "unknown",_info("Point machines derive their direction from the switch they are related to with '"..s.."'.")
					else
						return sw[0].dir
					end
				end
			</Formula>
		</LuaFunction>

		<!-- Note: None of these point machines are symmetrical, there are separate right / left versions. -->
		<!-- This is mainly due to the need of having the control rods always closest to tip-of-tongue, -->
		<!-- at least in the first oint machine position. -->
		<LuaExpression Name="Model3DName" ><Formula>_JBTSA_DRV_Model3DName()</Formula></LuaExpression>	
		<LuaFunction Name="_JBTSA_DRV_Model3DName()" ReturnType="String"
				Description="Obtains the 3D model name (Model3DName) for a point machine, derived from its Variant, direction (dir) and side of alignment (distanceToAlignment)." >
			<Constructor>String _JBTSA_DRV_Model3DName()</Constructor>
			<Formula>
				function _JBTSA_DRV_Model3DName()
					local t = ""
					if Variant == "Uspesifisert" then
						return "NO-BN-3D-FE-DIV-UKJENT"
					elseif Variant == "Alstom MET" then 
						t = "NO-BN-3D-SA-DRV-SPORVEKSELDRIVMASKIN-ALSTOM-MET-"
					elseif Variant == "Siemens Bsg9" then
						t = "NO-BN-3D-SA-DRV-SPORVEKSELDRIVMASKIN-SIEMENS-BSG9-"
					elseif Variant == "Siemens ELS 710" then
						t = "NO-BN-3D-SA-DRV-SPORVEKSELDRIVMASKIN-SIEMENS-ELS710-"
					else
						return "NO-BN-3D-FE-DIV-UKJENT",_error,_info("Bad variant ["..Variant.."].")
					end
					if ((dir == "up" and RightSided) or (dir == "down" and LeftSided)) then 
						return t.."HSIDE"
					elseif ((dir == "up" and LeftSided) or (dir == "down" and RightSided)) then 
						return t.."VSIDE"
					else
						return "Cannot determine side of track for point machine.",_error
					end
				end
			</Formula>
		</LuaFunction>
		
		<InsertPointObject VariantName="Uspesifisert" DisplayBlockName="NO-BN-2D-JBTSA_DRV-SPORVEKSELDRIVMASKIN-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Alstom MET" DisplayBlockName="NO-BN-2D-JBTSA_DRV-SPORVEKSELDRIVMASKIN-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Siemens Bsg9" DisplayBlockName="NO-BN-2D-JBTSA_DRV-SPORVEKSELDRIVMASKIN-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<InsertPointObject VariantName="Siemens ELS 710" DisplayBlockName="NO-BN-2D-JBTSA_DRV-SPORVEKSELDRIVMASKIN-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_DRV-SPORVEKSELDRIVMASKIN-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="true" />
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{code}}</Value>
			</Attribute>
		</Model3DDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
    SIGNAL
	SIKRINGSANLEGG
	JBTSA_SPD Sporsperredrivmaskin
	Drivmaskin for sporsperre
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_SPD Sporsperredrivmaskin"
				Layer="JBTSA_SPD" Color="ByLayer"
				Group="Signal/Sikringsanlegg"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>sporsperredrivmaskin</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />

		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<LuaExpression Name="DistanceToAlignment" >		   
			<Formula>NOBN_trk_getDistanceToAlignmentFromCantAndTrackPlaneDistance(RightSided and 1.75 or -1.75)</Formula>
		</LuaExpression>

		<LuaExpression Name="code" ><Formula>_JBTSA_SPD_code()</Formula></LuaExpression>	
		<LuaFunction Name="_JBTSA_SPD_code()" ReturnType="String"
				Description="Obtains the code for a derailer machine, derived from the derailer it is related to with 'Driver sporsperre'." >
			<Constructor>String _JBTSA_SPD_code()</Constructor>
			<Formula>
				function _JBTSA_SPD_code()
					s = "Driver sporsperre"
					r,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "UNFINISHED - Missing relation '"..s.."' to derailer object.",_warning
					else
						return r[0].code
					end
				end
			</Formula>
		</LuaFunction>
		
		<LuaExpression Name="name" ><Formula>return "Spd."..code</Formula></LuaExpression>	

		<!-- Bela machine is symmetrical (a little to one side, but same config for both sides mounting). -->
		<SetValue Key="dir" Value="both" />

		<Variants DefaultValue="BELA" >
			<Variant Name="BELA" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-SPD-SPORSPERREDRIVMASKIN-BELA" /> 
			</Variant>
		</Variants>

		<InsertPointObject VariantName="BELA" DisplayBlockName="NO-BN-2D-JBTSA_SPD-SPORSPERREDRIVMASKIN-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="1.75" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_SPD-SPORSPERREDRIVMASKIN-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="true" />
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{code}}</Value>
			</Attribute>
		</Model3DDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
    SIGNAL
	SIKRINGSANLEGG
	JBTSA_LOK Lokalstiller
	Trykknapp for lokal omlegging av sporveksel/sporsperre eller koblede sporveksler/sporsperre
=========================================================================================================-->
	<ObjectType DataType="tOrientedElement" Class="RailwayPlacedObject" Name="JBTSA_LOK Lokalstiller"
				Layer="JBTSA_LOK" Color="ByLayer"
				Group="Signal/Sikringsanlegg"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>lokalstiller</RelationSpace>

		<AttachmentCategory Name="lokalstiller" />
		<AttachTo Category="stolpe_med_fot" />

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___WAYSIDE_GENERAL_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_RAIL" />
		
		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>name</Formula></LuaExpression> 

		<LuaExpression Name="Offset3D.Z" ><Formula>Variant:match("vegg") and 1.25 or 0</Formula></LuaExpression>
		<LuaExpression Name="PoleRouting3D" ><Formula>Variant:match("vegg") and "None" or "Vertical"</Formula></LuaExpression>
	
		<Variants DefaultValue="Lokalstiller, 1 knapp/enkel veksel, på stolpe" >
			<Variant Name="Lokalstiller, 1 knapp/enkel veksel, på stolpe" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-1-KNAPP-ENKEL-VEKSEL-MED-STOLPE" />
			</Variant>
			<Variant Name="Lokalstiller, 1 knapp/enkel veksel, på vegg" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-1-KNAPP-ENKEL-VEKSEL" />
			</Variant>
			<Variant Name="Lokalstiller, 1 knapp/koblet veksel, på stolpe" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-1-KNAPP-KOBLET-VEKSEL-MED-STOLPE" />
			</Variant>
			<Variant Name="Lokalstiller, 1 knapp/koblet veksel, på vegg" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-1-KNAPP-KOBLET-VEKSEL" />
			</Variant>
			<Variant Name="Lokalstiller, 2 knapper/enkel veksel, på stolpe" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-2-KNAPPER-ENKEL-VEKSEL-MED-STOLPE" />
			</Variant>
			<Variant Name="Lokalstiller, 2 knapper/enkel veksel, på vegg" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-2-KNAPPER-ENKEL-VEKSEL" />
			</Variant>
			<Variant Name="Lokalstiller, 2 knapper/koblet veksel, på stolpe" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-2-KNAPPER-KOBLET-VEKSEL-MED-STOLPE" />
			</Variant>
			<Variant Name="Lokalstiller, 2 knapper/koblet veksel, på vegg" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-LOK-LOKALSTILLER-2-KNAPPER-KOBLET-VEKSEL" />
			</Variant>
		</Variants>

		<LuaExpression Name="code" ><Formula>_JBTSA_SPD_code()</Formula></LuaExpression>	
		<LuaFunction Name="_JBTSA_SPD_code()" ReturnType="String"
				Description="Obtains the code for a local control panel, derived from the switch or derailer it is related to with 'Omstiller sporveksel' or 'Omstiller sporsperre'." >
			<Constructor>String _JBTSA_SPD_code()</Constructor>
			<Formula>
				function _JBTSA_SPD_code()
					local s = "Omstiller sporveksel/sporsperre"
					local r,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "UNFINISHED - Missing relation '"..s.."' to switch object or derailer object.",_warning,
						_info("A local control panel derives its code property from the switch or derailer which it is related to.")
					elseif n == 1 then
						if r[0].RcType == "KO-SPV Sporveksel" then 
							local coupledSwitch,ncsw = RC__getCollectionOfRelatedObjects("Er koblet med sporveksel",r[0])
							if ncsw == 0 then
								return r[0].code
							else
								return coupledSwitch[0].code.."/"..r[0].code
							end
						elseif r[0].RcType == "JBTSA_SSP Sporsperre" then
							return r[0].code
						else
							return "ERROR - Bad RcType ["..r[0].RcType.."] for object related to Local control panel.",_error
						end
					else
						return "ERROR - More than 1 ["..n.."] object related to Local control panel.",_error
					end
				end
			</Formula>
		</LuaFunction>

		<LuaExpression Name="name" ><Formula>"Lok."..code</Formula></LuaExpression>

		<LuaExpression Name="dir" ><Formula>_JBTSA_LOK_dir()</Formula></LuaExpression>	
		<LuaFunction Name="_JBTSA_LOK_dir()" ReturnType="String"
				Description="Obtains the dir (direction) for a local control panel, derived from the switch or derailer it is related to with 'Omstiller sporveksel/sporsperre'." >
			<Constructor>String _JBTSA_LOK_dir()</Constructor>
			<Formula>
				function _JBTSA_SPD_code()
					s = "Omstiller sporveksel/sporsperre"
					r,n = RC__getCollectionOfRelatedObjects(s)
					if n == 0 then
						return "unknown"
					else
						if r[0].RcType == "JBTSA_LOK Lokalstiller" then 
							return "both" 
						else 
							return r[0].dir
						end
					end
				end
			</Formula>
		</LuaFunction>

		
		<!-- 2D symbol is circular symmetric, so no need to specify any rotation during insertion jig -->
		<InsertPointObject VariantName="Lokalstiller, 1 knapp/enkel veksel, på stolpe"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="2.4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 1 knapp/enkel veksel, på vegg"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 1 knapp/koblet veksel, på stolpe"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="2.4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 1 knapp/koblet veksel, på vegg"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 2 knapper/enkel veksel, på stolpe"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="2.4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 2 knapper/enkel veksel, på vegg"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 2 knapper/koblet veksel, på stolpe"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="2.4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>
		<InsertPointObject VariantName="Lokalstiller, 2 knapper/koblet veksel, på vegg"
				DisplayBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" 
				DefaultSnapMode="Point" SnapToAlignment="true" SnapDistance="4.0" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<SetValue Key="dir" Value="both" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_LOK-LOKALSTILLER-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation Add180DegreesIfDirIsDown="false" AddAngle="{% if dir == 'up' %}{{270.0|plus:AngularOffset}}
														{% elsif dir == 'down' %}{{90.0|plus:AngularOffset}}
														{% elsif dir == 'both' and RightSided %}{{180.0|plus:AngularOffset}}
														{% elsif dir == 'both' and LeftSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and RightSided %}{{0.0|plus:AngularOffset}}
														{% elsif dir == 'none' and LeftSided %}{{180.0|plus:AngularOffset}}
														{% else %}45.0
														{% endif %}" />	
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{code}}</Value>
			</Attribute>
		</Model3DDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

		<DockPointDefinitions>
			<SnapPoints>
				<!-- Stolpe for montasje -->
				<SnapPoint X="0" Y="0" TargetSpace="stolpe_med_fot" />
			</SnapPoints>
		</DockPointDefinitions>

		<DisplayPointDefinitions>
			<SnapPoints>
				<!-- Visuell Lok relativt til dock point (0, +/-2.5) i sporveksel, skal vises litt før SS (og spv har fire kvadranter) -->
				<SnapPoint X="-1.75" Y="0.75" />
				<SnapPoint X="-1.75" Y="-0.75" />
				<SnapPoint X="1.75" Y="0.75" />
				<SnapPoint X="1.75" Y="-0.75" />
			</SnapPoints>
		</DisplayPointDefinitions>
	</ObjectType>



<!--========================================================================================================
	SIGNAL
	ATC BALISE GROUP ETCS
=========================================================================================================-->
	<!-- Balisegruppen kan kobles til signal(er), sporveksel(ler), radioområder, RBC-områder, sikringsanleggområder,  -->
	<!-- stasjonsområder osv o.a.  -->
	<!-- Noen tilkobinger arver posisjon fra sin forelder (signal), andre ikke (sporveksel, annen balisegruppe). -->
	<!-- Lenkingsgrupper: Kobles til annen balisegruppe. -->
	<!-- Signaler og forsignaler, evt dvergsignaler, fiktive osv: Balisegruppen kobles til signalet. -->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" Name="JBTSA_ETC Balisegruppe ETCS" 
				Layer="JBTSA_ETC" Color="ByLayer"
				Group="Signal/ATC"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>balisegruppe_ETCS</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ALIGNMENT_ANNOTATION_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		
		<!-- Fiktivt objekt - ikke ISY beskrivelse -->

		<!-- TODO: Inkluder alle disse properties for å kunne generere kodetabeller automatisk -->
		<!--	
		<CustomAttribute DataType="String" Name="Retning" DisplayName="Retning" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Sign_Type" DisplayName="Sign_Type" DefaultValue="" />
		<CustomAttribute DataType="String" Name="BaliseID" DisplayName="BaliseID" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Signalbilde_1H" DisplayName="Signal_1H" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Signalbilde_1F2H" DisplayName="Signalbilde_1F2H" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Signalbilde_2F" DisplayName="Signalbilde_2F" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Kjørhastighet" DisplayName="Kjørhastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Venthastighet" DisplayName="Venthastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="P-avstand" DisplayName="P-avstand" DefaultValue="" />
		<CustomAttribute DataType="String" Name="B-avstand" DisplayName="B-avstand" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Fall" DisplayName="Fall" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Frislipphastighet" DisplayName="Frislipphastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="MotrettetType" DisplayName="MotrettetType" DefaultValue="" />
		<CustomAttribute DataType="String" Name="MotrettetHastighet" DisplayName="MotrettetHastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Togveier" DisplayName="Togveier" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Pxyz" DisplayName="Pxyz" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Axyz" DisplayName="Axyz" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Bxyz" DisplayName="Bxyz" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Cxyz" DisplayName="Cxyz" DefaultValue="" />
		-->
		<Variants DefaultValue="ETCS L2 balisegruppe" >
			<Variant Name="ETCS L2 balisegruppe" />
		</Variants>

		<LuaExpression Name="code" ><Formula>"ETCS L2 balisegruppe"</Formula></LuaExpression>
		<LuaExpression Name="name" ><Formula>code</Formula></LuaExpression>
		<LuaExpression Name="ObjectInfo" ><Formula>Variant</Formula></LuaExpression>
		<LuaExpression Name="EarthingMethod" ><Formula>"None"</Formula></LuaExpression>

		<InsertPointObject VariantName="ETCS L2 balisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ETC-BALISEGRUPPE-ETCS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ETC-BALISEGRUPPE-ETCS-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft == 'True'%}180{% else %}0{% endif %}" />
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
	SIGNAL
	ATC BALISE GROUP NSS
	(LEGACY) NATIONAL SIGNALING SYSTEM
=========================================================================================================-->
	<!-- Balisegruppen kan kobles til signal(er), sporveksel(ler), radioområder, RBC-områder, sikringsanleggområder,  -->
	<!-- stasjonsområder osv o.a.  -->
	<!-- Noen tilkobinger arver posisjon fra sin forelder (signal), andre ikke (sporveksel, annen balisegruppe). -->
	<!-- Lenkingsgrupper: Kobles til annen balisegruppe. -->
	<!-- Signaler og forsignaler, evt dvergsignaler, fiktive osv: Balisegruppen kobles til signalet. -->
	<ObjectType DataType="tMarker" Class="RailwayPlacedObject" Name="JBTSA_ATC Balisegruppe NSS" 
				Layer="JBTSA_ATC" Color="ByLayer"
				Group="Signal/ATC"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>balisegruppe</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXTATTRIBUTES___HORIZONTAL_AND_CLOSE___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___ALIGNMENT_ANNOTATION_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		
		<!-- Fiktivt objekt - ikke ISY beskrivelse -->

		<!-- TODO: Inkluder alle disse properties for å kunne generere kodetabeller automatisk -->
		<!--	
		<CustomAttribute DataType="String" Name="Retning" DisplayName="Retning" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Sign_Type" DisplayName="Sign_Type" DefaultValue="" />
		<CustomAttribute DataType="String" Name="BaliseID" DisplayName="BaliseID" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Signalbilde_1H" DisplayName="Signal_1H" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Signalbilde_1F2H" DisplayName="Signalbilde_1F2H" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Signalbilde_2F" DisplayName="Signalbilde_2F" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Kjørhastighet" DisplayName="Kjørhastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Venthastighet" DisplayName="Venthastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="P-avstand" DisplayName="P-avstand" DefaultValue="" />
		<CustomAttribute DataType="String" Name="B-avstand" DisplayName="B-avstand" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Fall" DisplayName="Fall" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Frislipphastighet" DisplayName="Frislipphastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="MotrettetType" DisplayName="MotrettetType" DefaultValue="" />
		<CustomAttribute DataType="String" Name="MotrettetHastighet" DisplayName="MotrettetHastighet" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Togveier" DisplayName="Togveier" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Pxyz" DisplayName="Pxyz" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Axyz" DisplayName="Axyz" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Bxyz" DisplayName="Bxyz" DefaultValue="" />
		<CustomAttribute DataType="String" Name="Cxyz" DisplayName="Cxyz" DefaultValue="" />
		-->
		<Variants DefaultValue="ETCS L2 balisegruppe" >
			<Variant Name="ETCS L2 balisegruppe" />
			<Variant Name="Hovedsignalbalisegruppe" />
			<Variant Name="Forsignalbalisegruppe" />
			<Variant Name="Repeterbalisegruppe" />
			<Variant Name="Sporvekselbalisegruppe" />
			<Variant Name="Hastighetsbalisegruppe" />
			<Variant Name="Lenkingsbalisegruppe" />
			<Variant Name="Signalhøyningsbalisegruppe" />
			<Variant Name="ET-balisegruppe" />
			<Variant Name="Grensebalisegruppe" />
			<Variant Name="Radioområdebalisegruppe" />
			<Variant Name="Diversebalisegruppe" />
		</Variants>

		<LuaExpression Name="code" ><Formula>NOBN_sig_getBaliseGroupId()</Formula></LuaExpression>
		<LuaExpression Name="name" ><Formula>code</Formula></LuaExpression>
		<LuaExpression Name="ObjectInfo" ><Formula>Variant</Formula></LuaExpression>
		<LuaExpression Name="EarthingMethod" ><Formula>"None"</Formula></LuaExpression>

		<!--TODO: ETCS-grupper  må trolig raffineres videre-->
		<InsertPointObject VariantName="ETCS L2 balisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<!--Hovedsignal alene og kombinertsignal (Hs+Fs) balisegruppe-->
		<InsertPointObject VariantName="Hovedsignalbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Forsignalbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Repeterbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Sporvekselbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Hastighetsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Lenkingsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Signalhøyningsbalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="ET-balisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Grensebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Radioområdebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<InsertPointObject VariantName="Diversebalisegruppe" DisplayBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}"
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="10" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance /> 
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATC-BALISEGRUPPE-NSS-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft == 'True'%}180{% else %}0{% endif %}" />
		</SymbolDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--========================================================================================================
	SIGNAL
	ATC BALISE 
	(LEGACY SYSTEM AND ETCS) TODO: SPLIT IN NSS AND ETCS
=========================================================================================================-->
	<!-- TODO Er ikke "switchable" allerede en railML-attributt? Da skal vi vel bruke den, ikke vår egen customattribute? -->
	<ObjectType DataType="tBalise" Class="RailwayPlacedObject" Name="JBTSA_ATB Balise"
				Layer="JBTSA_ATB" Color="ByLayer"
				Group="Signal/ATC"
				AttMirrorY="{% if RightSided %}true{% else %}false{% endif %}"
				>
				
		<RelationSpace>balise</RelationSpace>

		<!-- <xpp:expand select="NOBN_xxx_DEPRECATED_MACRO___TO_BE_REMOVED" /> -->
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___ANGULAROFFSET_TAG_OBJECTINFO_METADATA_VAR" />
		<xpp:expand select="NOBN_com_STD_CUSTOMATTRIBUTES___MILEAGE_INCREASES_TOWARDS_LEFT" />
		<xpp:expand select="NOBN_com_STD_TEXATTRIBUTES___VERTICAL_AND_FAR___JBTSI" />
		<xpp:expand select="NOBN_com_DISCIPLINE_JBTSI" />
		<xpp:expand select="NOBN_com_CHK_NUMBER_OF_OCP_AREAS" />
		<xpp:expand select="RC_com_SET_OCP_STATION_REFERENCE" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___TRACKBOUND_OBJECT" />
		<xpp:expand select="NOBN_com_STD_LUAEXPRESSIONS___EARTHED_TO_NONE" />
		
		<CustomAttribute DataType="Enumeration" Name="Balisetype" DefaultValue="ATC2 parallellbaliser" >
			<Values>
				<Value>ATC2 parallellbaliser</Value>
				<Value>ATC2 seriebaliser, store</Value>
				<Value>ATC2 seriebaliser, små</Value>
				<Value>Eurobaliser, store</Value>
				<Value>Eurobaliser, små</Value>
				<Value>Annen balisetype</Value>
			</Values>
		</CustomAttribute>
				   
		<CustomAttribute DataType="String" Name="TekstOver" DisplayName="Tekst over" DefaultValue="" 
			Description="Text above balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC tables 7.1 and 7.2."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false" IncludeIn3DExport="true" />
		
		<CustomAttribute DataType="String" Name="TekstUnder" DisplayName="Tekst under" DefaultValue=""
			Description="Text below  balise symbol [string] according to Bane NOR TRV 550 ch. 10 ATC table 7.11."
			ReadOnly="false" StandardValuesFromLuaFormula="false" StandardValuesExclusive="false" InvertOnAlignmentReverse="false" IncludeIn3DExport="true" />
	
		<!-- Bruke code ikke name siden baliser ikke har tekst som vises i tegningen (vanligvis) -->
		<xpp:expand select="NOBN_com_ISY_STK" />
		<LuaExpression Name="IsyPostnotat" ><Formula>code</Formula></LuaExpression> 

		<LuaExpression Name="DistanceToAlignment" >		  
			<!-- Give balises a slightly visible offset - balises will be turned in 3D so that the cable extends to the side-of-track bias. -->
			<Formula>RightSided and 0.01 or -0.01</Formula>
		</LuaExpression>

		<Variants DefaultValue="Balise fylt/fast" >
			<Variant Name="Fylt/fast" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-ATB-BALISE-STOR-FAST" />
			</Variant>
			<Variant Name="Fylt/styrt" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-ATB-BALISE-STOR-STYRT" />
			</Variant>
			<Variant Name="Tom/fast" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-ATB-BALISE-STOR-FAST" />
			</Variant>
			<Variant Name="Tom/styrt" >
				<SetValue Key="Model3DName" Value="NO-BN-3D-SA-ATB-BALISE-STOR-STYRT" />
			</Variant>
		</Variants>

		<!--Hos BN skal symbolet for første balise i gyldighetsretning være "fylt"-->
		<CustomAttribute DataType="Boolean" Name="FirstInGroup" DisplayName="Første i gruppe"
		DotLiquidExpression="
         {% if Variant == 'Fylt/fast' %}True
         {% elsif Variant == 'Fylt/styrt' %}True
         {% elsif Variant == 'Tom/fast' %}False
         {% elsif Variant == 'Tom/styrt' %}False
         {% endif %}"
		 />    

		<!--Styrte baliser skal ha kabel, og BN 2D-symbolet har en strek over seg. TODO Finnes "switchable" allerede i railML for baliseobjektet deres???-->
		<CustomAttribute DataType="Boolean" Name="Switchable" DisplayName="Styrt" 
			DotLiquidExpression="
				{% if Variant == 'Fylt/fast' %}False
				{% elsif Variant == 'Fylt/styrt' %}True
				{% elsif Variant == 'Tom/fast' %}False
				{% elsif Variant == 'Tom/styrt' %}True
				{% endif %}"
		 />

		<LuaExpression Name="Model3DName" ><Formula>NOBN_sig_getBaliseModel3DName('Large')</Formula></LuaExpression>

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToNextBalise" DisplayName="Avstand til neste balise" 
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups" />
			
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToPreviousBalise" DisplayName="Avstand til forrige balise"
			Description="
			Below 2.35 m: ERROR - Balise magnetic fields may merge - increase distance\n
			2.35-2.8 m: WARNING - Outside recommended tolerance - increase distance\n
			2.8-3.2 m: OK - The train will treat the balises as in the same group\n
			3.2-3.5 m: WARNING - Outside recommended tolerance - decrease distance\n
			3.5-10.5 m: ERROR - The train cannot determine balise group assignment\n
			10.5-11.8 m: WARNING - Outside recommended tolerance - Increase distance\n
			Above 11.8 m: OK - The train will treat the balises as belonging to different groups" />
			
		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackVertically" DisplayName="Avstand til spor i høyden"
			Description="
			&lt; 0.8 m: OK - Balise is close to a neighbouring track which we consider to be part of a switch or crossing\n
			0.8-7.0 m: ERROR - Balise may be read by a train running in a track above/under us - increase vertical track separation or move balise\n
			7.0-8.0 m: WARNING - Outside recommended tolerance - increase vertical track separation or move balise\n
			&gt; 8.0m: OK - A Train in a track above/under us will pass without reading the balise" />

		<CustomAttribute DataType="String" ReadOnly="true" Category="Model check" Name="mc_DistanceToTrackSideways" DisplayName="Avstand til nabospor"
			Description="
			Below 2 m: ERROR – Balise may be read by a train in the neighbouring track – increase distance\n
			2-2.6 m: WARNING – Allowed on condition that at least one of the group's A- and B-balise is above 2.6 m from neighbouring track (large balise) resp. 2.3 m (minibalise) – increase distance\n
			Over 2.6 m: OK – Train in neighbouring track will pass without reading the balise" />
		
		<LuaExpression Name="TekstOver" ><Formula>NOBN_sig_getBaliseTextAboveSymbol()</Formula></LuaExpression>
		<LuaExpression Name="TekstUnder" ><Formula>NOBN_sig_getBaliseTextBelowSymbol()</Formula></LuaExpression>

		<LuaExpression Name="code" ><Formula>NOBN_sig_getBaliseId()</Formula></LuaExpression>
		<LuaExpression Name="name" ><Formula>code:lower():match("unfinished") and code or ""</Formula> </LuaExpression>
		<LuaExpression Name="dir" ><Formula>NOBN_sig_getBaliseGroupDirection()</Formula></LuaExpression>
		
		<LuaExpression Name="mc_DistanceToNextBalise" IsModelCheck ="true" ><Formula>NOBN_sig_chkBaliseDistanceToNextBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToPreviousBalise" IsModelCheck ="true" ><Formula>NOBN_sig_chkBaliseDistanceToPreviousBalise()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackVertically" IsModelCheck ="true" ><Formula>NOBN_sig_chkBaliseDistanceToTrackVertically()</Formula></LuaExpression>
		<LuaExpression Name="mc_DistanceToTrackSideways" IsModelCheck ="true" ><Formula>NOBN_sig_chkBaliseDistanceToTrackSideways()</Formula></LuaExpression>
		<LuaExpression Name="SymbolFrame" ><Formula>NOBN__setSymbolFrame()</Formula></LuaExpression>
			
		<!--TODO Fjerne oppførsel med at balisespissen peker ned (i forhold til current UCS y-akse) ved innsetting, den skal ALLTID peke opp langs UCS-Y -->
		<!--cosisnegative: true hvis kvadrant I eller IV (høyre side av enhetssirkelen)-->
		<InsertPointObject VariantName="Fylt/fast" DisplayName="Balise fylt/fast" DisplayBlockName="NO-BN-2D-JBTSA_ATB-BALISE-FYLT-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Fylt/styrt" DisplayName="Balise fylt/styrt" DisplayBlockName="NO-BN-2D-JBTSA_ATB-BALISE-FYLT-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Tom/fast" DisplayName="Balise tom/fast" DisplayBlockName="NO-BN-2D-JBTSA_ATB-BALISE-TOM-FAST-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>
		
		<InsertPointObject VariantName="Tom/styrt" DisplayName="Balise tom/styrt" DisplayBlockName="NO-BN-2D-JBTSA_ATB-BALISE-TOM-STYRT-{{SymbolMode}}" 
				DefaultSnapMode="Alignment" SnapToAlignment="true" SnapDistance="4e-4" >
			<OwnAlignmentTargetSpace>spor</OwnAlignmentTargetSpace>
			<JigSymbolAppearance RotateWithUcs="true" />
			<SetValue Key="MileageIncreasesTowardsLeft" Value="{{alignmentRotation | minus:ucsRotation | cosisnegative}}" />
		</InsertPointObject>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATB-BALISE-TOM-FAST-{{SymbolMode}}" AllowSymbolMove="true" >
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft == 'True'%}180{% else %}0{% endif %}" />
			<BlockNameFormat JoinBy="-" >
				NO-BN-2D-JBTSA_ATB-BALISE
				{% if Variant == 'Fylt/fast'or Variant == 'Fylt/styrt' %}FYLT
				{% else %}TOM
				{% endif %}
				{% if Variant == 'Fylt/styrt' or Variant == 'Tom/styrt' %}STYRT
				{% else %}FAST
				{% endif %}
				{{SymbolMode}}
			</BlockNameFormat>
			<SymbolAttribute Tag="TEKSTOVER" >
				<Value>{{TekstOver}}</Value>
			</SymbolAttribute>
			<SymbolAttribute Tag="TEKSTUNDER" >
				<Value>{{TekstUnder}}</Value>
			</SymbolAttribute>
		</SymbolDefinition>

		<!-- Metric info -->
		<SymbolDefinition DefaultBlockName="NO-BN-2D-JBTSA_ATB-BALISE-TOM-FAST-Metric" AllowSymbolMove="false" >
			<!--Note: cosisnegative (RC built-in filter for DotLiquid) returns 'True' with an uppercase T-->
			<Rotation AddAngle="{% if MileageIncreasesTowardsLeft == 'True'%}180{% else %}0{% endif %}" />
			<BlockNameFormat JoinBy="-" >
				NO-BN-2D-JBTSA_ATB-BALISE
				{% if Variant == 'Fylt/fast'or Variant == 'Fylt/styrt' %}FYLT
				{% else %}TOM
				{% endif %}
				{% if Variant == 'Fylt/styrt' or Variant == 'Tom/styrt' %}STYRT
				{% else %}FAST
				{% endif %}
				Metric
			</BlockNameFormat>
		</SymbolDefinition>

		<Model3DDefinition>
			<Attribute Tag="T01" >
				<Value>{{code}}</Value>
			</Attribute>
		</Model3DDefinition>

		<SymbolDefinition DefaultBlockName="NO-BN-2D-##RC_INNSETTINGSPUNKT-Schematic" />

	</ObjectType>



<!--=======================================================================================================
	SIGNAL
	FORRIGLING
	Default options for eksport av forriglingstabeller
========================================================================================================-->
	<DefaultInterlockingExportOptions>
		<TrainRoutesStartPointFilter>if (RcType == "SA-SIG Signal" and Hovedsignal == 'Hs2' or Hovedsignal == 'Hs3') then
	return NOBN_sig_getSignalShortName()
elseif RcType == "SA-SIG ERTMS" then
	return NOBN_sig_getSignalShortName()
end</TrainRoutesStartPointFilter>
		<TrainRoutesEndPointFilter>if ((RcType == "SA-SIG Signal" and (Hovedsignal == 'Hs1'or Hovedsignal == 'Hs2' or Hovedsignal == 'Hs3'))
	or (RcType == "SA-SIG Fiktivt punkt" and Variant == "Fiktivt sluttpunkt for togvei")
	or (RcType == "SA-SIG Togvei slutt"))
then
	return NOBN_sig_getSignalShortName()
elseif RcType == "SA-SIG ERTMS" then
	return NOBN_sig_getSignalShortName()
end</TrainRoutesEndPointFilter>
		<ShuntingRoutesStartPointFilter>if (RcType == "SA-SIG Signal" and Dvergsignal == "Ja") then return NOBN_sig_getSignalNumber() end</ShuntingRoutesStartPointFilter>
		<ShuntingRoutesEndPointFilter>if (RcType == "SA-SIG Signal" and Dvergsignal == "Ja") then 
	return NOBN_sig_getSignalNumber()
elseif ((RcType == "SA-SIG Fiktivt punkt" and Variant == "Fiktivt sluttpunkt for togvei") or (RcType == "SA-SIG Togvei slutt")) then

	return code
end</ShuntingRoutesEndPointFilter>
		<ViaPointFilter>if (RcType == "SA-SIG Fiktivt punkt" and Variant == "Viapunkt for betjeningsanlegg") then
    return "(v"..code..")"
end</ViaPointFilter>
		<ExtendedTrainRoutesExcludedStartPointFilter>Function == "blocking"</ExtendedTrainRoutesExcludedStartPointFilter>
		<ExtendedRoutePartFormatScript>base = StartName .. "-" .. EndName
if ViaPoints.Count > 0 then
    via = ViaPoints[0].Value
    for i=1, ViaPoints.Count-1 do
      via = via .. "-" .. ViaPoints[i].Value
    end
    return base .. " via " .. via
else
    return base
end</ExtendedRoutePartFormatScript>
		<SwitchNameScript>dir = (position == "left") and "V" or "H"
return switchObj.code .. dir</SwitchNameScript>
	</DefaultInterlockingExportOptions>
	
	
	
<!--========================================================================================================
    End of file 
=========================================================================================================-->
</xpp:bloc>
